<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- Cache Busting: Force browsers to always fetch latest version -->
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">

    <!-- Version: 3.0.0 - Build: 2025-01-14 -->

    <!-- Material Design 3 - Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&family=Roboto+Mono&display=swap" rel="stylesheet">

    <title>Data Validation Config Builder</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            /* Clarity-Focused Theme - Improved Contrast & Readability */
            --md-sys-color-primary: #60A5FA;
            --md-sys-color-on-primary: #001F3F;
            --md-sys-color-primary-container: #1E3A5F;
            --md-sys-color-on-primary-container: #E0F2FE;

            --md-sys-color-secondary: #94A3B8;
            --md-sys-color-on-secondary: #1E293B;
            --md-sys-color-secondary-container: #2D3748;
            --md-sys-color-on-secondary-container: #F1F5F9;

            --md-sys-color-tertiary: #D6BBE4;
            --md-sys-color-on-tertiary: #3B2948;
            --md-sys-color-tertiary-container: #523F5F;
            --md-sys-color-on-tertiary-container: #F3DBFF;

            --md-sys-color-error: #FFB4AB;
            --md-sys-color-on-error: #690005;
            --md-sys-color-error-container: #93000A;
            --md-sys-color-on-error-container: #FFDAD6;

            --md-sys-color-surface: #0F172A;
            --md-sys-color-on-surface: #F8FAFC;
            --md-sys-color-surface-variant: #334155;
            --md-sys-color-on-surface-variant: #E2E8F0;

            --md-sys-color-outline: #64748B;
            --md-sys-color-outline-variant: #475569;

            --md-sys-color-surface-container-lowest: #020617;
            --md-sys-color-surface-container-low: #0F172A;
            --md-sys-color-surface-container: #1E293B;
            --md-sys-color-surface-container-high: #334155;
            --md-sys-color-surface-container-highest: #475569;

            /* Validation Type Colors - High Clarity */
            --color-file: #60A5FA;
            --color-schema: #A78BFA;
            --color-field: #34D399;
            --color-record: #FBBF24;
            --color-cross-file: #F472B6;
            --color-statistical: #2DD4BF;

            /* Material Design 3 - Elevation */
            --md-sys-elevation-0: none;
            --md-sys-elevation-1: 0px 1px 2px 0px rgba(0, 0, 0, 0.3), 0px 1px 3px 1px rgba(0, 0, 0, 0.15);
            --md-sys-elevation-2: 0px 1px 2px 0px rgba(0, 0, 0, 0.3), 0px 2px 6px 2px rgba(0, 0, 0, 0.15);
            --md-sys-elevation-3: 0px 4px 8px 3px rgba(0, 0, 0, 0.15), 0px 1px 3px 0px rgba(0, 0, 0, 0.3);
            --md-sys-elevation-4: 0px 6px 10px 4px rgba(0, 0, 0, 0.15), 0px 2px 3px 0px rgba(0, 0, 0, 0.3);
            --md-sys-elevation-5: 0px 8px 12px 6px rgba(0, 0, 0, 0.15), 0px 4px 4px 0px rgba(0, 0, 0, 0.3);

            /* Material Design 3 - State Layers */
            --md-sys-state-hover-opacity: 0.08;
            --md-sys-state-focus-opacity: 0.12;
            --md-sys-state-pressed-opacity: 0.12;

            /* Material Design 3 - Shape (Rounded Corners) */
            --md-sys-shape-corner-none: 0px;
            --md-sys-shape-corner-extra-small: 4px;
            --md-sys-shape-corner-small: 8px;
            --md-sys-shape-corner-medium: 12px;
            --md-sys-shape-corner-large: 16px;
            --md-sys-shape-corner-extra-large: 28px;
            --md-sys-shape-corner-full: 9999px;

            /* Transitions (Material Design 3 Motion) */
            --md-sys-motion-easing-standard: cubic-bezier(0.2, 0, 0, 1);
            --md-sys-motion-easing-emphasized: cubic-bezier(0.2, 0, 0, 1);
            --md-sys-motion-duration-short: 200ms;
            --md-sys-motion-duration-medium: 300ms;
            --md-sys-motion-duration-long: 400ms;

            /* Material Design 3 - Typography Scale */
            --md-sys-typescale-display-large-font: Roboto;
            --md-sys-typescale-display-large-size: 57px;
            --md-sys-typescale-display-large-weight: 400;
            --md-sys-typescale-display-large-line-height: 64px;

            --md-sys-typescale-headline-large-font: Roboto;
            --md-sys-typescale-headline-large-size: 32px;
            --md-sys-typescale-headline-large-weight: 400;
            --md-sys-typescale-headline-large-line-height: 40px;

            --md-sys-typescale-headline-medium-font: Roboto;
            --md-sys-typescale-headline-medium-size: 28px;
            --md-sys-typescale-headline-medium-weight: 400;
            --md-sys-typescale-headline-medium-line-height: 36px;

            --md-sys-typescale-headline-small-font: Roboto;
            --md-sys-typescale-headline-small-size: 24px;
            --md-sys-typescale-headline-small-weight: 400;
            --md-sys-typescale-headline-small-line-height: 32px;

            --md-sys-typescale-title-large-font: Roboto;
            --md-sys-typescale-title-large-size: 22px;
            --md-sys-typescale-title-large-weight: 400;
            --md-sys-typescale-title-large-line-height: 28px;

            --md-sys-typescale-title-medium-font: Roboto;
            --md-sys-typescale-title-medium-size: 16px;
            --md-sys-typescale-title-medium-weight: 500;
            --md-sys-typescale-title-medium-line-height: 24px;

            --md-sys-typescale-title-small-font: Roboto;
            --md-sys-typescale-title-small-size: 14px;
            --md-sys-typescale-title-small-weight: 500;
            --md-sys-typescale-title-small-line-height: 20px;

            --md-sys-typescale-body-large-font: Roboto;
            --md-sys-typescale-body-large-size: 16px;
            --md-sys-typescale-body-large-weight: 400;
            --md-sys-typescale-body-large-line-height: 24px;

            --md-sys-typescale-body-medium-font: Roboto;
            --md-sys-typescale-body-medium-size: 14px;
            --md-sys-typescale-body-medium-weight: 400;
            --md-sys-typescale-body-medium-line-height: 20px;

            --md-sys-typescale-body-small-font: Roboto;
            --md-sys-typescale-body-small-size: 12px;
            --md-sys-typescale-body-small-weight: 400;
            --md-sys-typescale-body-small-line-height: 16px;

            --md-sys-typescale-label-large-font: Roboto;
            --md-sys-typescale-label-large-size: 14px;
            --md-sys-typescale-label-large-weight: 500;
            --md-sys-typescale-label-large-line-height: 20px;

            --md-sys-typescale-label-medium-font: Roboto;
            --md-sys-typescale-label-medium-size: 12px;
            --md-sys-typescale-label-medium-weight: 500;
            --md-sys-typescale-label-medium-line-height: 16px;

            --md-sys-typescale-label-small-font: Roboto;
            --md-sys-typescale-label-small-size: 11px;
            --md-sys-typescale-label-small-weight: 500;
            --md-sys-typescale-label-small-line-height: 16px;

            /* Legacy compatibility mappings */
            --bg-primary: var(--md-sys-color-surface);
            --bg-secondary: var(--md-sys-color-surface-container);
            --bg-tertiary: var(--md-sys-color-surface-container-high);
            --bg-elevated: var(--md-sys-color-surface-container-highest);
            --border: var(--md-sys-color-outline-variant);
            --border-light: var(--md-sys-color-outline);
            --text-primary: var(--md-sys-color-on-surface);
            --text-secondary: var(--md-sys-color-on-surface-variant);
            --text-muted: var(--md-sys-color-outline);
            --severity-error: var(--md-sys-color-error);
            --severity-warning: var(--color-record);
            --severity-info: var(--md-sys-color-primary);
            --shadow-sm: var(--md-sys-elevation-1);
            --shadow-md: var(--md-sys-elevation-2);
            --shadow-lg: var(--md-sys-elevation-3);
            --transition-fast: var(--md-sys-motion-duration-short) var(--md-sys-motion-easing-standard);
            --transition-base: var(--md-sys-motion-duration-medium) var(--md-sys-motion-easing-standard);
        }

        body {
            font-family: var(--md-sys-typescale-body-large-font), -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            font-size: 15px;
            font-weight: 400;
            line-height: 1.6;
            background: var(--md-sys-color-surface);
            color: var(--md-sys-color-on-surface);
            overflow: hidden;
            height: 100vh;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        /* Main Layout */
        .app-container {
            display: flex;
            height: 100vh;
            overflow: hidden;
        }

        /* ==================== SIDEBAR ==================== */
        .sidebar {
            width: 280px;
            background: var(--bg-secondary);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            transition: width var(--transition-base);
            overflow: hidden;
        }

        .sidebar.collapsed {
            width: 60px;
        }

        .sidebar-header {
            padding: 20px 18px;
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 600;
            font-size: 16px;
            color: var(--text-primary);
            white-space: nowrap;
            overflow: hidden;
        }

        .logo-icon {
            font-size: 20px;
            flex-shrink: 0;
        }

        .collapse-btn {
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            color: var(--text-secondary);
            width: 28px;
            height: 28px;
            border-radius: 6px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all var(--transition-fast);
            flex-shrink: 0;
        }

        .collapse-btn:hover {
            background: var(--bg-elevated);
            color: var(--text-primary);
        }

        .search-box {
            padding: 12px 16px;
            border-bottom: 1px solid var(--border);
        }

        .search-input {
            width: 100%;
            padding: 8px 12px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: 6px;
            color: var(--text-primary);
            font-size: 14px;
            transition: all var(--transition-fast);
        }

        .search-input:focus {
            outline: none;
            border-color: var(--color-field);
            background: var(--bg-primary);
        }

        .search-input::placeholder {
            color: var(--text-muted);
        }

        .sidebar-nav {
            flex: 1;
            overflow-y: auto;
            padding: 12px 8px;
        }

        .nav-section {
            margin-bottom: 8px;
        }

        .nav-header {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            color: var(--text-muted);
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .nav-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 14px;
            margin: 3px 0;
            border-radius: 10px;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all var(--transition-fast);
            position: relative;
            font-size: 14px;
        }

        .nav-item:hover {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }

        .nav-item.active {
            background: var(--bg-tertiary);
            color: var(--text-primary);
            font-weight: 500;
        }

        .nav-item.active::before {
            content: '';
            position: absolute;
            left: 0;
            top: 50%;
            transform: translateY(-50%);
            width: 3px;
            height: 20px;
            background: var(--color-field);
            border-radius: 0 2px 2px 0;
        }

        .nav-icon {
            font-size: 18px;
            flex-shrink: 0;
        }

        .nav-label {
            flex: 1;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .nav-badge {
            font-size: 11px;
            padding: 2px 6px;
            border-radius: 10px;
            background: var(--bg-elevated);
            color: var(--text-primary);
            font-weight: 600;
            flex-shrink: 0;
        }

        .nav-badge.error {
            background: var(--severity-error);
            color: white;
        }

        .nav-badge.warning {
            background: var(--severity-warning);
            color: white;
        }

        .sidebar-footer {
            padding: 16px;
            border-top: 1px solid var(--border);
            background: var(--bg-secondary);
            flex-shrink: 0;
            margin-top: auto;
        }

        /* ==================== WORKSPACE ==================== */
        .workspace {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            background: var(--bg-primary);
        }

        .workspace-header {
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border);
            padding: 16px 24px;
        }

        .breadcrumbs {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 13px;
            color: var(--text-muted);
            margin-bottom: 12px;
        }

        .breadcrumb-separator {
            color: var(--text-muted);
        }

        .breadcrumb {
            cursor: pointer;
            transition: color var(--transition-fast);
        }

        .breadcrumb:hover {
            color: var(--text-primary);
        }

        .breadcrumb.active {
            color: var(--text-primary);
            font-weight: 500;
        }

        .page-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 16px;
        }

        .title-section {
            display: flex;
            align-items: center;
            gap: 12px;
            flex: 1;
        }

        .page-title {
            font-size: 28px;
            font-weight: 600;
            color: var(--text-primary);
            letter-spacing: -0.02em;
        }

        .status-badge {
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
            background: var(--bg-tertiary);
            color: var(--text-secondary);
        }

        .status-badge.success {
            background: rgba(16, 185, 129, 0.15);
            color: var(--color-field);
        }

        .header-actions {
            display: flex;
            gap: 8px;
        }

        .workspace-content {
            flex: 1;
            overflow-y: auto;
            padding: 32px;
        }

        /* ==================== PREVIEW PANEL ==================== */
        .preview-panel {
            width: 400px;
            background: var(--bg-secondary);
            border-left: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            transition: width var(--transition-base);
        }

        .preview-panel.collapsed {
            width: 0;
            border: none;
        }

        .preview-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 16px;
            border-bottom: 1px solid var(--border);
        }

        .preview-title {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .preview-body {
            flex: 1;
            overflow: auto;
            padding: 16px;
        }

        .yaml-code {
            font-family: 'Monaco', 'Menlo', 'Consolas', monospace;
            font-size: 13px;
            line-height: 1.6;
            white-space: pre;
            color: var(--text-secondary);
        }

        .preview-footer {
            padding: 16px;
            border-top: 1px solid var(--border);
            display: flex;
            gap: 8px;
        }

        /* ==================== BUTTONS (Material Design 3) ==================== */
        .btn {
            position: relative;
            padding: 11px 24px;
            border-radius: var(--md-sys-shape-corner-full);
            font-family: var(--md-sys-typescale-label-large-font);
            font-size: 14px;
            font-weight: 500;
            line-height: 1.4;
            cursor: pointer;
            border: none;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: all var(--md-sys-motion-duration-short) var(--md-sys-motion-easing-standard);
            white-space: nowrap;
            overflow: hidden;
            text-transform: none;
            letter-spacing: 0.02em;
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: currentColor;
            opacity: 0;
            transition: opacity var(--md-sys-motion-duration-short) var(--md-sys-motion-easing-standard);
        }

        .btn:hover::before {
            opacity: var(--md-sys-state-hover-opacity);
        }

        .btn:focus::before {
            opacity: var(--md-sys-state-focus-opacity);
        }

        .btn:active::before {
            opacity: var(--md-sys-state-pressed-opacity);
        }

        /* Filled Button (Primary) */
        .btn-primary {
            background: var(--md-sys-color-primary-container);
            color: var(--md-sys-color-on-primary-container);
            box-shadow: var(--md-sys-elevation-0);
        }

        .btn-primary:hover {
            box-shadow: var(--md-sys-elevation-1);
        }

        /* Tonal Button (Secondary) */
        .btn-secondary {
            background: var(--md-sys-color-secondary-container);
            color: var(--md-sys-color-on-secondary-container);
            box-shadow: var(--md-sys-elevation-0);
        }

        .btn-secondary:hover {
            box-shadow: var(--md-sys-elevation-1);
        }

        /* Error Button (Danger) */
        .btn-danger {
            background: var(--md-sys-color-error-container);
            color: var(--md-sys-color-on-error-container);
            box-shadow: var(--md-sys-elevation-0);
        }

        .btn-danger:hover {
            box-shadow: var(--md-sys-elevation-1);
        }

        .btn-icon {
            padding: 8px;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .btn-full {
            width: 100%;
            justify-content: center;
        }

        /* ==================== CARDS (Material Design 3) ==================== */
        .validation-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 16px;
            margin-bottom: 16px;
        }

        .validation-card {
            background: var(--md-sys-color-surface-container);
            border: 1.5px solid var(--md-sys-color-outline-variant);
            border-radius: 14px;
            padding: 20px;
            transition: all var(--md-sys-motion-duration-short) var(--md-sys-motion-easing-standard);
            position: relative;
            overflow: hidden;
            box-shadow: var(--md-sys-elevation-1);
        }

        .validation-card:hover {
            background: var(--md-sys-color-surface-container-high);
            border-color: var(--md-sys-color-outline);
            box-shadow: var(--md-sys-elevation-2);
            transform: translateY(-1px);
        }

        .validation-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 4px;
            height: 100%;
            background: var(--card-color, var(--color-field));
            border-radius: var(--md-sys-shape-corner-small) 0 0 var(--md-sys-shape-corner-small);
        }

        .validation-card.file-check {
            --card-color: var(--color-file);
        }

        .validation-card.schema-check {
            --card-color: var(--color-schema);
        }

        .validation-card.field-check {
            --card-color: var(--color-field);
        }

        .validation-card.record-check {
            --card-color: var(--color-record);
        }

        .validation-card.cross-file-check {
            --card-color: var(--color-cross-file);
        }

        .validation-card.statistical-check {
            --card-color: var(--color-statistical);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 12px;
            gap: 12px;
        }

        .validation-info {
            display: flex;
            align-items: center;
            gap: 10px;
            flex: 1;
        }

        .validation-icon {
            font-size: 20px;
        }

        .validation-name {
            font-weight: 600;
            color: var(--text-primary);
            font-size: 15px;
        }

        .card-actions {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .severity-label {
            font-size: 11px;
            padding: 4px 8px;
            border-radius: 10px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.02em;
        }

        .severity-label.error {
            background: rgba(239, 68, 68, 0.15);
            color: var(--severity-error);
        }

        .severity-label.warning {
            background: rgba(245, 158, 11, 0.15);
            color: var(--severity-warning);
        }

        .card-body {
            color: var(--text-secondary);
            font-size: 13px;
            line-height: 1.5;
        }

        .add-card {
            background: var(--bg-secondary);
            border: 2px dashed var(--border);
            border-radius: 12px;
            padding: 32px;
            text-align: center;
            cursor: pointer;
            transition: all var(--transition-fast);
            color: var(--text-muted);
        }

        .add-card:hover {
            border-color: var(--color-field);
            color: var(--color-field);
            background: rgba(16, 185, 129, 0.05);
        }

        .add-card-icon {
            font-size: 32px;
            margin-bottom: 8px;
        }

        .add-card-text {
            font-size: 14px;
            font-weight: 500;
        }

        /* ==================== RESPONSIVE ==================== */
        @media (max-width: 1024px) {
            .preview-panel {
                position: fixed;
                right: 0;
                top: 0;
                height: 100vh;
                z-index: 1000;
                box-shadow: var(--shadow-lg);
            }

            .preview-panel.collapsed {
                transform: translateX(100%);
            }
        }

        @media (max-width: 768px) {
            .sidebar {
                position: fixed;
                left: 0;
                top: 0;
                height: 100vh;
                z-index: 900;
                transform: translateX(-100%);
                transition: transform var(--transition-base);
            }

            .sidebar.mobile-visible {
                transform: translateX(0);
                box-shadow: var(--shadow-lg);
            }

            .mobile-menu-btn {
                display: flex !important;
            }

            .workspace-header {
                padding: 12px 16px;
            }

            .page-header {
                flex-wrap: wrap;
            }

            .page-title {
                font-size: 20px;
            }

            .workspace-content {
                padding: 16px;
                padding-bottom: 80px;
            }

            .validation-grid {
                grid-template-columns: 1fr;
            }

            /* Hide download button text on mobile, keep icon */
            .header-actions .btn-primary span:not(.icon) {
                display: none;
            }

            .header-actions .btn-primary {
                padding: 8px 12px;
            }
        }

        /* Mobile backdrop */
        .mobile-backdrop {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 850;
        }

        .mobile-backdrop.show {
            display: block;
        }

        .mobile-menu-btn {
            display: none;
            align-items: center;
            justify-content: center;
            width: 36px;
            height: 36px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all var(--transition-fast);
        }

        .mobile-menu-btn:hover {
            background: var(--bg-elevated);
            color: var(--text-primary);
        }

        /* ==================== MODAL ==================== */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1100;
            align-items: center;
            justify-content: center;
            padding: 20px;
            opacity: 0;
            transition: opacity 0.2s ease-in-out;
        }

        .modal.show {
            display: flex;
            opacity: 1;
        }

        .modal-content {
            background: var(--bg-secondary);
            border-radius: 20px;
            max-width: 950px;
            width: 100%;
            max-height: 90vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            box-shadow: var(--md-sys-elevation-5);
            border: 1.5px solid var(--border);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 24px;
            border-bottom: 1px solid var(--border);
        }

        .modal-title {
            font-size: 22px;
            font-weight: 600;
            color: var(--text-primary);
            letter-spacing: -0.01em;
        }

        .modal-body {
            flex: 1;
            overflow-y: auto;
            padding: 24px;
        }

        .modal-footer {
            padding: 16px 24px;
            border-top: 1px solid var(--border);
            display: flex;
            justify-content: flex-end;
            gap: 12px;
        }

        .validation-categories {
            display: grid;
            gap: 16px;
        }

        .category-section {
            background: var(--bg-tertiary);
            border-radius: 12px;
            padding: 16px;
            border: 1px solid var(--border);
        }

        .category-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 12px;
            color: var(--text-primary);
            font-weight: 600;
            font-size: 15px;
        }

        .validation-types-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
            gap: 8px;
        }

        .validation-type-option {
            background: var(--bg-primary);
            border: 2px solid var(--border);
            border-radius: 10px;
            padding: 14px 16px;
            cursor: pointer;
            transition: all var(--transition-fast);
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .validation-type-option:hover {
            border-color: var(--color-field);
            background: var(--bg-secondary);
        }

        .validation-type-option.selected {
            border-color: var(--color-field);
            background: rgba(16, 185, 129, 0.1);
        }

        .validation-type-name {
            font-weight: 500;
            color: var(--text-primary);
            font-size: 14px;
        }

        .validation-type-desc {
            font-size: 12px;
            color: var(--text-muted);
            line-height: 1.4;
        }

        .severity-selector {
            margin-top: 16px;
            padding: 16px;
            background: var(--bg-tertiary);
            border-radius: 8px;
            border: 1px solid var(--border);
        }

        .severity-selector label {
            display: block;
            margin-bottom: 8px;
            color: var(--text-primary);
            font-weight: 500;
            font-size: 14px;
        }

        .severity-options {
            display: flex;
            gap: 8px;
        }

        .severity-option {
            flex: 1;
            padding: 10px;
            background: var(--bg-primary);
            border: 2px solid var(--border);
            border-radius: 8px;
            text-align: center;
            cursor: pointer;
            font-weight: 500;
            font-size: 13px;
            transition: all var(--transition-fast);
        }

        .severity-option:hover {
            border-color: var(--border-light);
        }

        .severity-option.selected {
            border-color: var(--color-field);
            background: rgba(16, 185, 129, 0.1);
            color: var(--color-field);
        }

        .severity-option.error.selected {
            border-color: var(--severity-error);
            background: rgba(239, 68, 68, 0.1);
            color: var(--severity-error);
        }

        .severity-option.warning.selected {
            border-color: var(--severity-warning);
            background: rgba(245, 158, 11, 0.1);
            color: var(--severity-warning);
        }

        /* Severity button for modal */
        .severity-btn {
            flex: 1;
            padding: 10px 16px;
            background: var(--bg-primary);
            border: 2px solid var(--border);
            border-radius: 8px;
            text-align: center;
            cursor: pointer;
            font-weight: 500;
            font-size: 13px;
            transition: all var(--transition-fast);
            color: var(--text-secondary);
        }

        .severity-btn:hover {
            border-color: var(--border-light);
            color: var(--text-primary);
        }

        .severity-btn.active {
            border-width: 2px;
            font-weight: 600;
        }

        /* ==================== UTILITY CLASSES ==================== */
        .hidden {
            display: none !important;
        }

        .icon {
            font-size: 16px;
            filter: grayscale(0);
            opacity: 1;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }

        /* Ensure icons inherit proper colors in buttons */
        .btn .icon,
        .btn span {
            position: relative;
            z-index: 1;
            color: inherit;
        }

        /* Improve icon visibility on different button types */
        .btn-primary .icon,
        .btn-primary span {
            color: var(--md-sys-color-on-primary-container);
        }

        .btn-secondary .icon,
        .btn-secondary span {
            color: var(--md-sys-color-on-secondary-container);
        }

        .btn-danger .icon,
        .btn-danger span {
            color: var(--md-sys-color-on-error-container);
        }

        /* ==================== ANIMATIONS ==================== */
        @keyframes slideInUp {
            from {
                transform: translateY(100px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        @keyframes slideOutDown {
            from {
                transform: translateY(0);
                opacity: 1;
            }
            to {
                transform: translateY(100px);
                opacity: 0;
            }
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes fadeOut {
            from { opacity: 1; }
            to { opacity: 0; }
        }

        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes slideOut {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(400px);
                opacity: 0;
            }
        }

        @keyframes highlight-pulse {
            0% {
                box-shadow: 0 0 0 2px var(--md-sys-color-primary);
            }
            50% {
                box-shadow: 0 0 0 4px var(--md-sys-color-primary), 0 0 20px var(--md-sys-color-primary);
            }
            100% {
                box-shadow: 0 0 0 2px var(--md-sys-color-primary);
            }
        }
    </style>
</head>
<body>
    <!-- Mobile backdrop -->
    <div class="mobile-backdrop" id="mobileBackdrop" onclick="toggleMobileSidebar()"></div>

    <!-- Add Validation Modal -->
    <div class="modal" id="validationModal" onclick="if(event.target === this) closeValidationModal()">
        <div class="modal-content">
            <div class="modal-header">
                <div>
                    <h2 class="modal-title">Add Validation</h2>
                    <p style="margin: 4px 0 0 0; font-size: 13px; color: var(--text-muted); font-weight: normal;">
                        Select one or more validation types below (click to toggle selection)
                    </p>
                </div>
                <button class="btn btn-secondary btn-icon" onclick="closeValidationModal()">
                    <span>‚úï</span>
                </button>
            </div>
            <div class="modal-body">
                <!-- Validation types list (dynamically populated) -->
                <div id="validationTypesList" style="margin-bottom: 20px;">
                    <!-- Categories and validation types will be rendered here -->
                </div>

                <!-- Severity selector -->
                <div class="severity-selector">
                    <label style="display: block; margin-bottom: 8px; font-weight: 600; color: var(--text-primary);">
                        Severity Level
                    </label>
                    <small style="display: block; margin-bottom: 12px; color: var(--text-muted); font-size: 13px; line-height: 1.5;">
                        <strong>ERROR:</strong> Stops validation immediately when triggered (critical checks) ‚Ä¢ <strong>WARNING:</strong> Logs issue but continues processing (monitoring/quality metrics)
                    </small>
                    <div id="severitySelector" style="display: flex; gap: 8px;">
                        <!-- Severity buttons will be rendered here -->
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeValidationModal()">
                    Cancel
                </button>
                <button class="btn btn-primary" onclick="confirmAddValidation()" disabled>
                    Add Validation
                </button>
            </div>
        </div>
    </div>

    <!-- Template Selection Modal -->
    <div class="modal" id="templateModal" onclick="if(event.target === this) closeTemplateModal()">
        <div class="modal-content">
            <div class="modal-header">
                <div>
                    <h2 class="modal-title">Use Validation Template</h2>
                    <p style="margin: 4px 0 0 0; font-size: 13px; color: var(--text-muted); font-weight: normal;">
                        Quickly add standard groupings of validation checks
                    </p>
                </div>
                <button class="btn btn-secondary btn-icon" onclick="closeTemplateModal()">
                    <span>‚úï</span>
                </button>
            </div>
            <div class="modal-body">
                <div style="display: grid; gap: 16px;">
                    <!-- Essential File Checks Template -->
                    <div class="validation-type-option" onclick="applyTemplate('essential')" style="cursor: pointer; padding: 20px;">
                        <div style="display: flex; align-items: flex-start; gap: 12px; margin-bottom: 12px;">
                            <span style="font-size: 24px;">üõ°Ô∏è</span>
                            <div>
                                <div style="font-weight: 600; color: var(--text-primary); font-size: 16px; margin-bottom: 4px;">
                                    Essential File Checks
                                </div>
                                <div style="font-size: 13px; color: var(--text-muted); line-height: 1.5;">
                                    Minimum set of validations every file should have. Catches empty files and unexpected row counts.
                                </div>
                            </div>
                        </div>
                        <div style="padding: 12px; background: var(--bg-tertiary); border-radius: 8px; border-left: 3px solid var(--color-file);">
                            <div style="font-size: 12px; color: var(--text-secondary); font-weight: 500; margin-bottom: 6px;">Includes:</div>
                            <ul style="margin: 0; padding-left: 20px; font-size: 12px; color: var(--text-muted); line-height: 1.6;">
                                <li>EmptyFileCheck - Prevents processing files with no data</li>
                                <li>RowCountRangeCheck - Ensures expected data volume</li>
                            </ul>
                        </div>
                    </div>

                    <!-- Data Quality Basics Template -->
                    <div class="validation-type-option" onclick="applyTemplate('quality')" style="cursor: pointer; padding: 20px;">
                        <div style="display: flex; align-items: flex-start; gap: 12px; margin-bottom: 12px;">
                            <span style="font-size: 24px;">‚úÖ</span>
                            <div>
                                <div style="font-weight: 600; color: var(--text-primary); font-size: 16px; margin-bottom: 4px;">
                                    Data Quality Basics
                                </div>
                                <div style="font-size: 13px; color: var(--text-muted); line-height: 1.5;">
                                    Common field-level and record-level checks for data integrity and cleanliness.
                                </div>
                            </div>
                        </div>
                        <div style="padding: 12px; background: var(--bg-tertiary); border-radius: 8px; border-left: 3px solid var(--color-field);">
                            <div style="font-size: 12px; color: var(--text-secondary); font-weight: 500; margin-bottom: 6px;">Includes:</div>
                            <ul style="margin: 0; padding-left: 20px; font-size: 12px; color: var(--text-muted); line-height: 1.6;">
                                <li>MandatoryFieldCheck - Ensures critical fields are populated</li>
                                <li>UniqueKeyCheck - Validates primary key uniqueness</li>
                                <li>DuplicateRowCheck - Detects duplicate records</li>
                                <li>BlankRecordCheck - Finds completely empty rows</li>
                            </ul>
                        </div>
                    </div>

                    <!-- Schema Validation Suite Template -->
                    <div class="validation-type-option" onclick="applyTemplate('schema')" style="cursor: pointer; padding: 20px;">
                        <div style="display: flex; align-items: flex-start; gap: 12px; margin-bottom: 12px;">
                            <span style="font-size: 24px;">üèóÔ∏è</span>
                            <div>
                                <div style="font-weight: 600; color: var(--text-primary); font-size: 16px; margin-bottom: 4px;">
                                    Schema Validation Suite
                                </div>
                                <div style="font-size: 13px; color: var(--text-muted); line-height: 1.5;">
                                    Complete schema structure checks to ensure data format compliance.
                                </div>
                            </div>
                        </div>
                        <div style="padding: 12px; background: var(--bg-tertiary); border-radius: 8px; border-left: 3px solid var(--color-schema);">
                            <div style="font-size: 12px; color: var(--text-secondary); font-weight: 500; margin-bottom: 6px;">Includes:</div>
                            <ul style="margin: 0; padding-left: 20px; font-size: 12px; color: var(--text-muted); line-height: 1.6;">
                                <li>ColumnPresenceCheck - Verifies required columns exist</li>
                                <li>SchemaMatchCheck - Enforces exact schema compliance</li>
                            </ul>
                        </div>
                    </div>

                    <!-- Production Ready Template -->
                    <div class="validation-type-option" onclick="applyTemplate('production')" style="cursor: pointer; padding: 20px;">
                        <div style="display: flex; align-items: flex-start; gap: 12px; margin-bottom: 12px;">
                            <span style="font-size: 24px;">üöÄ</span>
                            <div>
                                <div style="font-weight: 600; color: var(--text-primary); font-size: 16px; margin-bottom: 4px;">
                                    Production Ready
                                </div>
                                <div style="font-size: 13px; color: var(--text-muted); line-height: 1.5;">
                                    Comprehensive validation suite combining file, schema, and data quality checks.
                                </div>
                            </div>
                        </div>
                        <div style="padding: 12px; background: var(--bg-tertiary); border-radius: 8px; border-left: 3px solid var(--color-cross-file);">
                            <div style="font-size: 12px; color: var(--text-secondary); font-weight: 500; margin-bottom: 6px;">Includes all checks from:</div>
                            <ul style="margin: 0; padding-left: 20px; font-size: 12px; color: var(--text-muted); line-height: 1.6;">
                                <li>Essential File Checks (2 validations)</li>
                                <li>Data Quality Basics (4 validations)</li>
                                <li>Schema Validation Suite (3 validations)</li>
                            </ul>
                            <div style="margin-top: 8px; padding-top: 8px; border-top: 1px solid var(--border); font-size: 12px; color: var(--text-primary); font-weight: 500;">
                                Total: 9 validations
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeTemplateModal()">
                    Cancel
                </button>
            </div>
        </div>
    </div>

    <!-- Import YAML Modal -->
    <div class="modal" id="importModal" onclick="if(event.target === this) closeImportModal()">
        <div class="modal-content">
            <div class="modal-header">
                <div>
                    <h2 class="modal-title">Import YAML Configuration</h2>
                    <p style="margin: 4px 0 0 0; font-size: 13px; color: var(--text-muted); font-weight: normal;">
                        Load an existing validation configuration for editing
                    </p>
                </div>
                <button class="btn btn-secondary btn-icon" onclick="closeImportModal()">
                    <span>‚úï</span>
                </button>
            </div>
            <div class="modal-body">
                <div style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 8px; color: var(--text-primary); font-weight: 500;">
                        Choose Import Method
                    </label>
                    <div style="display: flex; gap: 8px; margin-bottom: 16px;">
                        <button class="btn btn-secondary" id="uploadTabBtn" onclick="switchImportTab('upload')" style="flex: 1;">
                            üìÅ Upload File
                        </button>
                        <button class="btn btn-secondary" id="pasteTabBtn" onclick="switchImportTab('paste')" style="flex: 1;">
                            üìã Paste YAML
                        </button>
                    </div>
                </div>

                <!-- Upload Tab -->
                <div id="uploadTab" style="display: none;">
                    <input type="file" id="yamlFileInput" accept=".yaml,.yml" style="display: none;" onchange="handleFileUpload(event)">
                    <div style="border: 2px dashed var(--border); border-radius: 12px; padding: 40px; text-align: center; cursor: pointer;" onclick="document.getElementById('yamlFileInput').click()">
                        <div style="font-size: 48px; margin-bottom: 16px;">üìÅ</div>
                        <div style="color: var(--text-primary); font-weight: 500; margin-bottom: 8px;">
                            Click to upload YAML file
                        </div>
                        <div style="color: var(--text-muted); font-size: 13px;">
                            Supports .yaml and .yml files
                        </div>
                    </div>
                </div>

                <!-- Paste Tab -->
                <div id="pasteTab" style="display: none;">
                    <textarea
                        id="yamlPasteArea"
                        placeholder="Paste your YAML configuration here..."
                        style="width: 100%; height: 300px; padding: 16px; background: var(--bg-primary); border: 1px solid var(--border); border-radius: 8px; color: var(--text-primary); font-family: 'Roboto Mono', monospace; font-size: 13px; resize: vertical;"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeImportModal()">
                    Cancel
                </button>
                <button class="btn btn-primary" onclick="processImport()">
                    Import Configuration
                </button>
            </div>
        </div>
    </div>

    <!-- Project Templates Modal -->
    <div class="modal" id="projectTemplatesModal" onclick="if(event.target === this) closeProjectTemplatesModal()">
        <div class="modal-content">
            <div class="modal-header">
                <div>
                    <h2 class="modal-title">Project Templates</h2>
                    <p style="margin: 4px 0 0 0; font-size: 13px; color: var(--text-muted); font-weight: normal;">
                        Scaffold multiple files at once for common data validation scenarios
                    </p>
                </div>
                <button class="btn btn-secondary btn-icon" onclick="closeProjectTemplatesModal()">
                    <span>‚úï</span>
                </button>
            </div>
            <div class="modal-body">
                <div style="display: grid; gap: 16px;">
                    <!-- E-commerce Template -->
                    <div class="validation-type-option" onclick="applyProjectTemplate('ecommerce')" style="cursor: pointer; padding: 20px;">
                        <div style="display: flex; align-items: flex-start; gap: 12px; margin-bottom: 12px;">
                            <span style="font-size: 24px;">üõí</span>
                            <div>
                                <div style="font-weight: 600; color: var(--text-primary); font-size: 16px; margin-bottom: 4px;">
                                    E-commerce System
                                </div>
                                <div style="font-size: 13px; color: var(--text-muted); line-height: 1.5;">
                                    Standard e-commerce data structure with orders, customers, products, and order details.
                                </div>
                            </div>
                        </div>
                        <div style="padding: 12px; background: var(--bg-tertiary); border-radius: 8px; border-left: 3px solid var(--color-field);">
                            <div style="font-size: 12px; color: var(--text-secondary); font-weight: 500; margin-bottom: 6px;">Creates 4 files:</div>
                            <ul style="margin: 0; padding-left: 20px; font-size: 12px; color: var(--text-muted); line-height: 1.6;">
                                <li>customers.csv - Customer master data</li>
                                <li>products.csv - Product catalog</li>
                                <li>orders.csv - Order headers</li>
                                <li>order_details.csv - Order line items</li>
                            </ul>
                        </div>
                    </div>

                    <!-- CRM Template -->
                    <div class="validation-type-option" onclick="applyProjectTemplate('crm')" style="cursor: pointer; padding: 20px;">
                        <div style="display: flex; align-items: flex-start; gap: 12px; margin-bottom: 12px;">
                            <span style="font-size: 24px;">üë•</span>
                            <div>
                                <div style="font-weight: 600; color: var(--text-primary); font-size: 16px; margin-bottom: 4px;">
                                    CRM System
                                </div>
                                <div style="font-size: 13px; color: var(--text-muted); line-height: 1.5;">
                                    Customer relationship management with contacts, accounts, opportunities, and activities.
                                </div>
                            </div>
                        </div>
                        <div style="padding: 12px; background: var(--bg-tertiary); border-radius: 8px; border-left: 3px solid var(--color-record);">
                            <div style="font-size: 12px; color: var(--text-secondary); font-weight: 500; margin-bottom: 6px;">Creates 4 files:</div>
                            <ul style="margin: 0; padding-left: 20px; font-size: 12px; color: var(--text-muted); line-height: 1.6;">
                                <li>contacts.csv - Individual contacts</li>
                                <li>accounts.csv - Company accounts</li>
                                <li>opportunities.csv - Sales opportunities</li>
                                <li>activities.csv - Interaction history</li>
                            </ul>
                        </div>
                    </div>

                    <!-- Data Warehouse Template -->
                    <div class="validation-type-option" onclick="applyProjectTemplate('warehouse')" style="cursor: pointer; padding: 20px;">
                        <div style="display: flex; align-items: flex-start; gap: 12px; margin-bottom: 12px;">
                            <span style="font-size: 24px;">üè¢</span>
                            <div>
                                <div style="font-weight: 600; color: var(--text-primary); font-size: 16px; margin-bottom: 4px;">
                                    Data Warehouse
                                </div>
                                <div style="font-size: 13px; color: var(--text-muted); line-height: 1.5;">
                                    Star schema with fact table and dimension tables for analytics.
                                </div>
                            </div>
                        </div>
                        <div style="padding: 12px; background: var(--bg-tertiary); border-radius: 8px; border-left: 3px solid var(--color-statistical);">
                            <div style="font-size: 12px; color: var(--text-secondary); font-weight: 500; margin-bottom: 6px;">Creates 5 files:</div>
                            <ul style="margin: 0; padding-left: 20px; font-size: 12px; color: var(--text-muted); line-height: 1.6;">
                                <li>fact_sales.csv - Sales transactions (fact)</li>
                                <li>dim_date.csv - Date dimension</li>
                                <li>dim_product.csv - Product dimension</li>
                                <li>dim_customer.csv - Customer dimension</li>
                                <li>dim_location.csv - Location dimension</li>
                            </ul>
                        </div>
                    </div>

                    <!-- Master-Reference Template -->
                    <div class="validation-type-option" onclick="applyProjectTemplate('master-reference')" style="cursor: pointer; padding: 20px;">
                        <div style="display: flex; align-items: flex-start; gap: 12px; margin-bottom: 12px;">
                            <span style="font-size: 24px;">üìö</span>
                            <div>
                                <div style="font-weight: 600; color: var(--text-primary); font-size: 16px; margin-bottom: 4px;">
                                    Master-Reference
                                </div>
                                <div style="font-size: 13px; color: var(--text-muted); line-height: 1.5;">
                                    Simple two-file setup with transactional data and lookup reference data.
                                </div>
                            </div>
                        </div>
                        <div style="padding: 12px; background: var(--bg-tertiary); border-radius: 8px; border-left: 3px solid var(--color-cross-file);">
                            <div style="font-size: 12px; color: var(--text-secondary); font-weight: 500; margin-bottom: 6px;">Creates 2 files:</div>
                            <ul style="margin: 0; padding-left: 20px; font-size: 12px; color: var(--text-muted); line-height: 1.6;">
                                <li>transactions.csv - Main transactional data</li>
                                <li>reference_data.csv - Lookup tables and codes</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeProjectTemplatesModal()">
                    Cancel
                </button>
            </div>
        </div>
    </div>

    <!-- Live Validation Preview Modal -->
    <div class="modal" id="livePreviewModal" onclick="if(event.target === this) closeLivePreviewModal()">
        <div class="modal-content" style="max-width: 900px;">
            <div class="modal-header">
                <div>
                    <h2 class="modal-title">Live Validation Preview</h2>
                    <p style="margin: 4px 0 0 0; font-size: 13px; color: var(--text-muted); font-weight: normal;">
                        Test your validations against sample data
                    </p>
                </div>
                <button class="btn btn-secondary btn-icon" onclick="closeLivePreviewModal()">
                    <span>‚úï</span>
                </button>
            </div>
            <div class="modal-body">
                <div id="livePreviewContent" style="display: grid; gap: 16px;">
                    <!-- File Upload Section -->
                    <div style="padding: 20px; background: var(--bg-secondary); border-radius: 12px; border: 2px dashed var(--border); text-align: center;">
                        <div style="font-size: 32px; margin-bottom: 12px;">üì§</div>
                        <h4 style="color: var(--text-primary); margin: 0 0 8px 0;">Upload Sample Data</h4>
                        <p style="color: var(--text-muted); margin: 0 0 16px 0; font-size: 13px;">
                            Upload a CSV or JSON file to test your validations
                        </p>
                        <input
                            type="file"
                            id="livePreviewFileInput"
                            accept=".csv,.json"
                            style="display: none;"
                            onchange="handleLivePreviewFileUpload(event)">
                        <button class="btn btn-primary" onclick="document.getElementById('livePreviewFileInput').click()">
                            Choose File
                        </button>
                        <div id="livePreviewFileName" style="margin-top: 12px; color: var(--text-muted); font-size: 12px;">
                            No file selected
                        </div>
                    </div>

                    <!-- Results Section (initially hidden) -->
                    <div id="livePreviewResults" style="display: none;">
                        <!-- Dynamic results will be inserted here -->
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeLivePreviewModal()">
                    Close
                </button>
                <button class="btn btn-primary" id="exportTestReport" onclick="exportTestReport()" style="display: none;">
                    Export Report
                </button>
            </div>
        </div>
    </div>

    <!-- Configuration Validator Modal -->
    <div class="modal" id="validatorModal" onclick="if(event.target === this) closeValidatorModal()">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <div>
                    <h2 class="modal-title">Configuration Validator</h2>
                    <p style="margin: 4px 0 0 0; font-size: 13px; color: var(--text-muted); font-weight: normal;">
                        Pre-flight checks for your validation configuration
                    </p>
                </div>
                <button class="btn btn-secondary btn-icon" onclick="closeValidatorModal()">
                    <span>‚úï</span>
                </button>
            </div>
            <div class="modal-body">
                <div id="validatorResults" style="display: grid; gap: 16px;">
                    <!-- Dynamic validation results -->
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeValidatorModal()">
                    Close
                </button>
                <button class="btn btn-primary" id="validatorDownloadBtn" onclick="downloadConfigAfterValidation()">
                    Download Anyway
                </button>
            </div>
        </div>
    </div>

    <!-- Save Preset Modal -->
    <div class="modal" id="savePresetModal" onclick="if(event.target === this) closeSavePresetModal()">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h2 class="modal-title">Save Validation Preset</h2>
                <button class="btn btn-secondary btn-icon" onclick="closeSavePresetModal()">
                    <span>‚úï</span>
                </button>
            </div>
            <div class="modal-body">
                <div style="display: grid; gap: 16px;">
                    <div>
                        <label style="display: block; margin-bottom: 8px; color: var(--text-primary); font-weight: 500;">
                            Preset Name
                        </label>
                        <input
                            type="text"
                            id="presetName"
                            placeholder="E.g., Common CSV Checks, Standard File Validation"
                            style="width: 100%; padding: 10px 14px; background: var(--bg-primary); border: 1px solid var(--border); border-radius: 8px; color: var(--text-primary); font-size: 14px;">
                        <small style="display: block; margin-top: 6px; color: var(--text-muted); font-size: 12px;">
                            Give your preset a descriptive name for easy identification
                        </small>
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 8px; color: var(--text-primary); font-weight: 500;">
                            Description (Optional)
                        </label>
                        <textarea
                            id="presetDescription"
                            placeholder="Describe when to use this preset..."
                            rows="3"
                            style="width: 100%; padding: 10px 14px; background: var(--bg-primary); border: 1px solid var(--border); border-radius: 8px; color: var(--text-primary); font-size: 14px; resize: vertical;"></textarea>
                    </div>
                    <div id="presetPreview" style="padding: 16px; background: var(--bg-secondary); border-radius: 8px; border: 1px solid var(--border);">
                        <h4 style="color: var(--text-primary); margin: 0 0 12px 0; font-size: 14px;">Validations to Save</h4>
                        <div id="presetPreviewContent" style="font-size: 13px; color: var(--text-muted);">
                            <!-- Dynamic preview -->
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeSavePresetModal()">
                    Cancel
                </button>
                <button class="btn btn-primary" onclick="confirmSavePreset()">
                    Save Preset
                </button>
            </div>
        </div>
    </div>

    <!-- Regex Tester Modal -->
    <div class="modal" id="regexTesterModal" onclick="if(event.target === this) closeRegexTesterModal()">
        <div class="modal-content" style="max-width: 700px;">
            <div class="modal-header">
                <div>
                    <h2 class="modal-title">Regex Pattern Tester</h2>
                    <p style="margin: 4px 0 0 0; font-size: 13px; color: var(--text-muted); font-weight: normal;">
                        Test and validate regular expression patterns for PatternMatchCheck
                    </p>
                </div>
                <button class="btn btn-secondary btn-icon" onclick="closeRegexTesterModal()">
                    <span>‚úï</span>
                </button>
            </div>
            <div class="modal-body">
                <div style="display: grid; gap: 20px;">
                    <!-- Pattern Input -->
                    <div>
                        <label style="display: block; margin-bottom: 8px; color: var(--text-primary); font-weight: 500;">
                            Regular Expression Pattern
                        </label>
                        <input
                            type="text"
                            id="regexPattern"
                            placeholder="^[A-Z]{2}\\d{4}$"
                            oninput="testRegexPattern()"
                            style="width: 100%; padding: 10px 14px; background: var(--bg-primary); border: 1px solid var(--border); border-radius: 8px; color: var(--text-primary); font-size: 14px; font-family: 'Courier New', monospace;">
                        <small style="display: block; margin-top: 6px; color: var(--text-muted); font-size: 12px;">
                            Enter a regex pattern (e.g., ^\d{3}-\d{2}-\d{4}$ for SSN format)
                        </small>
                    </div>

                    <!-- Test String Input -->
                    <div>
                        <label style="display: block; margin-bottom: 8px; color: var(--text-primary); font-weight: 500;">
                            Test String
                        </label>
                        <textarea
                            id="regexTestString"
                            placeholder="AB1234&#10;CD5678&#10;EF9999"
                            oninput="testRegexPattern()"
                            rows="5"
                            style="width: 100%; padding: 10px 14px; background: var(--bg-primary); border: 1px solid var(--border); border-radius: 8px; color: var(--text-primary); font-size: 14px; font-family: 'Courier New', monospace; resize: vertical;"></textarea>
                        <small style="display: block; margin-top: 6px; color: var(--text-muted); font-size: 12px;">
                            Enter test strings (one per line) to validate against the pattern
                        </small>
                    </div>

                    <!-- Results -->
                    <div id="regexResults" style="display: none;">
                        <div style="padding: 16px; background: var(--bg-secondary); border-radius: 8px; border: 1px solid var(--border);">
                            <h4 style="color: var(--text-primary); margin: 0 0 12px 0; font-size: 14px;">Test Results</h4>
                            <div id="regexResultsContent"></div>
                        </div>
                    </div>

                    <!-- Common Patterns Reference -->
                    <div style="padding: 16px; background: var(--bg-tertiary); border-radius: 8px; border-left: 3px solid var(--md-sys-color-primary);">
                        <h4 style="color: var(--text-primary); margin: 0 0 12px 0; font-size: 14px;">üí° Common Patterns</h4>
                        <div style="display: grid; gap: 8px; font-size: 12px; color: var(--text-muted);">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <code style="background: var(--bg-primary); padding: 4px 8px; border-radius: 4px; color: var(--md-sys-color-primary);">^\d{3}-\d{2}-\d{4}$</code>
                                <span>SSN (123-45-6789)</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <code style="background: var(--bg-primary); padding: 4px 8px; border-radius: 4px; color: var(--md-sys-color-primary);">^[A-Z0-9._%+-]+@[A-Z0-9.-]+\.[A-Z]{2,}$</code>
                                <span>Email</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <code style="background: var(--bg-primary); padding: 4px 8px; border-radius: 4px; color: var(--md-sys-color-primary);">^\d{4}-\d{2}-\d{2}$</code>
                                <span>Date (YYYY-MM-DD)</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <code style="background: var(--bg-primary); padding: 4px 8px; border-radius: 4px; color: var(--md-sys-color-primary);">^[A-Z]{2}\d{6}$</code>
                                <span>Code (AB123456)</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeRegexTesterModal()">
                    Close
                </button>
            </div>
        </div>
    </div>

    <div class="app-container">
        <!-- Sidebar -->
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <div class="logo">
                    <span class="logo-icon">‚öôÔ∏è</span>
                    <span>Config Builder</span>
                </div>
                <button class="collapse-btn" onclick="toggleSidebar()">
                    ‚óÄ
                </button>
            </div>

            <div class="search-box">
                <input
                    type="text"
                    class="search-input"
                    placeholder="Search... (‚åòK)"
                    id="searchInput"
                    onkeyup="handleSearch(event)">
            </div>

            <!-- Quick Stats -->
            <div id="quickStats" style="padding: 12px 20px; background: var(--bg-secondary); margin: 0 12px 12px 12px; border-radius: 8px; border: 1px solid var(--border);">
                <div style="display: grid; gap: 8px;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <span style="color: var(--text-muted); font-size: 12px;">Files</span>
                        <span id="statsFiles" style="color: var(--text-primary); font-weight: 600; font-size: 14px;">0</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <span style="color: var(--text-muted); font-size: 12px;">Validations</span>
                        <span id="statsValidations" style="color: var(--text-primary); font-weight: 600; font-size: 14px;">0</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; align-items: center; padding-top: 8px; border-top: 1px solid var(--border);">
                        <span style="color: var(--text-muted); font-size: 12px;">Health</span>
                        <span id="statsHealth" style="color: var(--md-sys-color-primary); font-weight: 600; font-size: 14px;">-</span>
                    </div>
                </div>
            </div>

            <!-- Validation Presets -->
            <div id="presetsSection" style="margin: 0 12px 12px 12px; background: var(--bg-secondary); border-radius: 8px; border: 1px solid var(--border); overflow: hidden;">
                <div style="padding: 12px 16px; display: flex; justify-content: space-between; align-items: center; cursor: pointer; user-select: none;" onclick="togglePresetsCollapse()">
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <span id="presetsCollapseIcon" style="transition: transform 0.2s; font-size: 12px;">‚ñº</span>
                        <span style="color: var(--text-primary); font-weight: 600; font-size: 13px;">‚≠ê Presets</span>
                    </div>
                    <button
                        class="md-button-text"
                        onclick="event.stopPropagation(); openSavePresetModal()"
                        style="padding: 4px 12px; font-size: 12px;"
                        title="Save current validations as preset">
                        + Save
                    </button>
                </div>
                <div id="presetsContent" style="border-top: 1px solid var(--border);">
                    <div id="presetsList" style="max-height: 200px; overflow-y: auto;">
                        <!-- Dynamic presets list -->
                    </div>
                </div>
            </div>

            <nav class="sidebar-nav">
                <div class="nav-section">
                    <div class="nav-item active" onclick="showSection('job')">
                        <span class="nav-icon">üìã</span>
                        <span class="nav-label">Job Settings</span>
                    </div>
                </div>

                <div class="nav-section">
                    <div class="nav-header">
                        <span>Configuration</span>
                    </div>
                    <div class="nav-item" onclick="showSection('settings')">
                        <span class="nav-icon">‚öôÔ∏è</span>
                        <span class="nav-label">Advanced Settings</span>
                    </div>
                </div>

                <div class="nav-section">
                    <div class="nav-header">
                        <span>Files</span>
                        <span class="nav-badge" id="filesCount">0</span>
                    </div>
                    <div id="filesNav">
                        <!-- Dynamic file items -->
                    </div>
                </div>

                <div class="nav-section">
                    <div class="nav-header">
                        <span>Actions</span>
                    </div>
                    <div class="nav-item" onclick="showSection('summary')">
                        <span class="nav-icon">üìä</span>
                        <span class="nav-label">Summary</span>
                    </div>
                    <div class="nav-item" onclick="openImportModal()">
                        <span class="nav-icon">üìÇ</span>
                        <span class="nav-label">Import YAML</span>
                    </div>
                    <div class="nav-item" onclick="exportDocumentation()">
                        <span class="nav-icon">üìÑ</span>
                        <span class="nav-label">Export Docs</span>
                    </div>
                    <div class="nav-item" onclick="shareViaURL()">
                        <span class="nav-icon">üîó</span>
                        <span class="nav-label">Share URL</span>
                    </div>
                    <div class="nav-item" onclick="toggleTheme()">
                        <span class="nav-icon">üé®</span>
                        <span class="nav-label">Toggle Theme</span>
                    </div>
                    <div class="nav-item" onclick="showKeyboardShortcutsHelp()">
                        <span class="nav-icon">‚å®Ô∏è</span>
                        <span class="nav-label">Keyboard Shortcuts</span>
                    </div>
                    <div class="nav-item" onclick="openProjectTemplatesModal()">
                        <span class="nav-icon">üéØ</span>
                        <span class="nav-label">Project Templates</span>
                    </div>
                    <div class="nav-item" onclick="openRegexTesterModal()">
                        <span class="nav-icon">üîß</span>
                        <span class="nav-label">Regex Tester</span>
                    </div>
                    <div class="nav-item" onclick="clearLocalStorage()">
                        <span class="nav-icon">üóëÔ∏è</span>
                        <span class="nav-label">Clear Storage</span>
                    </div>
                </div>
            </nav>

            <div class="sidebar-footer">
                <button class="btn btn-primary btn-full" onclick="downloadConfig()">
                    <span class="icon">üì•</span>
                    <span>Download</span>
                </button>
            </div>
        </aside>

        <!-- Main Workspace -->
        <main class="workspace">
            <div class="workspace-header">
                <div class="breadcrumbs">
                    <span class="breadcrumb active" id="breadcrumb">Job Settings</span>
                </div>
                <div class="page-header">
                    <div class="title-section">
                        <button class="mobile-menu-btn" onclick="toggleMobileSidebar()" title="Menu">
                            <span style="font-size: 20px;">‚ò∞</span>
                        </button>
                        <h1 class="page-title" id="pageTitle">Job Settings</h1>
                        <span class="status-badge success" id="statusBadge">Ready</span>
                    </div>
                    <div class="header-actions">
                        <span style="font-size: 11px; color: var(--text-muted); margin-right: 12px; opacity: 0.7;">v3.5.0</span>
                        <button class="btn btn-secondary" onclick="openLivePreviewModal()" title="Test with Sample Data" style="margin-right: 8px;">
                            <span class="icon">üß™</span>
                            <span>Test</span>
                        </button>
                        <button class="btn btn-secondary" onclick="openValidatorModal()" title="Validate Configuration" style="margin-right: 8px;">
                            <span class="icon">‚úì</span>
                            <span>Validate</span>
                        </button>
                        <button class="btn btn-primary" onclick="downloadConfig()" title="Download YAML Configuration" style="margin-right: 8px;">
                            <span class="icon">üì•</span>
                            <span>Download</span>
                        </button>
                        <button class="btn btn-secondary btn-icon" onclick="togglePreview()" title="Toggle Preview">
                            <span>üëÅÔ∏è</span>
                        </button>
                    </div>
                </div>
            </div>

            <div class="workspace-content" id="workspaceContent">
                <!-- Dynamic content -->
            </div>
        </main>

        <!-- YAML Preview Panel -->
        <aside class="preview-panel collapsed" id="previewPanel">
            <div class="preview-header">
                <h3 class="preview-title">YAML Preview</h3>
                <button class="btn btn-secondary btn-icon" onclick="togglePreview()">
                    <span>‚úï</span>
                </button>
            </div>
            <div class="preview-body">
                <pre class="yaml-code" id="yamlPreview"># Your configuration will appear here</pre>
            </div>
            <div class="preview-footer">
                <button class="btn btn-secondary btn-full" onclick="copyYAML()">
                    <span class="icon">üìã</span>
                    Copy
                </button>
            </div>
        </aside>
    </div>

    <script>
        // Global state
        let state = {
            currentSection: 'job',
            jobName: 'Data Validation Job',
            files: [],
            settings: {
                chunk_size: 10000,
                max_sample_failures: 100,
                fail_fast: false,
                log_level: 'INFO'
            },
            fileCounter: 0,
            modalState: {
                currentFileId: null,
                selectedTypes: [],  // Changed to array for multiple selection
                selectedSeverity: 'ERROR'
            },
            theme: localStorage.getItem('theme') || 'dark', // Theme preference
            searchQuery: {} // Per-file search queries (fileId -> query string)
        };

        // Undo/Redo system
        const undoStack = [];
        const redoStack = [];
        const MAX_UNDO_STACK = 50;

        // Validation Types Catalog with clear, concise descriptions
        const validationTypes = {
            file: [
                { type: 'EmptyFileCheck', desc: 'Prevents processing files with no data rows' },
                { type: 'RowCountRangeCheck', desc: 'Ensures row count falls within min/max bounds' },
                { type: 'FileSizeCheck', desc: 'Validates file size to prevent memory issues' }
            ],
            schema: [
                { type: 'SchemaMatchCheck', desc: 'Enforces exact column structure (names, order, types)' },
                { type: 'ColumnPresenceCheck', desc: 'Verifies required columns exist (flexible order)' }
            ],
            field: [
                { type: 'MandatoryFieldCheck', desc: 'Ensures critical fields are never empty/null' },
                { type: 'RegexCheck', desc: 'Validates field format using regex (emails, IDs, etc.)' },
                { type: 'ValidValuesCheck', desc: 'Restricts fields to approved whitelist values' },
                { type: 'RangeCheck', desc: 'Ensures numbers stay within min/max bounds' },
                { type: 'DateFormatCheck', desc: 'Validates dates match specific format (e.g., YYYY-MM-DD)' },
                { type: 'StringLengthCheck', desc: 'Checks text length falls within character limits' },
                { type: 'CompletenessCheck', desc: 'Monitors minimum field population percentage' }
            ],
            record: [
                { type: 'DuplicateRowCheck', desc: 'Finds duplicate records based on key columns' },
                { type: 'BlankRecordCheck', desc: 'Identifies completely empty rows (all fields null)' },
                { type: 'UniqueKeyCheck', desc: 'Enforces primary key uniqueness constraints' }
            ],
            crossFile: [
                { type: 'ReferentialIntegrityCheck', desc: 'Validates foreign key relationships between files' },
                { type: 'CrossFileComparisonCheck', desc: 'Compares aggregated metrics across related files' },
                { type: 'CrossFileDuplicateCheck', desc: 'Detects duplicate records appearing in multiple files' }
            ],
            statistical: [
                { type: 'StatisticalOutlierCheck', desc: 'Identifies values beyond statistical norms (¬±3œÉ)' },
                { type: 'DistributionCheck', desc: 'Validates data follows expected distribution patterns' },
                { type: 'CorrelationCheck', desc: 'Monitors field relationships for data consistency' }
            ]
        };

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            // Version and cache busting check
            const version = '3.0.0';
            const buildDate = '2025-01-14';
            console.log(`%c Data Validation Config Builder v${version} `, 'background: #10B981; color: white; padding: 4px 8px; border-radius: 4px; font-weight: bold');
            console.log(`Build Date: ${buildDate}`);
            console.log(`Load Time: ${new Date().toISOString()}`);
            console.log('If you see an old version, clear your browser cache (Ctrl+Shift+R or Cmd+Shift+R)');

            // Show job settings and mark nav item as active
            showSection('job');
            const jobNavItem = document.querySelector('.nav-item[onclick*="job"]');
            if (jobNavItem) {
                jobNavItem.classList.add('active');
            }

            // Show preview panel on desktop by default
            if (window.innerWidth > 1024) {
                const previewPanel = document.getElementById('previewPanel');
                if (previewPanel) {
                    previewPanel.classList.remove('collapsed');
                }
            }

            updateYAMLPreview();

            // Load from URL hash if present (takes precedence)
            loadFromURLHash();

            // Load saved state from localStorage
            if (!window.location.hash.startsWith('#config=')) {
                loadFromLocalStorage();
            }

            // Auto-save every 30 seconds
            setInterval(saveToLocalStorage, 30000);

            // Save before page unload
            window.addEventListener('beforeunload', saveToLocalStorage);

            // Update last saved indicator every minute
            setInterval(updateLastSavedIndicator, 60000);

            // Initialize keyboard shortcuts
            initKeyboardShortcuts();

            // Load and render validation presets
            renderPresets();

            // Apply saved theme
            applyTheme(state.theme);
        });

        // Auto-Save Functions
        /**
         * Saves current state to browser localStorage
         */
        function saveToLocalStorage() {
            try {
                const stateToSave = {
                    jobName: state.jobName,
                    files: state.files,
                    settings: state.settings,
                    fileCounter: state.fileCounter,
                    timestamp: new Date().toISOString()
                };
                localStorage.setItem('validationConfigBuilder', JSON.stringify(stateToSave));
                updateLastSavedIndicator();
                console.log('‚úÖ Auto-saved to browser storage');
            } catch (error) {
                console.error('Failed to save to localStorage:', error);
            }
        }

        /**
         * Loads state from browser localStorage
         */
        function loadFromLocalStorage() {
            try {
                const saved = localStorage.getItem('validationConfigBuilder');
                if (saved) {
                    const savedState = JSON.parse(saved);

                    // Restore state
                    state.jobName = savedState.jobName || state.jobName;
                    state.files = savedState.files || state.files;
                    state.settings = savedState.settings || state.settings;
                    state.fileCounter = savedState.fileCounter || state.fileCounter;

                    // Update UI
                    updateFilesNav();
                    updateYAMLPreview();
                    updateLastSavedIndicator();

                    console.log('‚úÖ Loaded saved configuration from', savedState.timestamp);

                    // Show notification
                    if (savedState.files.length > 0) {
                        showNotification('Restored previous session with ' + savedState.files.length + ' file(s)');
                    }
                }
            } catch (error) {
                console.error('Failed to load from localStorage:', error);
            }
        }

        /**
         * Clears saved state from localStorage
         */
        function clearLocalStorage() {
            if (confirm('Are you sure you want to clear all saved data? This cannot be undone.')) {
                localStorage.removeItem('validationConfigBuilder');
                showNotification('Saved data cleared');
                updateLastSavedIndicator();
            }
        }

        /**
         * Updates the last saved timestamp indicator
         */
        function updateLastSavedIndicator() {
            const saved = localStorage.getItem('validationConfigBuilder');
            if (saved) {
                const savedState = JSON.parse(saved);
                const timestamp = new Date(savedState.timestamp);
                const timeAgo = getTimeAgo(timestamp);

                // Update status badge if it exists
                const statusBadge = document.getElementById('statusBadge');
                if (statusBadge) {
                    statusBadge.textContent = 'Saved ' + timeAgo;
                    statusBadge.title = 'Last saved: ' + timestamp.toLocaleString();
                }
            }
        }

        /**
         * Gets human-readable time ago string
         * @param {Date} timestamp - The timestamp
         * @returns {string} Human-readable time ago
         */
        function getTimeAgo(timestamp) {
            const seconds = Math.floor((new Date() - timestamp) / 1000);

            if (seconds < 60) return 'just now';
            if (seconds < 3600) return Math.floor(seconds / 60) + 'm ago';
            if (seconds < 86400) return Math.floor(seconds / 3600) + 'h ago';
            return Math.floor(seconds / 86400) + 'd ago';
        }

        /**
         * Shows a temporary notification message
         * @param {string} message - The notification message
         */
        function showNotification(message) {
            // Create notification element
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                bottom: 24px;
                right: 24px;
                background: var(--md-sys-color-surface-container-high);
                color: var(--md-sys-color-on-surface);
                padding: 16px 24px;
                border-radius: 12px;
                box-shadow: var(--md-sys-elevation-3);
                border: 1px solid var(--md-sys-color-outline-variant);
                z-index: 9999;
                font-size: 14px;
                font-weight: 500;
                animation: slideInUp 0.3s ease-out;
            `;
            notification.textContent = message;

            // Add to page
            document.body.appendChild(notification);

            // Remove after 3 seconds
            setTimeout(() => {
                notification.style.animation = 'slideOutDown 0.3s ease-in';
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }

        // Modal Functions for Add Validation Wizard
        /**
         * Opens the validation selection modal for a specific file
         * @param {string} fileId - The ID of the file to add validation to
         */
        function openValidationModal(fileId) {
            // Store file ID in modal state
            state.modalState.fileId = fileId;
            state.modalState.selectedTypes = [];
            state.modalState.severity = 'ERROR';

            // Render modal content
            renderValidationModal();

            // Show modal with animation
            const modal = document.getElementById('validationModal');
            modal.style.display = 'flex';
            // Force reflow for animation
            modal.offsetHeight;
            modal.style.opacity = '1';
        }

        /**
         * Closes the validation modal and resets state
         */
        function closeValidationModal() {
            const modal = document.getElementById('validationModal');
            modal.style.opacity = '0';
            setTimeout(() => {
                modal.style.display = 'none';
                state.modalState = { fileId: null, selectedTypes: [], severity: 'ERROR' };
            }, 200);
        }

        /**
         * Renders the validation type options in the modal grouped by category
         */
        function renderValidationModal() {
            const container = document.getElementById('validationTypesList');

            // Category display configuration with colors and icons
            const categories = {
                file: {
                    label: 'File Validations',
                    color: 'var(--validation-file)',
                    icon: 'üìÑ'
                },
                schema: {
                    label: 'Schema Validations',
                    color: 'var(--validation-schema)',
                    icon: 'üèóÔ∏è'
                },
                field: {
                    label: 'Field Validations',
                    color: 'var(--validation-field)',
                    icon: '‚úèÔ∏è'
                },
                record: {
                    label: 'Record Validations',
                    color: 'var(--validation-record)',
                    icon: 'üìã'
                },
                crossFile: {
                    label: 'Cross-File Validations',
                    color: 'var(--validation-cross-file)',
                    icon: 'üîó'
                },
                statistical: {
                    label: 'Statistical Validations',
                    color: 'var(--validation-statistical)',
                    icon: 'üìä'
                }
            };

            let html = '';

            // Render each category
            Object.keys(validationTypes).forEach(category => {
                const categoryInfo = categories[category];
                const validations = validationTypes[category];

                html += `
                    <div class="validation-category" style="margin-bottom: 20px;">
                        <h4 style="color: ${categoryInfo.color}; font-size: 14px; font-weight: 600; margin-bottom: 12px; display: flex; align-items: center; gap: 8px;">
                            <span>${categoryInfo.icon}</span>
                            <span>${categoryInfo.label}</span>
                        </h4>
                        <div style="display: grid; gap: 8px;">
                `;

                // Render each validation in this category
                validations.forEach(validation => {
                    const isSelected = state.modalState.selectedTypes.includes(validation.type);
                    html += `
                        <div
                            class="validation-type-option ${isSelected ? 'selected' : ''}"
                            onclick="selectValidationType('${validation.type}')"
                            data-type="${validation.type}"
                            style="border-color: ${isSelected ? categoryInfo.color : 'var(--border)'}; ${isSelected ? `background: ${categoryInfo.color}15;` : ''}">
                            <div style="font-weight: 500; color: var(--text-primary); margin-bottom: 4px;">
                                ${validation.type}
                            </div>
                            <div style="font-size: 12px; color: var(--text-muted);">
                                ${validation.desc}
                            </div>
                        </div>
                    `;
                });

                html += `
                        </div>
                    </div>
                `;
            });

            container.innerHTML = html;

            // Update severity selector state
            renderSeveritySelector();

            // Update confirm button state
            updateConfirmButton();
        }

        /**
         * Renders the severity selector buttons with current selection
         */
        function renderSeveritySelector() {
            const container = document.getElementById('severitySelector');
            const severities = ['ERROR', 'WARNING'];

            container.innerHTML = severities.map(sev => `
                <button
                    class="severity-btn ${state.modalState.severity === sev ? 'active' : ''}"
                    onclick="selectSeverity('${sev}')"
                    style="${state.modalState.severity === sev ? `background: ${sev === 'ERROR' ? 'var(--status-error)' : 'var(--status-warning)'}; color: white;` : ''}">
                    ${sev}
                </button>
            `).join('');
        }

        /**
         * Handles validation type selection (toggle - can select multiple)
         * @param {string} type - The validation type selected
         */
        function selectValidationType(type) {
            // Toggle selection
            const index = state.modalState.selectedTypes.indexOf(type);
            if (index > -1) {
                // Already selected, remove it
                state.modalState.selectedTypes.splice(index, 1);
            } else {
                // Not selected, add it
                state.modalState.selectedTypes.push(type);
            }

            // Re-render modal to update UI
            renderValidationModal();
        }

        /**
         * Handles severity selection
         * @param {string} severity - ERROR or WARNING
         */
        function selectSeverity(severity) {
            state.modalState.severity = severity;
            renderSeveritySelector();
        }

        /**
         * Updates the confirm button enabled/disabled state
         */
        function updateConfirmButton() {
            const confirmBtn = document.querySelector('.modal-footer .btn-primary');
            if (confirmBtn) {
                const hasSelection = state.modalState.selectedTypes.length > 0;
                confirmBtn.disabled = !hasSelection;
                confirmBtn.style.opacity = hasSelection ? '1' : '0.5';
                confirmBtn.style.cursor = hasSelection ? 'pointer' : 'not-allowed';

                // Update button text to show count
                const count = state.modalState.selectedTypes.length;
                if (count > 1) {
                    confirmBtn.innerHTML = `Add ${count} Validations`;
                } else {
                    confirmBtn.innerHTML = 'Add Validation';
                }
            }
        }

        /**
         * Confirms the validation selection and adds all selected validations to the file
         */
        function confirmAddValidation() {
            if (state.modalState.selectedTypes.length === 0) {
                return;
            }

            const file = state.files.find(f => f.id === state.modalState.fileId);
            if (file) {
                // Save state for undo
                saveStateToUndoStack();

                // Add all selected validations to the file
                state.modalState.selectedTypes.forEach(type => {
                    file.validations.push({
                        type: type,
                        severity: state.modalState.severity,
                        params: {},
                        enabled: true
                    });
                });

                // Update UI
                renderContent(state.modalState.fileId);
                updateYAMLPreview();
                updateFilesNav();

                // Close modal
                closeValidationModal();
            }
        }

        // Template Modal Functions
        /**
         * Opens the template selection modal for a specific file
         * @param {number} fileId - The file ID to apply template to
         */
        function openTemplateModal(fileId) {
            state.modalState.fileId = fileId;
            const modal = document.getElementById('templateModal');
            modal.style.display = 'flex';
            modal.offsetHeight; // Force reflow
            modal.style.opacity = '1';
        }

        /**
         * Closes the template modal
         */
        function closeTemplateModal() {
            const modal = document.getElementById('templateModal');
            modal.style.opacity = '0';
            setTimeout(() => {
                modal.style.display = 'none';
            }, 200);
        }

        /**
         * Applies a validation template to the current file
         * @param {string} templateName - The template to apply (essential, quality, schema, production)
         */
        function applyTemplate(templateName) {
            const file = state.files.find(f => f.id === state.modalState.fileId);
            if (!file) return;

            // Save state for undo
            saveStateToUndoStack();

            // Define template validation sets
            const templates = {
                essential: [
                    { type: 'EmptyFileCheck', severity: 'ERROR', params: {} },
                    { type: 'RowCountRangeCheck', severity: 'ERROR', params: { min_rows: 1, max_rows: 1000000 } }
                ],
                quality: [
                    { type: 'MandatoryFieldCheck', severity: 'ERROR', params: { fields: [] } },
                    { type: 'UniqueKeyCheck', severity: 'ERROR', params: { fields: [] } },
                    { type: 'DuplicateRowCheck', severity: 'WARNING', params: {} },
                    { type: 'BlankRecordCheck', severity: 'WARNING', params: {} }
                ],
                schema: [
                    { type: 'ColumnPresenceCheck', severity: 'ERROR', params: { required_columns: [] } },
                    { type: 'SchemaMatchCheck', severity: 'ERROR', params: {} }
                ],
                production: [
                    // Essential checks
                    { type: 'EmptyFileCheck', severity: 'ERROR', params: {} },
                    { type: 'RowCountRangeCheck', severity: 'ERROR', params: { min_rows: 1, max_rows: 1000000 } },
                    // Quality checks
                    { type: 'MandatoryFieldCheck', severity: 'ERROR', params: { fields: [] } },
                    { type: 'UniqueKeyCheck', severity: 'ERROR', params: { fields: [] } },
                    { type: 'DuplicateRowCheck', severity: 'WARNING', params: {} },
                    { type: 'BlankRecordCheck', severity: 'WARNING', params: {} },
                    // Schema checks
                    { type: 'ColumnPresenceCheck', severity: 'ERROR', params: { required_columns: [] } },
                    { type: 'SchemaMatchCheck', severity: 'ERROR', params: {} }
                ]
            };

            const validations = templates[templateName];
            if (!validations) return;

            // Add all validations from template
            validations.forEach(v => {
                file.validations.push({
                    type: v.type,
                    severity: v.severity,
                    params: v.params,
                    enabled: true
                });
            });

            // Update UI
            renderContent(state.modalState.fileId);
            updateYAMLPreview();
            updateFilesNav();

            // Close modal
            closeTemplateModal();

            // Show success message
            const templateNames = {
                essential: 'Essential File Checks (2 validations)',
                quality: 'Data Quality Basics (4 validations)',
                schema: 'Schema Validation Suite (3 validations)',
                production: 'Production Ready (9 validations)'
            };
            showNotification(`‚úÖ Applied template: ${templateNames[templateName]}`);
        }

        // Project Templates Functions
        /**
         * Opens the project templates modal
         */
        function openProjectTemplatesModal() {
            const modal = document.getElementById('projectTemplatesModal');
            modal.style.display = 'flex';
            modal.offsetHeight; // Force reflow
            modal.style.opacity = '1';
        }

        /**
         * Closes the project templates modal
         */
        function closeProjectTemplatesModal() {
            const modal = document.getElementById('projectTemplatesModal');
            modal.style.opacity = '0';
            setTimeout(() => {
                modal.style.display = 'none';
            }, 200);
        }

        /**
         * Applies a project template, creating multiple files with preconfigured validations
         * @param {string} templateName - The template to apply
         */
        function applyProjectTemplate(templateName) {
            // Save state for undo
            saveStateToUndoStack();

            const templates = {
                'ecommerce': [
                    { name: 'customers', path: 'data/customers.csv', format: 'csv', validations: [
                        { type: 'EmptyFileCheck', severity: 'ERROR', params: {}, enabled: true },
                        { type: 'MandatoryFieldCheck', severity: 'ERROR', params: { fields: ['customer_id', 'email', 'name'] }, enabled: true },
                        { type: 'UniqueKeyCheck', severity: 'ERROR', params: { fields: ['customer_id'] }, enabled: true }
                    ]},
                    { name: 'products', path: 'data/products.csv', format: 'csv', validations: [
                        { type: 'EmptyFileCheck', severity: 'ERROR', params: {}, enabled: true },
                        { type: 'MandatoryFieldCheck', severity: 'ERROR', params: { fields: ['product_id', 'name', 'price'] }, enabled: true },
                        { type: 'UniqueKeyCheck', severity: 'ERROR', params: { fields: ['product_id'] }, enabled: true }
                    ]},
                    { name: 'orders', path: 'data/orders.csv', format: 'csv', validations: [
                        { type: 'EmptyFileCheck', severity: 'ERROR', params: {}, enabled: true },
                        { type: 'MandatoryFieldCheck', severity: 'ERROR', params: { fields: ['order_id', 'customer_id', 'order_date'] }, enabled: true },
                        { type: 'UniqueKeyCheck', severity: 'ERROR', params: { fields: ['order_id'] }, enabled: true }
                    ]},
                    { name: 'order_details', path: 'data/order_details.csv', format: 'csv', validations: [
                        { type: 'EmptyFileCheck', severity: 'ERROR', params: {}, enabled: true },
                        { type: 'MandatoryFieldCheck', severity: 'ERROR', params: { fields: ['order_id', 'product_id', 'quantity'] }, enabled: true }
                    ]}
                ],
                'crm': [
                    { name: 'contacts', path: 'data/contacts.csv', format: 'csv', validations: [
                        { type: 'EmptyFileCheck', severity: 'ERROR', params: {}, enabled: true },
                        { type: 'MandatoryFieldCheck', severity: 'ERROR', params: { fields: ['contact_id', 'name', 'email'] }, enabled: true },
                        { type: 'UniqueKeyCheck', severity: 'ERROR', params: { fields: ['contact_id'] }, enabled: true }
                    ]},
                    { name: 'accounts', path: 'data/accounts.csv', format: 'csv', validations: [
                        { type: 'EmptyFileCheck', severity: 'ERROR', params: {}, enabled: true },
                        { type: 'MandatoryFieldCheck', severity: 'ERROR', params: { fields: ['account_id', 'company_name'] }, enabled: true },
                        { type: 'UniqueKeyCheck', severity: 'ERROR', params: { fields: ['account_id'] }, enabled: true }
                    ]},
                    { name: 'opportunities', path: 'data/opportunities.csv', format: 'csv', validations: [
                        { type: 'EmptyFileCheck', severity: 'ERROR', params: {}, enabled: true },
                        { type: 'MandatoryFieldCheck', severity: 'ERROR', params: { fields: ['opportunity_id', 'account_id', 'amount'] }, enabled: true },
                        { type: 'UniqueKeyCheck', severity: 'ERROR', params: { fields: ['opportunity_id'] }, enabled: true }
                    ]},
                    { name: 'activities', path: 'data/activities.csv', format: 'csv', validations: [
                        { type: 'EmptyFileCheck', severity: 'ERROR', params: {}, enabled: true },
                        { type: 'MandatoryFieldCheck', severity: 'ERROR', params: { fields: ['activity_id', 'contact_id', 'date'] }, enabled: true }
                    ]}
                ],
                'warehouse': [
                    { name: 'fact_sales', path: 'data/fact_sales.csv', format: 'csv', validations: [
                        { type: 'EmptyFileCheck', severity: 'ERROR', params: {}, enabled: true },
                        { type: 'MandatoryFieldCheck', severity: 'ERROR', params: { fields: ['date_id', 'product_id', 'customer_id', 'amount'] }, enabled: true }
                    ]},
                    { name: 'dim_date', path: 'data/dim_date.csv', format: 'csv', validations: [
                        { type: 'EmptyFileCheck', severity: 'ERROR', params: {}, enabled: true },
                        { type: 'MandatoryFieldCheck', severity: 'ERROR', params: { fields: ['date_id', 'date', 'year', 'month', 'day'] }, enabled: true },
                        { type: 'UniqueKeyCheck', severity: 'ERROR', params: { fields: ['date_id'] }, enabled: true }
                    ]},
                    { name: 'dim_product', path: 'data/dim_product.csv', format: 'csv', validations: [
                        { type: 'EmptyFileCheck', severity: 'ERROR', params: {}, enabled: true },
                        { type: 'MandatoryFieldCheck', severity: 'ERROR', params: { fields: ['product_id', 'product_name', 'category'] }, enabled: true },
                        { type: 'UniqueKeyCheck', severity: 'ERROR', params: { fields: ['product_id'] }, enabled: true }
                    ]},
                    { name: 'dim_customer', path: 'data/dim_customer.csv', format: 'csv', validations: [
                        { type: 'EmptyFileCheck', severity: 'ERROR', params: {}, enabled: true },
                        { type: 'MandatoryFieldCheck', severity: 'ERROR', params: { fields: ['customer_id', 'customer_name'] }, enabled: true },
                        { type: 'UniqueKeyCheck', severity: 'ERROR', params: { fields: ['customer_id'] }, enabled: true }
                    ]},
                    { name: 'dim_location', path: 'data/dim_location.csv', format: 'csv', validations: [
                        { type: 'EmptyFileCheck', severity: 'ERROR', params: {}, enabled: true },
                        { type: 'MandatoryFieldCheck', severity: 'ERROR', params: { fields: ['location_id', 'city', 'country'] }, enabled: true },
                        { type: 'UniqueKeyCheck', severity: 'ERROR', params: { fields: ['location_id'] }, enabled: true }
                    ]}
                ],
                'master-reference': [
                    { name: 'transactions', path: 'data/transactions.csv', format: 'csv', validations: [
                        { type: 'EmptyFileCheck', severity: 'ERROR', params: {}, enabled: true },
                        { type: 'MandatoryFieldCheck', severity: 'ERROR', params: { fields: ['transaction_id', 'date', 'amount'] }, enabled: true },
                        { type: 'UniqueKeyCheck', severity: 'ERROR', params: { fields: ['transaction_id'] }, enabled: true },
                        { type: 'DuplicateRowCheck', severity: 'WARNING', params: {}, enabled: true }
                    ]},
                    { name: 'reference_data', path: 'data/reference_data.csv', format: 'csv', validations: [
                        { type: 'EmptyFileCheck', severity: 'ERROR', params: {}, enabled: true },
                        { type: 'MandatoryFieldCheck', severity: 'ERROR', params: { fields: ['code', 'description'] }, enabled: true },
                        { type: 'UniqueKeyCheck', severity: 'ERROR', params: { fields: ['code'] }, enabled: true }
                    ]}
                ]
            };

            const fileTemplates = templates[templateName];
            if (!fileTemplates) return;

            // Clear existing files if user confirms
            if (state.files.length > 0) {
                if (!confirm(`This will replace all existing files (${state.files.length}) with the ${templateName} template. Continue?`)) {
                    return;
                }
            }

            // Clear existing files
            state.files = [];

            // Create all files from template
            fileTemplates.forEach(fileTemplate => {
                const fileId = state.fileCounter++;
                state.files.push({
                    id: fileId,
                    name: fileTemplate.name,
                    path: fileTemplate.path,
                    format: fileTemplate.format,
                    validations: fileTemplate.validations
                });
            });

            // Update UI
            updateFilesNav();
            updateYAMLPreview();
            if (state.files.length > 0) {
                showSection(state.files[0].id);
            }

            // Close modal
            closeProjectTemplatesModal();

            // Show success message
            const templateInfo = {
                'ecommerce': 'E-commerce System (4 files)',
                'crm': 'CRM System (4 files)',
                'warehouse': 'Data Warehouse (5 files)',
                'master-reference': 'Master-Reference (2 files)'
            };
            showNotification(`üéØ Applied project template: ${templateInfo[templateName]}`);
        }

        // Regex Tester Functions
        /**
         * Opens the regex tester modal
         */
        function openRegexTesterModal() {
            const modal = document.getElementById('regexTesterModal');
            modal.style.display = 'flex';
            modal.offsetHeight; // Force reflow
            modal.style.opacity = '1';

            // Clear previous inputs
            document.getElementById('regexPattern').value = '';
            document.getElementById('regexTestString').value = '';
            document.getElementById('regexResults').style.display = 'none';
        }

        /**
         * Closes the regex tester modal
         */
        function closeRegexTesterModal() {
            const modal = document.getElementById('regexTesterModal');
            modal.style.opacity = '0';
            setTimeout(() => {
                modal.style.display = 'none';
            }, 200);
        }

        /**
         * Tests a regex pattern against test strings
         * Provides real-time feedback on matches
         */
        function testRegexPattern() {
            const patternInput = document.getElementById('regexPattern').value;
            const testStringInput = document.getElementById('regexTestString').value;
            const resultsDiv = document.getElementById('regexResults');
            const resultsContent = document.getElementById('regexResultsContent');

            // Hide results if either input is empty
            if (!patternInput.trim() || !testStringInput.trim()) {
                resultsDiv.style.display = 'none';
                return;
            }

            // Show results section
            resultsDiv.style.display = 'block';

            try {
                // Create regex (case-insensitive flag included)
                const regex = new RegExp(patternInput, 'i');

                // Split test string into lines
                const testStrings = testStringInput.split('\n').filter(s => s.trim() !== '');

                // Test each string
                const results = testStrings.map(str => {
                    const matches = regex.test(str);
                    return {
                        string: str,
                        matches: matches
                    };
                });

                // Count matches
                const matchCount = results.filter(r => r.matches).length;
                const totalCount = results.length;

                // Generate results HTML
                let html = `
                    <div style="margin-bottom: 16px; padding: 12px; background: var(--bg-tertiary); border-radius: 6px;">
                        <div style="font-size: 14px; color: var(--text-primary); margin-bottom: 4px;">
                            <strong>Pattern is valid!</strong>
                        </div>
                        <div style="font-size: 13px; color: var(--text-muted);">
                            Matched <strong style="color: var(--md-sys-color-primary);">${matchCount}</strong> of <strong>${totalCount}</strong> test strings
                        </div>
                    </div>
                    <div style="display: grid; gap: 6px; max-height: 200px; overflow-y: auto;">
                `;

                results.forEach(result => {
                    const icon = result.matches ? '‚úÖ' : '‚ùå';
                    const color = result.matches ? 'var(--md-sys-color-primary)' : 'var(--severity-error)';
                    html += `
                        <div style="display: flex; align-items: center; gap: 8px; padding: 8px; background: var(--bg-primary); border-radius: 4px; font-size: 13px;">
                            <span style="font-size: 16px;">${icon}</span>
                            <code style="flex: 1; color: var(--text-primary); font-family: 'Courier New', monospace;">${result.string}</code>
                            <span style="color: ${color}; font-size: 11px; font-weight: 500;">${result.matches ? 'MATCH' : 'NO MATCH'}</span>
                        </div>
                    `;
                });

                html += '</div>';
                resultsContent.innerHTML = html;

            } catch (error) {
                // Invalid regex
                resultsContent.innerHTML = `
                    <div style="padding: 12px; background: var(--bg-tertiary); border-radius: 6px; border-left: 3px solid var(--severity-error);">
                        <div style="font-size: 14px; color: var(--severity-error); margin-bottom: 4px;">
                            <strong>‚ùå Invalid Pattern</strong>
                        </div>
                        <div style="font-size: 13px; color: var(--text-muted); font-family: 'Courier New', monospace;">
                            ${error.message}
                        </div>
                    </div>
                `;
            }
        }

        // Import/Export Functions
        /**
         * Opens the import YAML modal
         */
        function openImportModal() {
            const modal = document.getElementById('importModal');
            modal.style.display = 'flex';
            modal.offsetHeight;
            modal.style.opacity = '1';
            switchImportTab('upload'); // Default to upload tab
        }

        /**
         * Closes the import modal
         */
        function closeImportModal() {
            const modal = document.getElementById('importModal');
            modal.style.opacity = '0';
            setTimeout(() => {
                modal.style.display = 'none';
                document.getElementById('yamlPasteArea').value = '';
            }, 200);
        }

        /**
         * Switches between import tabs
         * @param {string} tab - The tab to switch to ('upload' or 'paste')
         */
        function switchImportTab(tab) {
            const uploadTab = document.getElementById('uploadTab');
            const pasteTab = document.getElementById('pasteTab');
            const uploadBtn = document.getElementById('uploadTabBtn');
            const pasteBtn = document.getElementById('pasteTabBtn');

            if (tab === 'upload') {
                uploadTab.style.display = 'block';
                pasteTab.style.display = 'none';
                uploadBtn.classList.add('btn-primary');
                uploadBtn.classList.remove('btn-secondary');
                pasteBtn.classList.remove('btn-primary');
                pasteBtn.classList.add('btn-secondary');
            } else {
                uploadTab.style.display = 'none';
                pasteTab.style.display = 'block';
                uploadBtn.classList.remove('btn-primary');
                uploadBtn.classList.add('btn-secondary');
                pasteBtn.classList.add('btn-primary');
                pasteBtn.classList.remove('btn-secondary');
            }
        }

        /**
         * Handles file upload for YAML import
         * @param {Event} event - The file input change event
         */
        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    document.getElementById('yamlPasteArea').value = e.target.result;
                    switchImportTab('paste');
                };
                reader.readAsText(file);
            }
        }

        /**
         * Processes the import and loads configuration into builder
         */
        function processImport() {
            const yamlText = document.getElementById('yamlPasteArea').value.trim();
            if (!yamlText) {
                alert('Please provide YAML configuration to import');
                return;
            }

            try {
                // Parse YAML (basic parser - handles common cases)
                const config = parseYAML(yamlText);

                // Extract job name
                state.jobName = config.job_name || 'Imported Validation Job';

                // Extract settings
                if (config.settings) {
                    state.settings.chunk_size = config.settings.chunk_size || 10000;
                    state.settings.max_sample_failures = config.settings.max_sample_failures || 100;
                    state.settings.fail_fast = config.settings.fail_fast || false;
                    state.settings.log_level = config.settings.log_level || 'INFO';
                }

                // Extract files and validations
                state.files = [];
                state.fileCounter = 0;

                if (config.files && Array.isArray(config.files)) {
                    config.files.forEach(file => {
                        const fileId = state.fileCounter++;
                        const newFile = {
                            id: fileId,
                            name: file.name || 'Unnamed File',
                            path: file.path || '',
                            format: file.format || 'csv',
                            validations: []
                        };

                        // Extract validations
                        if (file.validations && Array.isArray(file.validations)) {
                            file.validations.forEach(val => {
                                newFile.validations.push({
                                    type: val.type || 'EmptyFileCheck',
                                    severity: val.severity || 'ERROR',
                                    params: val.params || {},
                                    enabled: val.enabled !== false
                                });
                            });
                        }

                        state.files.push(newFile);
                    });
                }

                // Update UI
                updateFilesNav();
                updateYAMLPreview();
                closeImportModal();
                showNotification(`‚úÖ Imported configuration with ${state.files.length} file(s)`);

                // Navigate to first file if exists
                if (state.files.length > 0) {
                    showSection(state.files[0].id);
                }
            } catch (error) {
                console.error('Import error:', error);
                alert('Failed to parse YAML configuration. Please check the format and try again.\n\nError: ' + error.message);
            }
        }

        /**
         * Basic YAML parser for validation configs
         * @param {string} yaml - YAML text
         * @returns {object} Parsed configuration
         */
        function parseYAML(yaml) {
            // Parses YAML with structure: validation_job -> name, description, files, processing
            const lines = yaml.split('\n');
            const config = {
                job_name: '',
                settings: {},
                files: []
            };

            let currentFile = null;
            let currentValidation = null;
            let currentParamKey = null;
            let currentParamArray = null;
            let inValidationJob = false;
            let inProcessing = false;
            let inFiles = false;
            let inValidations = false;
            let inParams = false;

            for (let i = 0; i < lines.length; i++) {
                const line = lines[i];
                const trimmed = line.trim();
                const indent = line.search(/\S/); // Count leading spaces

                // Skip empty lines and comments
                if (!trimmed || trimmed.startsWith('#')) continue;

                // Detect validation_job section
                if (trimmed === 'validation_job:') {
                    inValidationJob = true;
                    continue;
                }

                // If not in validation_job yet, skip
                if (!inValidationJob) continue;

                // Top-level under validation_job (indent 2)
                if (indent === 2 && trimmed.includes(':')) {
                    // Reset section flags when encountering new top-level key
                    inProcessing = false;
                    inFiles = false;

                    if (trimmed.startsWith('name:')) {
                        config.job_name = trimmed.split('name:')[1].trim().replace(/['"]/g, '');
                    } else if (trimmed.startsWith('description:')) {
                        // description is parsed but not used in config builder state
                        continue;
                    } else if (trimmed === 'files:') {
                        inFiles = true;
                    } else if (trimmed === 'processing:') {
                        inProcessing = true;
                    }
                    continue;
                }

                // Parse processing settings (indent 4)
                if (inProcessing && indent === 4 && trimmed.includes(':')) {
                    const [key, value] = trimmed.split(':').map(s => s.trim());
                    if (key === 'chunk_size' || key === 'max_sample_failures') {
                        config.settings[key] = parseInt(value);
                    } else if (key === 'fail_fast') {
                        config.settings[key] = value === 'true';
                    } else if (key === 'log_level') {
                        config.settings[key] = value.replace(/['"]/g, '');
                    }
                    continue;
                }

                // Parse files array (indent 4, starts with -)
                if (inFiles && indent === 4 && trimmed.startsWith('- name:')) {
                    if (currentFile) config.files.push(currentFile);
                    currentFile = {
                        name: trimmed.split('name:')[1].trim().replace(/['"]/g, ''),
                        validations: []
                    };
                    inValidations = false;
                    currentValidation = null;
                    continue;
                }

                // File properties (indent 6)
                if (currentFile && indent === 6 && trimmed.includes(':')) {
                    if (trimmed.startsWith('path:')) {
                        currentFile.path = trimmed.split('path:')[1].trim().replace(/['"]/g, '');
                    } else if (trimmed.startsWith('format:')) {
                        currentFile.format = trimmed.split('format:')[1].trim().replace(/['"]/g, '');
                    } else if (trimmed === 'validations:') {
                        inValidations = true;
                    }
                    continue;
                }

                // Validations array (indent 8, starts with -)
                if (inValidations && indent === 8 && trimmed.startsWith('- type:')) {
                    if (currentValidation) {
                        currentFile.validations.push(currentValidation);
                    }
                    const typeValue = trimmed.split('type:')[1].trim().replace(/['"]/g, '').split('#')[0].trim();
                    currentValidation = {
                        type: typeValue,
                        severity: 'ERROR',
                        params: {},
                        enabled: true
                    };
                    inParams = false;
                    currentParamKey = null;
                    currentParamArray = null;
                    continue;
                }

                // Validation properties (indent 10)
                if (currentValidation && indent === 10 && trimmed.includes(':')) {
                    if (trimmed.startsWith('severity:')) {
                        currentValidation.severity = trimmed.split('severity:')[1].trim().replace(/['"]/g, '');
                        inParams = false;
                    } else if (trimmed.startsWith('enabled:')) {
                        currentValidation.enabled = trimmed.split('enabled:')[1].trim() === 'true';
                        inParams = false;
                    } else if (trimmed === 'params:' || trimmed === 'params: {}') {
                        inParams = true;
                        currentParamKey = null;
                        currentParamArray = null;
                    }
                    continue;
                }

                // Param properties (indent 12)
                if (inParams && currentValidation && indent === 12 && trimmed.includes(':')) {
                    const colonIndex = trimmed.indexOf(':');
                    const key = trimmed.substring(0, colonIndex).trim();
                    const value = trimmed.substring(colonIndex + 1).trim();

                    currentParamKey = key;
                    currentParamArray = null;

                    if (value === '' || value === '[]') {
                        // Empty array or value on next line
                        currentValidation.params[key] = [];
                        currentParamArray = currentValidation.params[key];
                    } else if (value && value !== '{}') {
                        // Inline value
                        if (value === 'true' || value === 'false') {
                            currentValidation.params[key] = value === 'true';
                        } else if (!isNaN(value)) {
                            currentValidation.params[key] = parseFloat(value);
                        } else {
                            currentValidation.params[key] = value.replace(/['"]/g, '');
                        }
                    }
                    continue;
                }

                // Param array items (indent 14, starts with -)
                if (currentParamKey && indent === 14 && trimmed.startsWith('- ')) {
                    const item = trimmed.substring(2).trim().replace(/['"]/g, '');
                    if (Array.isArray(currentValidation.params[currentParamKey])) {
                        currentValidation.params[currentParamKey].push(item);
                    } else {
                        currentValidation.params[currentParamKey] = [item];
                    }
                    continue;
                }
            }

            // Push last validation and file
            if (currentValidation && currentFile) {
                currentFile.validations.push(currentValidation);
            }
            if (currentFile) {
                config.files.push(currentFile);
            }

            return config;
        }

        /**
         * Shares configuration via URL (encodes in hash)
         */
        function shareViaURL() {
            try {
                const configData = {
                    jobName: state.jobName,
                    files: state.files,
                    settings: state.settings
                };

                const encoded = btoa(JSON.stringify(configData));
                const shareURL = window.location.origin + window.location.pathname + '#config=' + encoded;

                // Copy to clipboard
                navigator.clipboard.writeText(shareURL).then(() => {
                    showNotification('‚úÖ Share URL copied to clipboard!');
                }).catch(() => {
                    // Fallback: show prompt
                    prompt('Copy this URL to share your configuration:', shareURL);
                });
            } catch (error) {
                console.error('Share error:', error);
                alert('Failed to generate share URL');
            }
        }

        /**
         * Loads configuration from URL hash if present
         */
        function loadFromURLHash() {
            const hash = window.location.hash;
            if (hash.startsWith('#config=')) {
                try {
                    const encoded = hash.substring(8);
                    const configData = JSON.parse(atob(encoded));

                    state.jobName = configData.jobName;
                    state.files = configData.files;
                    state.settings = configData.settings;
                    state.fileCounter = Math.max(...state.files.map(f => f.id)) + 1;

                    updateFilesNav();
                    updateYAMLPreview();
                    showNotification('‚úÖ Configuration loaded from shared URL');

                    // Clear hash
                    history.replaceState(null, '', window.location.pathname);
                } catch (error) {
                    console.error('Failed to load from URL:', error);
                }
            }
        }

        /**
         * Exports configuration as HTML documentation
         */
        function exportDocumentation() {
            const html = generateDocumentationHTML();
            const blob = new Blob([html], { type: 'text/html' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${state.jobName.replace(/\s+/g, '_')}_Documentation.html`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            showNotification('‚úÖ Documentation exported successfully');
        }

        /**
         * Generates HTML documentation from current configuration
         * @returns {string} HTML documentation
         */
        function generateDocumentationHTML() {
            const totalValidations = state.files.reduce((sum, f) => sum + f.validations.length, 0);
            const errorCount = state.files.reduce((sum, f) => sum + f.validations.filter(v => v.severity === 'ERROR').length, 0);
            const warningCount = totalValidations - errorCount;

            let html = `<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>${state.jobName} - Validation Documentation</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; max-width: 1200px; margin: 0 auto; padding: 40px 20px; background: #f5f5f5; color: #333; }
        h1 { color: #1a1a1a; border-bottom: 3px solid #2563eb; padding-bottom: 16px; }
        h2 { color: #2563eb; margin-top: 40px; }
        h3 { color: #374151; margin-top: 24px; }
        .summary { background: white; padding: 24px; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); margin-bottom: 32px; }
        .summary-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-top: 16px; }
        .metric { text-align: center; padding: 16px; background: #f9fafb; border-radius: 6px; }
        .metric-value { font-size: 32px; font-weight: bold; color: #2563eb; }
        .metric-label { font-size: 14px; color: #6b7280; margin-top: 4px; }
        .file-card { background: white; padding: 24px; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); margin-bottom: 24px; }
        .validation-item { padding: 16px; margin: 12px 0; background: #f9fafb; border-radius: 6px; border-left: 4px solid #2563eb; }
        .error-badge { display: inline-block; padding: 4px 12px; background: #dc2626; color: white; border-radius: 4px; font-size: 12px; font-weight: 600; }
        .warning-badge { display: inline-block; padding: 4px 12px; background: #f59e0b; color: white; border-radius: 4px; font-size: 12px; font-weight: 600; }
        .param-list { margin: 8px 0; padding-left: 20px; }
        .param-list li { margin: 4px 0; }
        code { background: #e5e7eb; padding: 2px 6px; border-radius: 3px; font-family: 'Courier New', monospace; }
    </style>
</head>
<body>
    <h1>üìã ${state.jobName}</h1>
    <div class="summary">
        <h2>Configuration Summary</h2>
        <div class="summary-grid">
            <div class="metric">
                <div class="metric-value">${state.files.length}</div>
                <div class="metric-label">Files</div>
            </div>
            <div class="metric">
                <div class="metric-value">${totalValidations}</div>
                <div class="metric-label">Total Validations</div>
            </div>
            <div class="metric">
                <div class="metric-value">${errorCount}</div>
                <div class="metric-label">Error Checks</div>
            </div>
            <div class="metric">
                <div class="metric-value">${warningCount}</div>
                <div class="metric-label">Warning Checks</div>
            </div>
        </div>
    </div>

    <h2>‚öôÔ∏è Settings</h2>
    <div class="file-card">
        <ul class="param-list">
            <li><strong>Chunk Size:</strong> ${state.settings.chunk_size.toLocaleString()} rows</li>
            <li><strong>Max Sample Failures:</strong> ${state.settings.max_sample_failures}</li>
            <li><strong>Fail Fast:</strong> ${state.settings.fail_fast ? 'Yes' : 'No'}</li>
            <li><strong>Log Level:</strong> ${state.settings.log_level}</li>
        </ul>
    </div>

    <h2>üìÅ Files and Validations</h2>
`;

            state.files.forEach(file => {
                html += `
    <div class="file-card">
        <h3>üìÑ ${file.name}</h3>
        <ul class="param-list">
            <li><strong>Path:</strong> <code>${file.path}</code></li>
            <li><strong>Format:</strong> ${file.format}</li>
            <li><strong>Validations:</strong> ${file.validations.length}</li>
        </ul>`;

                if (file.validations.length > 0) {
                    html += '<h4 style="margin-top: 24px;">Validation Rules:</h4>';
                    file.validations.forEach((val, idx) => {
                        const badge = val.severity === 'ERROR' ?
                            '<span class="error-badge">ERROR</span>' :
                            '<span class="warning-badge">WARNING</span>';
                        html += `
        <div class="validation-item">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                <strong>${idx + 1}. ${val.type}</strong>
                ${badge}
            </div>
            <div style="color: #6b7280; font-size: 14px;">
                ${getValidationDescription(val.type).replace(/<[^>]*>/g, '')}
            </div>
            ${Object.keys(val.params).length > 0 ? `
            <div style="margin-top: 12px;">
                <strong style="font-size: 13px;">Parameters:</strong>
                <ul class="param-list">
                    ${Object.entries(val.params).map(([key, value]) => `<li><code>${key}</code>: ${value}</li>`).join('')}
                </ul>
            </div>
            ` : ''}
        </div>`;
                    });
                }

                html += `
    </div>`;
            });

            html += `
    <footer style="margin-top: 48px; padding-top: 24px; border-top: 1px solid #e5e7eb; text-align: center; color: #6b7280; font-size: 14px;">
        <p>Generated by Data Validation Config Builder v3.0.0 on ${new Date().toLocaleString()}</p>
    </footer>
</body>
</html>`;

            return html;
        }

        /**
         * Duplicates a validation
         * @param {number} fileId - The file ID
         * @param {number} validationIdx - The validation index to duplicate
         */
        function duplicateValidation(fileId, validationIdx) {
            const file = state.files.find(f => f.id === fileId);
            if (file && file.validations[validationIdx]) {
                const original = file.validations[validationIdx];
                const duplicate = {
                    type: original.type,
                    severity: original.severity,
                    params: JSON.parse(JSON.stringify(original.params)), // Deep copy
                    enabled: original.enabled
                };

                // Insert duplicate right after original
                file.validations.splice(validationIdx + 1, 0, duplicate);

                // Update UI
                renderContent(fileId);
                updateYAMLPreview();
                showNotification('‚úÖ Validation duplicated');
            }
        }

        // Undo/Redo System
        /**
         * Saves current state to undo stack
         */
        function saveStateToUndoStack() {
            const stateCopy = {
                jobName: state.jobName,
                files: JSON.parse(JSON.stringify(state.files)),
                settings: JSON.parse(JSON.stringify(state.settings)),
                fileCounter: state.fileCounter
            };

            undoStack.push(stateCopy);

            // Limit stack size
            if (undoStack.length > MAX_UNDO_STACK) {
                undoStack.shift();
            }

            // Clear redo stack on new action
            redoStack.length = 0;
        }

        /**
         * Undoes the last action
         */
        function undo() {
            if (undoStack.length === 0) {
                showNotification('Nothing to undo');
                return;
            }

            // Save current state to redo stack
            const currentState = {
                jobName: state.jobName,
                files: JSON.parse(JSON.stringify(state.files)),
                settings: JSON.parse(JSON.stringify(state.settings)),
                fileCounter: state.fileCounter
            };
            redoStack.push(currentState);

            // Restore previous state
            const previousState = undoStack.pop();
            state.jobName = previousState.jobName;
            state.files = previousState.files;
            state.settings = previousState.settings;
            state.fileCounter = previousState.fileCounter;

            // Update UI
            updateFilesNav();
            updateYAMLPreview();
            renderContent(state.currentSection);
            showNotification('‚Ü©Ô∏è Undone');
        }

        /**
         * Redoes the last undone action
         */
        function redo() {
            if (redoStack.length === 0) {
                showNotification('Nothing to redo');
                return;
            }

            // Save current state to undo stack
            saveStateToUndoStack();

            // Restore next state
            const nextState = redoStack.pop();
            state.jobName = nextState.jobName;
            state.files = nextState.files;
            state.settings = nextState.settings;
            state.fileCounter = nextState.fileCounter;

            // Update UI
            updateFilesNav();
            updateYAMLPreview();
            renderContent(state.currentSection);
            showNotification('‚Ü™Ô∏è Redone');
        }

        // Keyboard Shortcuts System
        /**
         * Initializes keyboard shortcuts
         */
        function initKeyboardShortcuts() {
            document.addEventListener('keydown', (e) => {
                // Ctrl/Cmd + S: Download config
                if ((e.ctrlKey || e.metaKey) && e.key === 's') {
                    e.preventDefault();
                    downloadConfig();
                    showNotification('‚¨áÔ∏è Config downloaded (Ctrl+S)');
                }

                // Ctrl/Cmd + Z: Undo
                if ((e.ctrlKey || e.metaKey) && e.key === 'z' && !e.shiftKey) {
                    e.preventDefault();
                    undo();
                }

                // Ctrl/Cmd + Shift + Z or Ctrl/Cmd + Y: Redo
                if (((e.ctrlKey || e.metaKey) && e.key === 'z' && e.shiftKey) ||
                    ((e.ctrlKey || e.metaKey) && e.key === 'y')) {
                    e.preventDefault();
                    redo();
                }

                // Ctrl/Cmd + I: Import
                if ((e.ctrlKey || e.metaKey) && e.key === 'i') {
                    e.preventDefault();
                    openImportModal();
                    showNotification('üìÇ Import modal opened (Ctrl+I)');
                }

                // Ctrl/Cmd + E: Export documentation
                if ((e.ctrlKey || e.metaKey) && e.key === 'e') {
                    e.preventDefault();
                    exportDocumentation();
                }

                // Ctrl/Cmd + K: Share URL
                if ((e.ctrlKey || e.metaKey) && e.key === 'k') {
                    e.preventDefault();
                    shareViaURL();
                }

                // Ctrl/Cmd + /: Show keyboard shortcuts help
                if ((e.ctrlKey || e.metaKey) && e.key === '/') {
                    e.preventDefault();
                    showKeyboardShortcutsHelp();
                }

                // Escape: Close modals
                if (e.key === 'Escape') {
                    closeValidationModal();
                    closeTemplateModal();
                    closeImportModal();
                }
            });
        }

        /**
         * Shows keyboard shortcuts help modal
         */
        function showKeyboardShortcutsHelp() {
            const shortcuts = [
                { keys: 'Ctrl+S', action: 'Download configuration' },
                { keys: 'Ctrl+Z', action: 'Undo last action' },
                { keys: 'Ctrl+Shift+Z / Ctrl+Y', action: 'Redo action' },
                { keys: 'Ctrl+I', action: 'Import YAML configuration' },
                { keys: 'Ctrl+E', action: 'Export documentation' },
                { keys: 'Ctrl+K', action: 'Share via URL' },
                { keys: 'Ctrl+/', action: 'Show keyboard shortcuts' },
                { keys: 'Escape', action: 'Close modal' }
            ];

            let html = '<div style="padding: 20px;"><h3 style="margin-top: 0; color: var(--text-primary);">‚å®Ô∏è Keyboard Shortcuts</h3>';
            html += '<div style="display: grid; gap: 12px;">';

            shortcuts.forEach(sc => {
                html += `
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px; background: var(--bg-tertiary); border-radius: 8px;">
                        <span style="color: var(--text-secondary); font-size: 14px;">${sc.action}</span>
                        <kbd style="padding: 4px 8px; background: var(--bg-primary); border: 1px solid var(--border); border-radius: 4px; font-family: monospace; font-size: 12px; color: var(--text-primary);">${sc.keys}</kbd>
                    </div>
                `;
            });

            html += '</div></div>';

            // Show in temporary modal
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: var(--bg-secondary);
                border-radius: 16px;
                box-shadow: var(--md-sys-elevation-5);
                border: 1px solid var(--border);
                z-index: 10000;
                max-width: 500px;
                width: 90%;
            `;
            modal.innerHTML = html;

            document.body.appendChild(modal);

            // Close on click outside
            const backdrop = document.createElement('div');
            backdrop.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0, 0, 0, 0.5);
                z-index: 9999;
            `;
            document.body.appendChild(backdrop);

            backdrop.onclick = () => {
                modal.remove();
                backdrop.remove();
            };

            // Close after 5 seconds
            setTimeout(() => {
                if (modal.parentElement) {
                    modal.remove();
                    backdrop.remove();
                }
            }, 5000);
        }

        // Clone File Configuration
        /**
         * Clones an entire file configuration
         * @param {number} fileId - The file ID to clone
         */
        function cloneFile(fileId) {
            const file = state.files.find(f => f.id === fileId);
            if (!file) return;

            saveStateToUndoStack();

            const newFileId = state.fileCounter++;
            const clonedFile = {
                id: newFileId,
                name: file.name + ' (Copy)',
                path: file.path,
                format: file.format,
                validations: JSON.parse(JSON.stringify(file.validations)) // Deep copy
            };

            state.files.push(clonedFile);

            // Update UI
            updateFilesNav();
            updateYAMLPreview();
            showNotification('‚úÖ File configuration cloned');

            // Navigate to cloned file
            showSection(newFileId);
        }

        // Dark/Light Mode Toggle
        /**
         * Toggles between dark and light themes
         */
        function toggleTheme() {
            state.theme = state.theme === 'dark' ? 'light' : 'dark';
            localStorage.setItem('theme', state.theme);
            applyTheme(state.theme);
            showNotification(`üé® Switched to ${state.theme} mode`);
        }

        /**
         * Applies the selected theme
         * @param {string} theme - 'dark' or 'light'
         */
        function applyTheme(theme) {
            const root = document.documentElement;

            if (theme === 'light') {
                // Light theme colors
                root.style.setProperty('--md-sys-color-surface', '#FFFFFF');
                root.style.setProperty('--md-sys-color-on-surface', '#1A1C1E');
                root.style.setProperty('--md-sys-color-surface-container', '#F3F4F6');
                root.style.setProperty('--md-sys-color-surface-container-high', '#E5E7EB');
                root.style.setProperty('--md-sys-color-surface-container-highest', '#D1D5DB');
                root.style.setProperty('--md-sys-color-outline', '#9CA3AF');
                root.style.setProperty('--md-sys-color-outline-variant', '#D1D5DB');

                // Update legacy variables
                root.style.setProperty('--bg-primary', '#FFFFFF');
                root.style.setProperty('--bg-secondary', '#F9FAFB');
                root.style.setProperty('--bg-tertiary', '#F3F4F6');
                root.style.setProperty('--text-primary', '#111827');
                root.style.setProperty('--text-secondary', '#4B5563');
                root.style.setProperty('--text-muted', '#6B7280');
                root.style.setProperty('--border', '#D1D5DB');
            } else {
                // Dark theme colors (restore defaults)
                root.style.setProperty('--md-sys-color-surface', '#0F172A');
                root.style.setProperty('--md-sys-color-on-surface', '#F8FAFC');
                root.style.setProperty('--md-sys-color-surface-container', '#1E293B');
                root.style.setProperty('--md-sys-color-surface-container-high', '#334155');
                root.style.setProperty('--md-sys-color-surface-container-highest', '#475569');
                root.style.setProperty('--md-sys-color-outline', '#64748B');
                root.style.setProperty('--md-sys-color-outline-variant', '#475569');

                // Update legacy variables
                root.style.setProperty('--bg-primary', '#0F172A');
                root.style.setProperty('--bg-secondary', '#1E293B');
                root.style.setProperty('--bg-tertiary', '#334155');
                root.style.setProperty('--text-primary', '#F8FAFC');
                root.style.setProperty('--text-secondary', '#CBD5E1');
                root.style.setProperty('--text-muted', '#94A3B8');
                root.style.setProperty('--border', '#334155');
            }
        }

        // Navigation
        function showSection(section) {
            state.currentSection = section;

            // Close mobile sidebar when navigating
            if (window.innerWidth <= 768) {
                const sidebar = document.getElementById('sidebar');
                const backdrop = document.getElementById('mobileBackdrop');
                sidebar.classList.remove('mobile-visible');
                backdrop.classList.remove('show');
            }

            // Update nav items
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });
            event?.currentTarget?.classList.add('active');

            // Update breadcrumb and title
            const titles = {
                'job': 'Job Settings',
                'settings': 'Advanced Settings',
                'summary': 'Summary'
            };

            let title = titles[section];

            // If it's a file section (numeric ID), use the file name
            if (!title && !isNaN(section)) {
                const fileId = parseInt(section);
                const file = state.files.find(f => f.id === fileId);
                if (file) {
                    title = file.name;
                }
            }

            // Fallback to section value if no title found
            title = title || section;

            document.getElementById('breadcrumb').textContent = title;
            document.getElementById('pageTitle').textContent = title;

            // Render content
            renderContent(section);
            updateYAMLPreview();
        }

        function renderContent(section) {
            const content = document.getElementById('workspaceContent');

            if (section === 'job') {
                content.innerHTML = `
                    <div style="max-width: 600px;">
                        <div style="margin-bottom: 24px;">
                            <label style="display: block; margin-bottom: 8px; color: var(--text-primary); font-weight: 500;">
                                Job Name
                            </label>
                            <input
                                type="text"
                                value="${state.jobName}"
                                onchange="state.jobName = this.value; updateYAMLPreview();"
                                style="width: 100%; padding: 10px 14px; background: var(--bg-secondary); border: 1px solid var(--border); border-radius: 8px; color: var(--text-primary); font-size: 14px;">
                            <small style="display: block; margin-top: 6px; color: var(--text-muted); font-size: 13px;">
                                A descriptive name for this validation job
                            </small>
                        </div>

                        <button class="btn btn-primary" onclick="addFile()" style="margin-top: 24px;">
                            <span class="icon">‚ûï</span>
                            Add Your First File
                        </button>
                    </div>
                `;
            }  else if (section === 'settings') {
                content.innerHTML = `
                    <div style="max-width: 700px;">
                        <div style="display: grid; gap: 24px;">
                            <div>
                                <label style="display: block; margin-bottom: 8px; color: var(--text-primary); font-weight: 500;">
                                    Chunk Size
                                </label>
                                <input
                                    type="number"
                                    value="${state.settings.chunk_size}"
                                    onchange="state.settings.chunk_size = parseInt(this.value); updateYAMLPreview();"
                                    style="width: 100%; padding: 10px 14px; background: var(--bg-secondary); border: 1px solid var(--border); border-radius: 8px; color: var(--text-primary); font-size: 14px;">
                                <div style="margin-top: 8px; padding: 12px; background: var(--bg-tertiary); border-radius: 8px; border-left: 3px solid var(--color-field);">
                                    <div style="color: var(--text-primary); font-size: 13px; font-weight: 500; margin-bottom: 4px;">üí° How to Choose:</div>
                                    <div style="color: var(--text-secondary); font-size: 13px; line-height: 1.5;">
                                        <strong>Small files (&lt;100K rows):</strong> 5,000-10,000<br>
                                        <strong>Medium files (100K-1M rows):</strong> 10,000-50,000<br>
                                        <strong>Large files (&gt;1M rows):</strong> 50,000-100,000<br>
                                        <strong>Low memory systems:</strong> Use smaller chunks (1,000-5,000)<br>
                                        Larger chunks = faster processing but more memory usage.
                                    </div>
                                </div>
                            </div>

                            <div>
                                <label style="display: block; margin-bottom: 8px; color: var(--text-primary); font-weight: 500;">
                                    Max Sample Failures
                                </label>
                                <input
                                    type="number"
                                    value="${state.settings.max_sample_failures}"
                                    onchange="state.settings.max_sample_failures = parseInt(this.value); updateYAMLPreview();"
                                    style="width: 100%; padding: 10px 14px; background: var(--bg-secondary); border: 1px solid var(--border); border-radius: 8px; color: var(--text-primary); font-size: 14px;">
                                <small style="display: block; margin-top: 6px; color: var(--text-muted); font-size: 13px;">
                                    Maximum number of validation failures to report per check. Prevents overwhelming logs with thousands of similar errors. Set to 0 for unlimited.
                                </small>
                            </div>

                            <div>
                                <label style="display: block; margin-bottom: 8px; color: var(--text-primary); font-weight: 500;">
                                    Log Level
                                </label>
                                <select
                                    onchange="state.settings.log_level = this.value; updateYAMLPreview();"
                                    style="width: 100%; padding: 10px 14px; background: var(--bg-secondary); border: 1px solid var(--border); border-radius: 8px; color: var(--text-primary); font-size: 14px;">
                                    <option ${state.settings.log_level === 'DEBUG' ? 'selected' : ''}>DEBUG</option>
                                    <option ${state.settings.log_level === 'INFO' ? 'selected' : ''}>INFO</option>
                                    <option ${state.settings.log_level === 'WARNING' ? 'selected' : ''}>WARNING</option>
                                    <option ${state.settings.log_level === 'ERROR' ? 'selected' : ''}>ERROR</option>
                                </select>
                                <small style="display: block; margin-top: 6px; color: var(--text-muted); font-size: 13px;">
                                    <strong>DEBUG:</strong> Detailed diagnostic info (very verbose) | <strong>INFO:</strong> General progress updates (recommended) | <strong>WARNING:</strong> Only warnings and errors | <strong>ERROR:</strong> Only critical errors
                                </small>
                            </div>

                            <div>
                                <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                                    <input
                                        type="checkbox"
                                        ${state.settings.fail_fast ? 'checked' : ''}
                                        onchange="state.settings.fail_fast = this.checked; updateYAMLPreview();"
                                        style="width: 18px; height: 18px;">
                                    <span style="color: var(--text-primary); font-weight: 500;">Fail Fast</span>
                                </label>
                                <small style="display: block; margin-top: 6px; margin-left: 28px; color: var(--text-muted); font-size: 13px;">
                                    When enabled, validation stops immediately upon encountering the first error. Useful for quick debugging or when you need instant feedback. Disable to get a complete report of all issues.
                                </small>
                            </div>
                        </div>
                    </div>
                `;
            } else if (section === 'summary') {
                const metrics = calculateCoverageMetrics();

                content.innerHTML = `
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-bottom: 24px;">
                        <div style="background: var(--bg-secondary); padding: 20px; border-radius: 12px; border: 1px solid var(--border);">
                            <div style="font-size: 32px; font-weight: 700; color: var(--text-primary); margin-bottom: 4px;">
                                ${state.files.length}
                            </div>
                            <div style="color: var(--text-muted); font-size: 13px;">Files</div>
                        </div>
                        <div style="background: var(--bg-secondary); padding: 20px; border-radius: 12px; border: 1px solid var(--border);">
                            <div style="font-size: 32px; font-weight: 700; color: var(--text-primary); margin-bottom: 4px;">
                                ${metrics.totalValidations}
                            </div>
                            <div style="color: var(--text-muted); font-size: 13px;">Validations</div>
                        </div>
                        <div style="background: var(--bg-secondary); padding: 20px; border-radius: 12px; border: 1px solid var(--border);">
                            <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                                <span style="font-size: 20px;">üî¥</span>
                                <div>
                                    <div style="font-size: 28px; font-weight: 700; color: var(--text-primary);">
                                        ${metrics.errorCount}
                                    </div>
                                    <div style="color: var(--text-muted); font-size: 12px;">ERROR Severity</div>
                                </div>
                            </div>
                        </div>
                        <div style="background: var(--bg-secondary); padding: 20px; border-radius: 12px; border: 1px solid var(--border);">
                            <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                                <span style="font-size: 20px;">üü°</span>
                                <div>
                                    <div style="font-size: 28px; font-weight: 700; color: var(--text-primary);">
                                        ${metrics.warningCount}
                                    </div>
                                    <div style="color: var(--text-muted); font-size: 12px;">WARNING Severity</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Coverage by Category -->
                    <div style="background: var(--bg-secondary); padding: 24px; border-radius: 12px; border: 1px solid var(--border); margin-bottom: 24px;">
                        <h3 style="color: var(--text-primary); margin-bottom: 16px;">üìä Validation Coverage by Category</h3>
                        <div style="display: grid; gap: 12px;">
                            ${Object.entries(metrics.byCategory).map(([category, count]) => {
                                const percentage = metrics.totalValidations > 0 ? Math.round((count / metrics.totalValidations) * 100) : 0;
                                const categoryNames = {
                                    'file-check': 'üì¶ File Checks',
                                    'schema-check': 'üîç Schema Checks',
                                    'field-check': '‚úì Field Checks',
                                    'record-check': 'üìä Record Checks',
                                    'cross-file-check': 'üîó Cross-File Checks',
                                    'statistical-check': 'üìà Statistical Checks'
                                };
                                return `
                                    <div style="display: flex; align-items: center; gap: 12px;">
                                        <div style="flex: 0 0 140px; color: var(--text-secondary); font-size: 13px;">
                                            ${categoryNames[category] || category}
                                        </div>
                                        <div style="flex: 1; background: var(--bg-tertiary); height: 24px; border-radius: 12px; overflow: hidden; position: relative;">
                                            <div style="background: var(--md-sys-color-primary); height: 100%; width: ${percentage}%; transition: width 0.3s ease;"></div>
                                            <div style="position: absolute; top: 0; left: 0; right: 0; bottom: 0; display: flex; align-items: center; justify-content: center; font-size: 11px; color: var(--text-primary); font-weight: 500;">
                                                ${count} (${percentage}%)
                                            </div>
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>

                    <!-- Files Breakdown -->
                    <div style="background: var(--bg-secondary); padding: 24px; border-radius: 12px; border: 1px solid var(--border); margin-bottom: 24px;">
                        <h3 style="color: var(--text-primary); margin-bottom: 16px;">üìÅ Files Breakdown</h3>
                        ${metrics.filesWithoutValidations.length > 0 ? `
                            <div style="padding: 12px; background: var(--bg-tertiary); border-radius: 8px; border-left: 3px solid var(--severity-warning); margin-bottom: 16px;">
                                <div style="color: var(--severity-warning); font-weight: 500; font-size: 13px; margin-bottom: 8px;">
                                    ‚ö†Ô∏è Files Without Validations (${metrics.filesWithoutValidations.length})
                                </div>
                                <ul style="margin: 0; padding-left: 20px; font-size: 13px; color: var(--text-muted); line-height: 1.8;">
                                    ${metrics.filesWithoutValidations.map(f => `<li>${f}</li>`).join('')}
                                </ul>
                            </div>
                        ` : ''}
                        <div style="display: grid; gap: 8px; font-size: 14px;">
                            ${metrics.filesCoverage.slice(0, 10).map(f => `
                                <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid var(--border);">
                                    <span style="color: var(--text-primary);">${f.name}</span>
                                    <span style="color: var(--md-sys-color-primary); font-weight: 500;">${f.count} validation${f.count === 1 ? '' : 's'}</span>
                                </div>
                            `).join('')}
                        </div>
                    </div>

                    <!-- Recommendations -->
                    ${(() => {
                        const recommendations = generateRecommendations();
                        if (recommendations.length === 0) return '';

                        return `
                            <div style="background: var(--bg-secondary); padding: 24px; border-radius: 12px; border: 1px solid var(--border); margin-bottom: 24px;">
                                <h3 style="color: var(--text-primary); margin-bottom: 16px;">üí° Recommendations</h3>
                                <div style="display: grid; gap: 12px;">
                                    ${recommendations.map(rec => `
                                        <div style="padding: 12px; background: var(--bg-tertiary); border-radius: 8px; border-left: 3px solid ${rec.priority === 'high' ? 'var(--severity-error)' : 'var(--md-sys-color-primary)'};">
                                            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 8px;">
                                                <div style="flex: 1;">
                                                    <div style="color: var(--text-primary); font-weight: 500; font-size: 14px; margin-bottom: 4px;">
                                                        ${rec.title}
                                                    </div>
                                                    <div style="color: var(--text-muted); font-size: 13px; line-height: 1.5;">
                                                        ${rec.description}
                                                    </div>
                                                </div>
                                                ${rec.action ? `
                                                    <button
                                                        class="btn btn-secondary btn-sm"
                                                        onclick="${rec.action}"
                                                        style="margin-left: 12px; white-space: nowrap;">
                                                        ${rec.actionLabel}
                                                    </button>
                                                ` : ''}
                                            </div>
                                            <div style="font-size: 11px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px;">
                                                ${rec.priority === 'high' ? 'üî¥ High Priority' : 'üü° Recommended'}
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        `;
                    })()}

                    <!-- Conflicts Detector -->
                    ${(() => {
                        const conflicts = detectValidationConflicts();
                        if (conflicts.length === 0) return '';

                        return `
                            <div style="background: var(--bg-secondary); padding: 24px; border-radius: 12px; border: 1px solid var(--border); margin-bottom: 24px;">
                                <h3 style="color: var(--text-primary); margin-bottom: 16px;">‚ö†Ô∏è Potential Issues</h3>
                                <div style="display: grid; gap: 12px;">
                                    ${conflicts.map(conflict => `
                                        <div style="padding: 12px; background: var(--bg-tertiary); border-radius: 8px; border-left: 3px solid var(--severity-warning);">
                                            <div style="color: var(--text-primary); font-weight: 500; font-size: 14px; margin-bottom: 4px;">
                                                ${conflict.title}
                                            </div>
                                            <div style="color: var(--text-muted); font-size: 13px; line-height: 1.5; margin-bottom: 8px;">
                                                ${conflict.description}
                                            </div>
                                            <div style="font-size: 11px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px;">
                                                ${conflict.type === 'duplicate' ? 'üìã Duplicate' : conflict.type === 'redundant' ? 'üîÑ Redundant' : '‚ö†Ô∏è Warning'}
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        `;
                    })()}

                    <!-- Configuration Summary -->
                    <div style="background: var(--bg-secondary); padding: 24px; border-radius: 12px; border: 1px solid var(--border);">
                        <h3 style="color: var(--text-primary); margin-bottom: 16px;">‚öôÔ∏è Configuration Settings</h3>
                        <div style="display: grid; gap: 12px; font-size: 14px;">
                            <div style="display: flex; justify-content: space-between;">
                                <span style="color: var(--text-muted);">Job Name:</span>
                                <span style="color: var(--text-primary); font-weight: 500;">${state.jobName}</span>
                            </div>
                            <div style="display: flex; justify-content: space-between;">
                                <span style="color: var(--text-muted);">Chunk Size:</span>
                                <span style="color: var(--text-primary); font-weight: 500;">${state.settings.chunk_size}</span>
                            </div>
                            <div style="display: flex; justify-content: space-between;">
                                <span style="color: var(--text-muted);">Log Level:</span>
                                <span style="color: var(--text-primary); font-weight: 500;">${state.settings.log_level}</span>
                            </div>
                            <div style="display: flex; justify-content: space-between;">
                                <span style="color: var(--text-muted);">Fail Fast:</span>
                                <span style="color: var(--text-primary); font-weight: 500;">${state.settings.fail_fast ? 'Yes' : 'No'}</span>
                            </div>
                        </div>
                    </div>
                `;
            } else {
                // File view
                const fileId = parseInt(section);
                const file = state.files.find(f => f.id === fileId);
                if (!file) return;

                content.innerHTML = `
                    <div style="max-width: 800px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                            <div></div>
                            <div style="display: flex; gap: 8px;">
                                <button class="btn btn-secondary" onclick="cloneFile(${fileId})" title="Clone this file configuration">
                                    <span class="icon">üìë</span>
                                    <span>Clone File</span>
                                </button>
                                <button class="btn btn-danger" onclick="removeFile(${fileId})" title="Delete this file">
                                    <span class="icon">üóëÔ∏è</span>
                                    <span>Delete File</span>
                                </button>
                            </div>
                        </div>
                        <div style="background: var(--bg-secondary); padding: 20px; border-radius: 12px; border: 1px solid var(--border); margin-bottom: 24px;">
                            <div style="display: grid; gap: 16px;">
                                <div>
                                    <label style="display: block; margin-bottom: 8px; color: var(--text-primary); font-weight: 500;">
                                        File Name
                                    </label>
                                    <input
                                        type="text"
                                        value="${file.name}"
                                        onchange="updateFile(${fileId}, 'name', this.value);"
                                        placeholder="customers"
                                        style="width: 100%; padding: 10px 14px; background: var(--bg-primary); border: 1px solid var(--border); border-radius: 8px; color: var(--text-primary); font-size: 14px;">
                                    <small style="display: block; margin-top: 6px; color: var(--text-muted); font-size: 13px;">
                                        A friendly label to identify this file (e.g., "customers", "transactions"). This appears in reports and logs.
                                    </small>
                                </div>
                                <div>
                                    <label style="display: block; margin-bottom: 8px; color: var(--text-primary); font-weight: 500;">
                                        File Path
                                    </label>
                                    <input
                                        type="text"
                                        value="${file.path}"
                                        onchange="updateFile(${fileId}, 'path', this.value);"
                                        placeholder="data/customers.csv"
                                        style="width: 100%; padding: 10px 14px; background: var(--bg-primary); border: 1px solid var(--border); border-radius: 8px; color: var(--text-primary); font-size: 14px;">
                                    <small style="display: block; margin-top: 6px; color: var(--text-muted); font-size: 13px;">
                                        The actual file system path where the file is located (relative or absolute path).
                                    </small>
                                </div>
                                <div>
                                    <label style="display: block; margin-bottom: 8px; color: var(--text-primary); font-weight: 500;">
                                        Format
                                    </label>
                                    <select
                                        onchange="updateFile(${fileId}, 'format', this.value);"
                                        style="width: 100%; padding: 10px 14px; background: var(--bg-primary); border: 1px solid var(--border); border-radius: 8px; color: var(--text-primary); font-size: 14px;">
                                        <option ${file.format === 'csv' ? 'selected' : ''}>csv</option>
                                        <option ${file.format === 'excel' ? 'selected' : ''}>excel</option>
                                        <option ${file.format === 'json' ? 'selected' : ''}>json</option>
                                        <option ${file.format === 'parquet' ? 'selected' : ''}>parquet</option>
                                    </select>
                                    <small style="display: block; margin-top: 6px; color: var(--text-muted); font-size: 13px;">
                                        <strong>csv:</strong> Comma-separated values (.csv) | <strong>excel:</strong> Excel workbooks (.xlsx, .xls) | <strong>json:</strong> JSON files (.json) | <strong>parquet:</strong> Columnar format (.parquet)
                                    </small>
                                </div>
                            </div>
                        </div>

                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; margin-top: 24px;">
                            <h3 style="color: var(--text-primary); font-size: 18px;">Validations</h3>
                            <div style="display: flex; gap: 8px;">
                                <button class="btn btn-secondary" onclick="openTemplateModal(${fileId})" title="Use validation template">
                                    <span class="icon">üìã</span>
                                    <span>Use Template</span>
                                </button>
                                <button class="btn btn-primary" onclick="addValidation(${fileId})">
                                    <span class="icon">‚ûï</span>
                                    <span>Add Validation</span>
                                </button>
                            </div>
                        </div>

                        ${file.validations.length > 0 ? `
                        <div style="margin-bottom: 16px;">
                            <div style="position: relative;">
                                <input
                                    type="text"
                                    id="search-${fileId}"
                                    placeholder="üîç Search validations (type, severity, parameters, notes)..."
                                    value="${state.searchQuery[fileId] || ''}"
                                    oninput="filterValidations(${fileId}, this.value)"
                                    style="width: 100%; padding: 12px 14px 12px 40px; background: var(--bg-primary); border: 1px solid var(--border); border-radius: 8px; color: var(--text-primary); font-size: 14px; transition: border-color 0.2s;">
                                <span style="position: absolute; left: 14px; top: 50%; transform: translateY(-50%); font-size: 16px; pointer-events: none;">üîç</span>
                                ${state.searchQuery[fileId] ? `
                                <button
                                    onclick="clearSearch(${fileId})"
                                    style="position: absolute; right: 12px; top: 50%; transform: translateY(-50%); background: none; border: none; color: var(--text-muted); cursor: pointer; font-size: 18px; padding: 4px 8px; border-radius: 4px; transition: all 0.2s;"
                                    onmouseover="this.style.background='var(--bg-hover)'; this.style.color='var(--text-primary)'"
                                    onmouseout="this.style.background='none'; this.style.color='var(--text-muted)'"
                                    title="Clear search">
                                    ‚úï
                                </button>
                                ` : ''}
                            </div>
                        </div>
                        ` : ''}

                        ${(() => {
                            const filtered = filterValidationsBySearch(file.validations, state.searchQuery[fileId] || '');
                            const hasSearch = state.searchQuery[fileId] && state.searchQuery[fileId].trim() !== '';
                            const showCount = hasSearch && file.validations.length > 0;

                            return `
                                ${showCount ? `
                                <div style="margin-bottom: 12px; padding: 8px 12px; background: var(--bg-secondary); border-radius: 8px; color: var(--text-muted); font-size: 13px; display: flex; justify-content: space-between; align-items: center;">
                                    <span>
                                        ${filtered.length === file.validations.length
                                            ? `Showing all <strong style="color: var(--text-primary);">${file.validations.length}</strong> validation${file.validations.length === 1 ? '' : 's'}`
                                            : `Found <strong style="color: var(--md-sys-color-primary);">${filtered.length}</strong> of <strong style="color: var(--text-primary);">${file.validations.length}</strong> validation${file.validations.length === 1 ? '' : 's'}`
                                        }
                                    </span>
                                    ${filtered.length < file.validations.length ? `<span style="color: var(--md-sys-color-primary);">üîç Filtered results</span>` : ''}
                                </div>
                                ` : ''}

                                <div class="validation-grid">
                                    ${filtered.map((result, idx) => renderValidationCard(fileId, result.validation, result.originalIdx, result.highlight)).join('')}
                                    ${filtered.length === 0 && hasSearch ? `
                                        <div style="padding: 60px 20px; text-align: center; color: var(--text-muted); background: var(--bg-secondary); border-radius: 12px; border: 2px dashed var(--border);">
                                            <div style="font-size: 48px; margin-bottom: 16px;">üîç</div>
                                            <div style="font-size: 16px; font-weight: 500; color: var(--text-primary); margin-bottom: 8px;">
                                                No validations found
                                            </div>
                                            <div style="font-size: 14px;">
                                                No validations match "<strong style="color: var(--md-sys-color-primary);">${state.searchQuery[fileId]}</strong>"
                                            </div>
                                            <button
                                                onclick="clearSearch(${fileId})"
                                                class="btn btn-secondary"
                                                style="margin-top: 20px;">
                                                Clear Search
                                            </button>
                                        </div>
                                    ` : ''}
                            `;
                        })()}
                            ${file.validations.length === 0 ? `
                                <div class="add-card" onclick="addValidation(${fileId})">
                                    <div class="add-card-icon">‚ûï</div>
                                    <div class="add-card-text">Add your first validation</div>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                `;
            }
        }

        /**
         * Renders an editable validation card with severity selector and parameter inputs
         * @param {number} fileId - The file ID
         * @param {object} validation - The validation object
         * @param {number} idx - The validation index
         * @param {boolean} highlight - Whether to highlight this card (search result)
         * @returns {string} HTML string for the validation card
         */
        function renderValidationCard(fileId, validation, idx, highlight = false) {
            const categoryClass = getValidationCategory(validation.type);
            const params = validation.params || {};

            // Get the file to determine total validations count
            const file = state.files.find(f => f.id === fileId);
            const totalValidations = file ? file.validations.length : 0;
            const isFirst = idx === 0;
            const isLast = idx === totalValidations - 1;

            const highlightStyle = highlight ? 'box-shadow: 0 0 0 2px var(--md-sys-color-primary); animation: highlight-pulse 0.3s ease-out;' : '';

            return `
                <div class="validation-card ${categoryClass}" style="${highlightStyle}">
                    <div class="card-header">
                        <div class="validation-info">
                            <span class="validation-icon">${getValidationIcon(validation.type)}</span>
                            <span class="validation-name">${validation.type}</span>
                        </div>
                        <div class="card-actions" style="display: flex; gap: 4px;">
                            <button
                                class="btn btn-secondary btn-icon"
                                onclick="moveValidationUp(${fileId}, ${idx})"
                                title="Move Up"
                                ${isFirst ? 'disabled style="opacity: 0.3; cursor: not-allowed;"' : ''}>
                                <span>‚¨ÜÔ∏è</span>
                            </button>
                            <button
                                class="btn btn-secondary btn-icon"
                                onclick="moveValidationDown(${fileId}, ${idx})"
                                title="Move Down"
                                ${isLast ? 'disabled style="opacity: 0.3; cursor: not-allowed;"' : ''}>
                                <span>‚¨áÔ∏è</span>
                            </button>
                            <button class="btn btn-secondary btn-icon" onclick="duplicateValidation(${fileId}, ${idx})" title="Duplicate">
                                <span>üìã</span>
                            </button>
                            <button class="btn btn-secondary btn-icon" onclick="removeValidation(${fileId}, ${idx})" title="Remove">
                                <span>üóëÔ∏è</span>
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div style="margin-bottom: 16px; color: var(--text-muted); font-size: 13px;">
                            ${getValidationDescription(validation.type)}
                        </div>

                        <!-- Severity Selector -->
                        <div style="margin-bottom: 16px;">
                            <label style="display: block; margin-bottom: 8px; color: var(--text-primary); font-weight: 500; font-size: 13px;">
                                Severity
                            </label>
                            <select
                                onchange="updateValidationSeverity(${fileId}, ${idx}, this.value)"
                                style="width: 100%; padding: 8px 12px; background: var(--bg-primary); border: 1px solid var(--border); border-radius: 6px; color: var(--text-primary); font-size: 13px;">
                                <option value="ERROR" ${validation.severity === 'ERROR' ? 'selected' : ''}>üî¥ ERROR - Stop processing</option>
                                <option value="WARNING" ${validation.severity === 'WARNING' ? 'selected' : ''}>üü° WARNING - Continue processing</option>
                            </select>
                            <small style="display: block; margin-top: 6px; color: var(--text-muted); font-size: 12px;">
                                <strong>ERROR:</strong> Critical - validation job fails immediately | <strong>WARNING:</strong> Non-critical - logged but processing continues
                            </small>
                        </div>

                        <!-- Parameters Section -->
                        ${renderValidationParameters(fileId, idx, validation.type, params)}

                        <!-- Notes/Comments Section -->
                        <div style="margin-top: 20px; padding-top: 16px; border-top: 1px solid var(--border);">
                            <label style="display: block; margin-bottom: 8px; color: var(--text-primary); font-weight: 500; font-size: 13px;">
                                üìù Notes
                            </label>
                            <textarea
                                placeholder="Add notes or comments about this validation (e.g., why it's needed, business context, edge cases)..."
                                onchange="updateValidationNote(${fileId}, ${idx}, this.value)"
                                style="width: 100%; min-height: 60px; padding: 10px 12px; background: var(--bg-primary); border: 1px solid var(--border); border-radius: 6px; color: var(--text-primary); font-size: 13px; font-family: inherit; resize: vertical;">${validation.note || ''}</textarea>
                            <small style="display: block; margin-top: 6px; color: var(--text-muted); font-size: 12px;">
                                Optional documentation for team members. Exported as YAML comments.
                            </small>
                        </div>
                    </div>
                </div>
            `;
        }

        /**
         * Renders parameter inputs based on validation type
         * @param {number} fileId - The file ID
         * @param {number} validationIdx - The validation index
         * @param {string} validationType - The validation type
         * @param {object} params - Current parameters
         * @returns {string} HTML string for parameter inputs
         */
        function renderValidationParameters(fileId, validationIdx, validationType, params) {
            // Define parameter configurations for each validation type
            const paramConfigs = {
                'MandatoryFieldCheck': [
                    { name: 'fields', label: 'Required Fields', type: 'list', placeholder: 'customer_id, email, name' }
                ],
                'RegexCheck': [
                    { name: 'field', label: 'Field Name', type: 'text', placeholder: 'email' },
                    { name: 'pattern', label: 'Regex Pattern', type: 'text', placeholder: '^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\\.[a-zA-Z]{2,}$' }
                ],
                'ValidValuesCheck': [
                    { name: 'field', label: 'Field Name', type: 'text', placeholder: 'status' },
                    { name: 'valid_values', label: 'Valid Values', type: 'list', placeholder: 'active, inactive, pending' }
                ],
                'RangeCheck': [
                    { name: 'field', label: 'Field Name', type: 'text', placeholder: 'age' },
                    { name: 'min', label: 'Minimum Value', type: 'number', placeholder: '0' },
                    { name: 'max', label: 'Maximum Value', type: 'number', placeholder: '120' }
                ],
                'DateFormatCheck': [
                    { name: 'field', label: 'Field Name', type: 'text', placeholder: 'created_date' },
                    { name: 'format', label: 'Date Format', type: 'text', placeholder: '%Y-%m-%d' }
                ],
                'StringLengthCheck': [
                    { name: 'field', label: 'Field Name', type: 'text', placeholder: 'description' },
                    { name: 'min_length', label: 'Minimum Length', type: 'number', placeholder: '1' },
                    { name: 'max_length', label: 'Maximum Length', type: 'number', placeholder: '255' }
                ],
                'ColumnPresenceCheck': [
                    { name: 'required_columns', label: 'Required Columns', type: 'list', placeholder: 'id, name, email' }
                ],
                'UniqueKeyCheck': [
                    { name: 'fields', label: 'Key Fields', type: 'list', placeholder: 'customer_id' }
                ],
                'RowCountRangeCheck': [
                    { name: 'min_rows', label: 'Minimum Rows', type: 'number', placeholder: '1' },
                    { name: 'max_rows', label: 'Maximum Rows', type: 'number', placeholder: '1000000' }
                ],
                'DuplicateRowCheck': [
                    { name: 'subset', label: 'Columns to Check (optional)', type: 'list', placeholder: 'email, phone' }
                ],
                'CompletenessCheck': [
                    { name: 'field', label: 'Field Name', type: 'text', placeholder: 'email' },
                    { name: 'min_completeness', label: 'Minimum Completeness %', type: 'number', placeholder: '95' }
                ],
                'ReferentialIntegrityCheck': [
                    { name: 'reference_file', label: 'Reference File', type: 'text', placeholder: 'customers.csv' },
                    { name: 'foreign_key', label: 'Foreign Key Field', type: 'text', placeholder: 'customer_id' },
                    { name: 'reference_key', label: 'Reference Key Field', type: 'text', placeholder: 'id' }
                ]
            };

            const configs = paramConfigs[validationType] || [];

            if (configs.length === 0) {
                return '<div style="color: var(--text-muted); font-size: 12px; font-style: italic;">No additional parameters required</div>';
            }

            return `
                <div style="border-top: 1px solid var(--border); padding-top: 16px;">
                    <div style="font-weight: 500; color: var(--text-primary); margin-bottom: 12px; font-size: 13px;">
                        Parameters
                    </div>
                    ${configs.map(config => {
                        const value = params[config.name] || '';
                        const displayValue = Array.isArray(value) ? value.join(', ') : value;

                        if (config.type === 'list') {
                            return `
                                <div style="margin-bottom: 12px;">
                                    <label style="display: block; margin-bottom: 6px; color: var(--text-secondary); font-size: 12px;">
                                        ${config.label}
                                    </label>
                                    <input
                                        type="text"
                                        value="${displayValue}"
                                        placeholder="${config.placeholder}"
                                        onchange="updateValidationParam(${fileId}, ${validationIdx}, '${config.name}', this.value.split(',').map(s => s.trim()).filter(s => s))"
                                        style="width: 100%; padding: 8px 12px; background: var(--bg-primary); border: 1px solid var(--border); border-radius: 6px; color: var(--text-primary); font-size: 13px;">
                                    <small style="display: block; margin-top: 4px; color: var(--text-muted); font-size: 11px;">
                                        Comma-separated values
                                    </small>
                                </div>
                            `;
                        } else if (config.type === 'number') {
                            return `
                                <div style="margin-bottom: 12px;">
                                    <label style="display: block; margin-bottom: 6px; color: var(--text-secondary); font-size: 12px;">
                                        ${config.label}
                                    </label>
                                    <input
                                        type="number"
                                        value="${displayValue}"
                                        placeholder="${config.placeholder}"
                                        onchange="updateValidationParam(${fileId}, ${validationIdx}, '${config.name}', parseFloat(this.value))"
                                        style="width: 100%; padding: 8px 12px; background: var(--bg-primary); border: 1px solid var(--border); border-radius: 6px; color: var(--text-primary); font-size: 13px;">
                                </div>
                            `;
                        } else {
                            // Check if this is a field name parameter (for autocomplete)
                            const isFieldParam = config.name.toLowerCase().includes('field') ||
                                               config.name.toLowerCase().includes('column');
                            const datalistId = isFieldParam ? `field-names-${fileId}-${validationIdx}` : '';

                            return `
                                <div style="margin-bottom: 12px;">
                                    <label style="display: block; margin-bottom: 6px; color: var(--text-secondary); font-size: 12px;">
                                        ${config.label}${isFieldParam ? ' <span style="color: var(--md-sys-color-primary); font-size: 11px;">‚ö° Autocomplete</span>' : ''}
                                    </label>
                                    <input
                                        type="text"
                                        value="${displayValue}"
                                        placeholder="${config.placeholder}"
                                        ${isFieldParam ? `list="${datalistId}"` : ''}
                                        onchange="updateValidationParam(${fileId}, ${validationIdx}, '${config.name}', this.value)"
                                        style="width: 100%; padding: 8px 12px; background: var(--bg-primary); border: 1px solid var(--border); border-radius: 6px; color: var(--text-primary); font-size: 13px;">
                                    ${isFieldParam ? `
                                    <datalist id="${datalistId}">
                                        ${getAllFieldNames().map(fieldName => `<option value="${fieldName}">`).join('')}
                                    </datalist>
                                    ` : ''}
                                </div>
                            `;
                        }
                    }).join('')}
                </div>
            `;
        }

        /**
         * Detects validation conflicts and potential issues
         * Identifies duplicates, redundancies, and problematic configurations
         * @returns {Array} Array of conflict objects
         */
        function detectValidationConflicts() {
            const conflicts = [];

            state.files.forEach(file => {
                // Detect duplicate validations (same type multiple times)
                const validationCounts = {};
                file.validations.forEach((v, idx) => {
                    if (!validationCounts[v.type]) {
                        validationCounts[v.type] = [];
                    }
                    validationCounts[v.type].push(idx);
                });

                Object.entries(validationCounts).forEach(([type, indices]) => {
                    if (indices.length > 1) {
                        conflicts.push({
                            title: `Duplicate ${type} in "${file.name}"`,
                            description: `This validation appears ${indices.length} times. Consider consolidating into a single validation or removing duplicates.`,
                            type: 'duplicate',
                            fileId: file.id
                        });
                    }
                });

                // Detect redundant validation combinations would go here if needed

                // Detect EmptyFileCheck with RowCountRangeCheck conflict
                const emptyFileCheck = file.validations.find(v => v.type === 'EmptyFileCheck');
                const rowCountCheck = file.validations.find(v => v.type === 'RowCountRangeCheck');
                if (emptyFileCheck && rowCountCheck) {
                    const minRows = rowCountCheck.params?.min_rows;
                    if (minRows && minRows > 0) {
                        conflicts.push({
                            title: `Potential conflict in "${file.name}"`,
                            description: `EmptyFileCheck may be redundant since RowCountRangeCheck requires min_rows=${minRows}. Files with 0 rows will fail both checks.`,
                            type: 'redundant',
                            fileId: file.id
                        });
                    }
                }

                // Detect UniqueKeyCheck without fields
                const uniqueKeyCheck = file.validations.find(v => v.type === 'UniqueKeyCheck');
                if (uniqueKeyCheck && (!uniqueKeyCheck.params?.fields || uniqueKeyCheck.params.fields.length === 0)) {
                    conflicts.push({
                        title: `UniqueKeyCheck missing parameters in "${file.name}"`,
                        description: 'UniqueKeyCheck requires fields to be specified. Add the fields that should be unique.',
                        type: 'warning',
                        fileId: file.id
                    });
                }

                // Detect MandatoryFieldCheck without fields
                const mandatoryFieldCheck = file.validations.find(v => v.type === 'MandatoryFieldCheck');
                if (mandatoryFieldCheck && (!mandatoryFieldCheck.params?.fields || mandatoryFieldCheck.params.fields.length === 0)) {
                    conflicts.push({
                        title: `MandatoryFieldCheck missing parameters in "${file.name}"`,
                        description: 'MandatoryFieldCheck requires fields to be specified. Add the mandatory field names.',
                        type: 'warning',
                        fileId: file.id
                    });
                }

                // Detect RangeCheck with inverted min/max
                const rangeChecks = file.validations.filter(v => v.type === 'RangeCheck');
                rangeChecks.forEach(check => {
                    const min = check.params?.min;
                    const max = check.params?.max;
                    if (min !== undefined && max !== undefined && min > max) {
                        conflicts.push({
                            title: `Invalid RangeCheck in "${file.name}"`,
                            description: `RangeCheck has min (${min}) greater than max (${max}). This will always fail. Swap the values.`,
                            type: 'warning',
                            fileId: file.id
                        });
                    }
                });
            });

            // Limit to top 10 issues
            return conflicts.slice(0, 10);
        }

        /**
         * Generates intelligent recommendations based on current configuration
         * Analyzes files and validations to suggest improvements
         * @returns {Array} Array of recommendation objects
         */
        function generateRecommendations() {
            const recommendations = [];

            state.files.forEach(file => {
                const hasEmptyFileCheck = file.validations.some(v => v.type === 'EmptyFileCheck');
                const hasMandatoryFieldCheck = file.validations.some(v => v.type === 'MandatoryFieldCheck');
                const hasUniqueKeyCheck = file.validations.some(v => v.type === 'UniqueKeyCheck');
                const hasSchemaCheck = file.validations.some(v =>
                    v.type === 'ColumnPresenceCheck' || v.type === 'SchemaMatchCheck');

                // High priority: Files without any validations
                if (file.validations.length === 0) {
                    recommendations.push({
                        title: `File "${file.name}" has no validations`,
                        description: 'Every file should have at least basic validation checks to ensure data quality.',
                        priority: 'high',
                        action: `openTemplateModal(${file.id})`,
                        actionLabel: 'Add Template'
                    });
                }

                // High priority: Missing EmptyFileCheck
                if (file.validations.length > 0 && !hasEmptyFileCheck) {
                    recommendations.push({
                        title: `Add EmptyFileCheck to "${file.name}"`,
                        description: 'EmptyFileCheck prevents processing files with no data, saving time and resources.',
                        priority: 'high',
                        action: `addValidationToFile(${file.id}, 'EmptyFileCheck')`,
                        actionLabel: 'Add Check'
                    });
                }

                // Medium priority: Missing MandatoryFieldCheck
                if (file.validations.length > 0 && !hasMandatoryFieldCheck) {
                    recommendations.push({
                        title: `Consider MandatoryFieldCheck for "${file.name}"`,
                        description: 'Ensures critical fields are always populated, preventing downstream errors.',
                        priority: 'medium',
                        action: `addValidationToFile(${file.id}, 'MandatoryFieldCheck')`,
                        actionLabel: 'Add Check'
                    });
                }

                // Medium priority: Missing UniqueKeyCheck
                if (file.validations.length > 1 && !hasUniqueKeyCheck) {
                    recommendations.push({
                        title: `Consider UniqueKeyCheck for "${file.name}"`,
                        description: 'Validates primary key uniqueness to prevent duplicate records and data integrity issues.',
                        priority: 'medium',
                        action: `addValidationToFile(${file.id}, 'UniqueKeyCheck')`,
                        actionLabel: 'Add Check'
                    });
                }

                // Medium priority: Missing schema validation
                if (file.validations.length > 2 && !hasSchemaCheck) {
                    recommendations.push({
                        title: `Consider schema validation for "${file.name}"`,
                        description: 'Schema checks ensure data structure compliance and catch format changes early.',
                        priority: 'medium',
                        action: `addValidationToFile(${file.id}, 'ColumnPresenceCheck')`,
                        actionLabel: 'Add Check'
                    });
                }
            });

            // Overall recommendations
            if (state.files.length === 0) {
                recommendations.push({
                    title: 'No files configured',
                    description: 'Start by adding files to validate or use a project template for common scenarios.',
                    priority: 'high',
                    action: 'openProjectTemplatesModal()',
                    actionLabel: 'Use Template'
                });
            }

            // Limit to top 5 recommendations
            return recommendations.slice(0, 5);
        }

        /**
         * Adds a validation to a specific file (helper for recommendations)
         * @param {number} fileId - The file ID
         * @param {string} validationType - The validation type to add
         */
        function addValidationToFile(fileId, validationType) {
            const file = state.files.find(f => f.id === fileId);
            if (!file) return;

            // Save state for undo
            saveStateToUndoStack();

            // Add the validation
            file.validations.push({
                type: validationType,
                severity: 'ERROR',
                params: {},
                enabled: true
            });

            // Update UI
            updateFilesNav();
            updateYAMLPreview();
            showSection(fileId);
            showNotification(`‚úÖ Added ${validationType} to ${file.name}`);
        }

        /**
         * Calculates comprehensive coverage metrics for the dashboard
         * @returns {object} Metrics object with detailed coverage data
         */
        function calculateCoverageMetrics() {
            const totalValidations = state.files.reduce((sum, f) => sum + f.validations.length, 0);
            const errorCount = state.files.reduce((sum, f) =>
                sum + f.validations.filter(v => v.severity === 'ERROR').length, 0);
            const warningCount = state.files.reduce((sum, f) =>
                sum + f.validations.filter(v => v.severity === 'WARNING').length, 0);

            // Count validations by category
            const byCategory = {
                'file-check': 0,
                'schema-check': 0,
                'field-check': 0,
                'record-check': 0,
                'cross-file-check': 0,
                'statistical-check': 0
            };

            state.files.forEach(file => {
                file.validations.forEach(validation => {
                    const category = getValidationCategory(validation.type);
                    if (byCategory.hasOwnProperty(category)) {
                        byCategory[category]++;
                    }
                });
            });

            // Files without validations
            const filesWithoutValidations = state.files
                .filter(f => f.validations.length === 0)
                .map(f => f.name);

            // Files coverage (sorted by validation count)
            const filesCoverage = state.files
                .map(f => ({ name: f.name, count: f.validations.length }))
                .sort((a, b) => b.count - a.count);

            return {
                totalValidations,
                errorCount,
                warningCount,
                byCategory,
                filesWithoutValidations,
                filesCoverage
            };
        }

        /**
         * Calculates configuration health score (0-100%)
         * Based on completeness, best practices, and absence of issues
         * @returns {object} Health score and grade
         */
        function calculateConfigurationHealth() {
            let score = 100;
            let issues = [];

            // Deduct points for missing files
            if (state.files.length === 0) {
                score -= 50;
                issues.push('No files configured');
            }

            // Check each file
            state.files.forEach(file => {
                // Deduct for files without validations
                if (file.validations.length === 0) {
                    score -= 10;
                    issues.push(`${file.name} has no validations`);
                }

                const hasEmptyFileCheck = file.validations.some(v => v.type === 'EmptyFileCheck');
                const hasMandatoryFieldCheck = file.validations.some(v => v.type === 'MandatoryFieldCheck');

                // Deduct for missing essential validations
                if (file.validations.length > 0 && !hasEmptyFileCheck) {
                    score -= 5;
                    issues.push(`${file.name} missing EmptyFileCheck`);
                }

                // Check for incomplete parameters
                file.validations.forEach(v => {
                    if (v.type === 'UniqueKeyCheck' && (!v.params?.fields || v.params.fields.length === 0)) {
                        score -= 5;
                        issues.push(`${file.name}: UniqueKeyCheck missing parameters`);
                    }
                    if (v.type === 'MandatoryFieldCheck' && (!v.params?.fields || v.params.fields.length === 0)) {
                        score -= 5;
                        issues.push(`${file.name}: MandatoryFieldCheck missing parameters`);
                    }
                });
            });

            // Check for conflicts
            const conflicts = detectValidationConflicts();
            score -= conflicts.length * 3;

            // Ensure score doesn't go below 0
            score = Math.max(0, score);

            // Determine grade
            let grade = 'F';
            let color = 'var(--severity-error)';
            if (score >= 90) { grade = 'A'; color = 'var(--md-sys-color-primary)'; }
            else if (score >= 80) { grade = 'B'; color = 'var(--md-sys-color-primary)'; }
            else if (score >= 70) { grade = 'C'; color = 'var(--severity-warning)'; }
            else if (score >= 60) { grade = 'D'; color = 'var(--severity-warning)'; }
            else { color = 'var(--severity-error)'; }

            return { score, grade, color, issues };
        }

        /**
         * Updates the quick stats display in the sidebar
         * Shows file count, validation count, and health score
         */
        function updateQuickStats() {
            const filesCount = state.files.length;
            const validationsCount = state.files.reduce((sum, f) => sum + f.validations.length, 0);
            const health = calculateConfigurationHealth();

            document.getElementById('statsFiles').textContent = filesCount;
            document.getElementById('statsValidations').textContent = validationsCount;
            document.getElementById('statsHealth').textContent = `${health.score}% (${health.grade})`;
            document.getElementById('statsHealth').style.color = health.color;
        }

        // ========================================
        // VALIDATION PRESETS
        // ========================================

        /**
         * Toggles the collapse state of the presets section in sidebar
         */
        function togglePresetsCollapse() {
            const content = document.getElementById('presetsContent');
            const icon = document.getElementById('presetsCollapseIcon');
            const isCollapsed = content.style.display === 'none';

            content.style.display = isCollapsed ? 'block' : 'none';
            icon.style.transform = isCollapsed ? 'rotate(0deg)' : 'rotate(-90deg)';
        }

        /**
         * Opens the Save Preset modal and populates preview
         */
        function openSavePresetModal() {
            // Check if current file has validations to save
            const currentFile = state.files[state.currentFileIndex];
            if (!currentFile || currentFile.validations.length === 0) {
                alert('Current file has no validations to save as a preset.');
                return;
            }

            // Populate preview
            const previewContent = document.getElementById('presetPreviewContent');
            const validationsList = currentFile.validations.map(v => {
                const paramCount = v.params ? Object.keys(v.params).length : 0;
                return `<div style="display: flex; align-items: center; gap: 8px; padding: 6px 0;">
                    <span style="color: var(--md-sys-color-primary);">‚úì</span>
                    <span style="color: var(--text-primary);">${v.type}</span>
                    <span style="color: var(--text-muted); font-size: 11px;">(${paramCount} param${paramCount !== 1 ? 's' : ''})</span>
                </div>`;
            }).join('');

            previewContent.innerHTML = validationsList || '<span style="color: var(--text-muted);">No validations</span>';

            // Clear form inputs
            document.getElementById('presetName').value = '';
            document.getElementById('presetDescription').value = '';

            // Show modal
            document.getElementById('savePresetModal').style.display = 'flex';
        }

        /**
         * Closes the Save Preset modal
         */
        function closeSavePresetModal() {
            document.getElementById('savePresetModal').style.display = 'none';
        }

        /**
         * Saves the current validations as a preset to localStorage
         */
        function confirmSavePreset() {
            const name = document.getElementById('presetName').value.trim();
            const description = document.getElementById('presetDescription').value.trim();

            // Validate input
            if (!name) {
                alert('Please enter a preset name.');
                return;
            }

            const currentFile = state.files[state.currentFileIndex];
            if (!currentFile || currentFile.validations.length === 0) {
                alert('No validations to save.');
                return;
            }

            // Create preset object (deep copy validations)
            const preset = {
                id: Date.now().toString(),
                name: name,
                description: description,
                validations: JSON.parse(JSON.stringify(currentFile.validations)),
                createdAt: new Date().toISOString()
            };

            // Load existing presets
            let presets = [];
            try {
                const stored = localStorage.getItem('validationPresets');
                if (stored) {
                    presets = JSON.parse(stored);
                }
            } catch (e) {
                console.error('Error loading presets:', e);
            }

            // Add new preset
            presets.push(preset);

            // Save to localStorage
            try {
                localStorage.setItem('validationPresets', JSON.stringify(presets));
                console.log('Preset saved:', preset.name);
            } catch (e) {
                console.error('Error saving preset:', e);
                alert('Failed to save preset. Storage quota may be exceeded.');
                return;
            }

            // Close modal and refresh presets display
            closeSavePresetModal();
            renderPresets();

            // Show success feedback
            showNotification(`Preset "${name}" saved successfully!`, 'success');
        }

        /**
         * Loads and renders all presets in the sidebar
         */
        function renderPresets() {
            const presetsList = document.getElementById('presetsList');

            // Load presets from localStorage
            let presets = [];
            try {
                const stored = localStorage.getItem('validationPresets');
                if (stored) {
                    presets = JSON.parse(stored);
                }
            } catch (e) {
                console.error('Error loading presets:', e);
            }

            // Render presets
            if (presets.length === 0) {
                presetsList.innerHTML = `
                    <div style="padding: 16px; text-align: center; color: var(--text-muted); font-size: 12px;">
                        No presets saved yet.<br>
                        Save your current validations to create a preset.
                    </div>
                `;
                return;
            }

            presetsList.innerHTML = presets.map(preset => {
                const validationCount = preset.validations.length;
                return `
                    <div style="padding: 12px 16px; border-bottom: 1px solid var(--border); hover: background: var(--bg-tertiary);">
                        <div style="display: flex; justify-content: space-between; align-items: start; gap: 8px;">
                            <div style="flex: 1; min-width: 0;">
                                <div style="color: var(--text-primary); font-weight: 500; font-size: 13px; margin-bottom: 4px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;"
                                     title="${preset.name}">
                                    ${preset.name}
                                </div>
                                ${preset.description ? `
                                    <div style="color: var(--text-muted); font-size: 11px; margin-bottom: 6px; line-height: 1.4;">
                                        ${preset.description}
                                    </div>
                                ` : ''}
                                <div style="color: var(--text-muted); font-size: 11px;">
                                    ${validationCount} validation${validationCount !== 1 ? 's' : ''}
                                </div>
                            </div>
                            <div style="display: flex; gap: 4px;">
                                <button
                                    onclick="applyPreset('${preset.id}')"
                                    class="md-button-text"
                                    style="padding: 4px 8px; font-size: 11px; white-space: nowrap;"
                                    title="Apply this preset to current file">
                                    Apply
                                </button>
                                <button
                                    onclick="deletePreset('${preset.id}')"
                                    class="md-button-text"
                                    style="padding: 4px 8px; font-size: 11px; color: var(--severity-error);"
                                    title="Delete this preset">
                                    ‚úï
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        /**
         * Applies a preset to the current file
         * @param {string} presetId - ID of the preset to apply
         */
        function applyPreset(presetId) {
            // Check if a file is selected
            if (state.currentFileIndex === -1) {
                alert('Please select a file first.');
                return;
            }

            // Load presets
            let presets = [];
            try {
                const stored = localStorage.getItem('validationPresets');
                if (stored) {
                    presets = JSON.parse(stored);
                }
            } catch (e) {
                console.error('Error loading presets:', e);
                alert('Failed to load presets.');
                return;
            }

            // Find the preset
            const preset = presets.find(p => p.id === presetId);
            if (!preset) {
                alert('Preset not found.');
                return;
            }

            // Confirm if current file has validations
            const currentFile = state.files[state.currentFileIndex];
            if (currentFile.validations.length > 0) {
                if (!confirm(`This will replace ${currentFile.validations.length} existing validation(s) in "${currentFile.name}". Continue?`)) {
                    return;
                }
            }

            // Save state for undo
            saveStateToUndoStack();

            // Apply preset (deep copy validations)
            currentFile.validations = JSON.parse(JSON.stringify(preset.validations));

            // Update UI
            renderValidations();
            updateYAMLPreview();
            autoSave();

            // Show success feedback
            showNotification(`Preset "${preset.name}" applied successfully!`, 'success');
        }

        /**
         * Deletes a preset from localStorage
         * @param {string} presetId - ID of the preset to delete
         */
        function deletePreset(presetId) {
            if (!confirm('Are you sure you want to delete this preset?')) {
                return;
            }

            // Load presets
            let presets = [];
            try {
                const stored = localStorage.getItem('validationPresets');
                if (stored) {
                    presets = JSON.parse(stored);
                }
            } catch (e) {
                console.error('Error loading presets:', e);
                return;
            }

            // Filter out the deleted preset
            const filteredPresets = presets.filter(p => p.id !== presetId);

            // Save back to localStorage
            try {
                localStorage.setItem('validationPresets', JSON.stringify(filteredPresets));
                console.log('Preset deleted');
            } catch (e) {
                console.error('Error saving presets:', e);
                alert('Failed to delete preset.');
                return;
            }

            // Refresh display
            renderPresets();

            // Show success feedback
            showNotification('Preset deleted successfully!', 'success');
        }

        /**
         * Shows a temporary notification message
         * @param {string} message - Message to display
         * @param {string} type - Type of notification (success, error, info)
         */
        function showNotification(message, type = 'info') {
            // Create notification element
            const notification = document.createElement('div');
            notification.textContent = message;
            notification.style.cssText = `
                position: fixed;
                bottom: 24px;
                right: 24px;
                padding: 12px 20px;
                background: ${type === 'success' ? 'var(--md-sys-color-primary)' : type === 'error' ? 'var(--severity-error)' : 'var(--bg-secondary)'};
                color: white;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.2);
                font-size: 14px;
                font-weight: 500;
                z-index: 10000;
                animation: slideIn 0.3s ease-out;
            `;

            document.body.appendChild(notification);

            // Remove after 3 seconds
            setTimeout(() => {
                notification.style.animation = 'slideOut 0.3s ease-out';
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }

        // ========================================
        // CONFIGURATION VALIDATOR
        // ========================================

        /**
         * Opens the Configuration Validator modal and runs validation checks
         */
        function openValidatorModal() {
            // Run comprehensive validation
            const results = validateConfiguration();

            // Render results in modal
            renderValidationResults(results);

            // Show modal
            document.getElementById('validatorModal').style.display = 'flex';
        }

        /**
         * Closes the Configuration Validator modal
         */
        function closeValidatorModal() {
            document.getElementById('validatorModal').style.display = 'none';
        }

        /**
         * Performs comprehensive validation checks on the configuration
         * @returns {object} Validation results with errors, warnings, and info
         */
        function validateConfiguration() {
            const errors = [];
            const warnings = [];
            const info = [];
            let passedChecks = 0;
            let totalChecks = 0;

            // Check 1: Configuration has files
            totalChecks++;
            if (state.files.length === 0) {
                errors.push({
                    check: 'Files Configured',
                    message: 'No files have been configured. Add at least one file.',
                    severity: 'error'
                });
            } else {
                passedChecks++;
                info.push({
                    check: 'Files Configured',
                    message: `${state.files.length} file${state.files.length !== 1 ? 's' : ''} configured`,
                    severity: 'info'
                });
            }

            // Check each file
            state.files.forEach((file, idx) => {
                // Check 2: File has validations
                totalChecks++;
                if (file.validations.length === 0) {
                    warnings.push({
                        check: `File: ${file.name}`,
                        message: 'File has no validations configured',
                        severity: 'warning'
                    });
                } else {
                    passedChecks++;
                }

                // Check 3: EmptyFileCheck present
                totalChecks++;
                const hasEmptyFileCheck = file.validations.some(v => v.type === 'EmptyFileCheck');
                if (file.validations.length > 0 && !hasEmptyFileCheck) {
                    warnings.push({
                        check: `File: ${file.name}`,
                        message: 'Missing recommended EmptyFileCheck validation',
                        severity: 'warning'
                    });
                } else if (hasEmptyFileCheck) {
                    passedChecks++;
                } else {
                    totalChecks--; // Don't count if no validations
                }

                // Check 4: Validation parameters complete
                file.validations.forEach((v, vIdx) => {
                    totalChecks++;
                    const incomplete = [];

                    // Check UniqueKeyCheck has fields
                    if (v.type === 'UniqueKeyCheck') {
                        if (!v.params?.fields || v.params.fields.length === 0) {
                            incomplete.push('fields');
                        }
                    }

                    // Check MandatoryFieldCheck has fields
                    if (v.type === 'MandatoryFieldCheck') {
                        if (!v.params?.fields || v.params.fields.length === 0) {
                            incomplete.push('fields');
                        }
                    }

                    // Check PatternMatchCheck has pattern and field
                    if (v.type === 'PatternMatchCheck') {
                        if (!v.params?.pattern) {
                            incomplete.push('pattern');
                        }
                        if (!v.params?.field) {
                            incomplete.push('field');
                        }
                    }

                    // Check ColumnCountCheck has expected_count
                    if (v.type === 'ColumnCountCheck') {
                        if (!v.params?.expected_count && v.params?.expected_count !== 0) {
                            incomplete.push('expected_count');
                        }
                    }

                    // Check CustomSQLCheck has query
                    if (v.type === 'CustomSQLCheck') {
                        if (!v.params?.query) {
                            incomplete.push('query');
                        }
                    }

                    // Check RangeCheck has field, min, max
                    if (v.type === 'RangeCheck') {
                        if (!v.params?.field) {
                            incomplete.push('field');
                        }
                        if (v.params?.min === undefined && v.params?.max === undefined) {
                            incomplete.push('min/max');
                        }
                    }

                    if (incomplete.length > 0) {
                        errors.push({
                            check: `${file.name} - ${v.type}`,
                            message: `Missing required parameter${incomplete.length > 1 ? 's' : ''}: ${incomplete.join(', ')}`,
                            severity: 'error'
                        });
                    } else {
                        passedChecks++;
                    }
                });
            });

            // Check 5: Detect validation conflicts
            const conflicts = detectValidationConflicts();
            if (conflicts.length > 0) {
                conflicts.forEach(conflict => {
                    warnings.push({
                        check: 'Validation Conflict',
                        message: conflict,
                        severity: 'warning'
                    });
                });
            }

            // Check 6: YAML generation
            totalChecks++;
            try {
                const yaml = generateYAML();
                if (yaml && yaml.length > 0) {
                    passedChecks++;
                    info.push({
                        check: 'YAML Generation',
                        message: 'YAML configuration generated successfully',
                        severity: 'info'
                    });
                } else {
                    errors.push({
                        check: 'YAML Generation',
                        message: 'Generated YAML is empty',
                        severity: 'error'
                    });
                }
            } catch (e) {
                errors.push({
                    check: 'YAML Generation',
                    message: `Failed to generate YAML: ${e.message}`,
                    severity: 'error'
                });
            }

            // Calculate health
            const health = calculateConfigurationHealth();

            return {
                errors,
                warnings,
                info,
                passedChecks,
                totalChecks,
                health,
                canDownload: errors.length === 0
            };
        }

        /**
         * Renders validation results in the validator modal
         * @param {object} results - Validation results from validateConfiguration()
         */
        function renderValidationResults(results) {
            const container = document.getElementById('validatorResults');
            const downloadBtn = document.getElementById('validatorDownloadBtn');

            // Overall status card
            const statusColor = results.errors.length === 0
                ? (results.warnings.length === 0 ? 'var(--md-sys-color-primary)' : 'var(--severity-warning)')
                : 'var(--severity-error)';

            const statusIcon = results.errors.length === 0
                ? (results.warnings.length === 0 ? '‚úÖ' : '‚ö†Ô∏è')
                : '‚ùå';

            const statusText = results.errors.length === 0
                ? (results.warnings.length === 0 ? 'Configuration Valid' : 'Configuration Valid (with warnings)')
                : 'Configuration Has Errors';

            let html = `
                <!-- Overall Status -->
                <div style="padding: 20px; background: var(--bg-secondary); border-radius: 12px; border: 2px solid ${statusColor};">
                    <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 16px;">
                        <span style="font-size: 32px;">${statusIcon}</span>
                        <div style="flex: 1;">
                            <h3 style="color: var(--text-primary); margin: 0 0 4px 0; font-size: 18px;">${statusText}</h3>
                            <p style="color: var(--text-muted); margin: 0; font-size: 13px;">
                                ${results.passedChecks} of ${results.totalChecks} checks passed
                            </p>
                        </div>
                        <div style="text-align: right;">
                            <div style="font-size: 28px; font-weight: 700; color: ${results.health.color};">
                                ${results.health.score}%
                            </div>
                            <div style="font-size: 12px; color: var(--text-muted);">
                                Health: ${results.health.grade}
                            </div>
                        </div>
                    </div>

                    <!-- Summary Badges -->
                    <div style="display: flex; gap: 12px; flex-wrap: wrap;">
                        ${results.errors.length > 0 ? `
                            <div style="padding: 8px 16px; background: var(--bg-primary); border-radius: 8px; border: 1px solid var(--severity-error);">
                                <span style="color: var(--severity-error); font-weight: 600;">${results.errors.length}</span>
                                <span style="color: var(--text-muted); font-size: 12px; margin-left: 4px;">Error${results.errors.length !== 1 ? 's' : ''}</span>
                            </div>
                        ` : ''}
                        ${results.warnings.length > 0 ? `
                            <div style="padding: 8px 16px; background: var(--bg-primary); border-radius: 8px; border: 1px solid var(--severity-warning);">
                                <span style="color: var(--severity-warning); font-weight: 600;">${results.warnings.length}</span>
                                <span style="color: var(--text-muted); font-size: 12px; margin-left: 4px;">Warning${results.warnings.length !== 1 ? 's' : ''}</span>
                            </div>
                        ` : ''}
                        ${results.errors.length === 0 && results.warnings.length === 0 ? `
                            <div style="padding: 8px 16px; background: var(--bg-primary); border-radius: 8px; border: 1px solid var(--md-sys-color-primary);">
                                <span style="color: var(--md-sys-color-primary); font-weight: 600;">‚úì</span>
                                <span style="color: var(--text-muted); font-size: 12px; margin-left: 4px;">All Checks Passed</span>
                            </div>
                        ` : ''}
                    </div>
                </div>
            `;

            // Errors section
            if (results.errors.length > 0) {
                html += `
                    <div style="padding: 16px; background: var(--bg-secondary); border-radius: 8px; border-left: 3px solid var(--severity-error);">
                        <h4 style="color: var(--text-primary); margin: 0 0 12px 0; font-size: 14px; display: flex; align-items: center; gap: 8px;">
                            <span>‚ùå</span>
                            <span>Errors (must be fixed)</span>
                        </h4>
                        <div style="display: grid; gap: 8px;">
                            ${results.errors.map(err => `
                                <div style="padding: 10px 12px; background: var(--bg-primary); border-radius: 6px; border: 1px solid var(--border);">
                                    <div style="color: var(--text-primary); font-weight: 500; font-size: 13px; margin-bottom: 2px;">
                                        ${err.check}
                                    </div>
                                    <div style="color: var(--text-muted); font-size: 12px;">
                                        ${err.message}
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }

            // Warnings section
            if (results.warnings.length > 0) {
                html += `
                    <div style="padding: 16px; background: var(--bg-secondary); border-radius: 8px; border-left: 3px solid var(--severity-warning);">
                        <h4 style="color: var(--text-primary); margin: 0 0 12px 0; font-size: 14px; display: flex; align-items: center; gap: 8px;">
                            <span>‚ö†Ô∏è</span>
                            <span>Warnings (recommended fixes)</span>
                        </h4>
                        <div style="display: grid; gap: 8px;">
                            ${results.warnings.map(warn => `
                                <div style="padding: 10px 12px; background: var(--bg-primary); border-radius: 6px; border: 1px solid var(--border);">
                                    <div style="color: var(--text-primary); font-weight: 500; font-size: 13px; margin-bottom: 2px;">
                                        ${warn.check}
                                    </div>
                                    <div style="color: var(--text-muted); font-size: 12px;">
                                        ${warn.message}
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }

            // Info section
            if (results.info.length > 0 && results.errors.length === 0 && results.warnings.length === 0) {
                html += `
                    <div style="padding: 16px; background: var(--bg-secondary); border-radius: 8px; border-left: 3px solid var(--md-sys-color-primary);">
                        <h4 style="color: var(--text-primary); margin: 0 0 12px 0; font-size: 14px; display: flex; align-items: center; gap: 8px;">
                            <span>‚ÑπÔ∏è</span>
                            <span>Configuration Details</span>
                        </h4>
                        <div style="display: grid; gap: 8px;">
                            ${results.info.map(inf => `
                                <div style="padding: 10px 12px; background: var(--bg-primary); border-radius: 6px; border: 1px solid var(--border);">
                                    <div style="color: var(--text-muted); font-size: 12px;">
                                        ‚úì ${inf.message}
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }

            container.innerHTML = html;

            // Update download button state
            if (results.canDownload) {
                downloadBtn.textContent = 'Download Configuration';
                downloadBtn.className = 'btn btn-primary';
                downloadBtn.disabled = false;
            } else {
                downloadBtn.textContent = 'Fix Errors First';
                downloadBtn.className = 'btn btn-secondary';
                downloadBtn.disabled = true;
            }
        }

        /**
         * Downloads configuration after validation (from validator modal)
         */
        function downloadConfigAfterValidation() {
            closeValidatorModal();
            downloadConfig();
        }

        // ========================================
        // LIVE VALIDATION PREVIEW
        // ========================================

        let livePreviewData = null;
        let livePreviewTestResults = null;

        /**
         * Opens the Live Validation Preview modal
         */
        function openLivePreviewModal() {
            // Check if current file has validations
            if (state.currentFileIndex === -1 || !state.files[state.currentFileIndex]) {
                alert('Please select a file first.');
                return;
            }

            const currentFile = state.files[state.currentFileIndex];
            if (currentFile.validations.length === 0) {
                alert('Current file has no validations to test.');
                return;
            }

            // Reset state
            livePreviewData = null;
            livePreviewTestResults = null;
            document.getElementById('livePreviewFileName').textContent = 'No file selected';
            document.getElementById('livePreviewResults').style.display = 'none';
            document.getElementById('exportTestReport').style.display = 'none';
            document.getElementById('livePreviewFileInput').value = '';

            // Show modal
            document.getElementById('livePreviewModal').style.display = 'flex';
        }

        /**
         * Closes the Live Validation Preview modal
         */
        function closeLivePreviewModal() {
            document.getElementById('livePreviewModal').style.display = 'none';
        }

        /**
         * Handles file upload for live preview
         * @param {Event} event - File input change event
         */
        function handleLivePreviewFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            // Update file name display
            document.getElementById('livePreviewFileName').textContent = `Selected: ${file.name}`;

            // Read and parse file
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const content = e.target.result;
                    const fileExtension = file.name.split('.').pop().toLowerCase();

                    if (fileExtension === 'csv') {
                        livePreviewData = parseCSV(content);
                    } else if (fileExtension === 'json') {
                        livePreviewData = JSON.parse(content);
                        // Ensure data is array of objects
                        if (!Array.isArray(livePreviewData)) {
                            livePreviewData = [livePreviewData];
                        }
                    } else {
                        alert('Unsupported file type. Please upload CSV or JSON.');
                        return;
                    }

                    // Run validations
                    runLivePreviewValidations();

                } catch (error) {
                    console.error('Error parsing file:', error);
                    alert(`Failed to parse file: ${error.message}`);
                }
            };
            reader.readAsText(file);
        }

        /**
         * Parses CSV content into array of objects
         * NOTE: This is a simple CSV parser that handles basic comma-delimited files.
         * It does NOT handle commas inside quoted fields or complex CSV edge cases.
         * For production use with complex CSVs, consider using a proper CSV parsing library.
         *
         * @param {string} csv - CSV content
         * @returns {Array<object>} Array of row objects
         */
        function parseCSV(csv) {
            const lines = csv.trim().split('\n').filter(line => line.trim().length > 0);
            if (lines.length === 0) return [];

            // Parse header
            const headers = lines[0].split(',').map(h => h.trim().replace(/^"|"$/g, ''));

            // Parse rows
            const data = [];
            for (let i = 1; i < lines.length; i++) {
                const line = lines[i].trim();
                if (line.length === 0) continue; // Skip empty lines

                const values = line.split(',').map(v => v.trim().replace(/^"|"$/g, ''));
                const row = {};
                headers.forEach((header, idx) => {
                    row[header] = values[idx] || '';
                });
                data.push(row);
            }

            return data;
        }

        /**
         * Runs validation checks against the uploaded sample data
         */
        function runLivePreviewValidations() {
            if (!livePreviewData || livePreviewData.length === 0) {
                alert('No data to validate.');
                return;
            }

            const currentFile = state.files[state.currentFileIndex];
            const results = [];

            // Run each validation
            currentFile.validations.forEach(validation => {
                const result = runSingleValidation(validation, livePreviewData);
                results.push(result);
            });

            livePreviewTestResults = results;

            // Render results
            renderLivePreviewResults();

            // Show export button
            document.getElementById('exportTestReport').style.display = 'block';
        }

        /**
         * Runs a single validation check against the data
         * @param {object} validation - Validation configuration
         * @param {Array<object>} data - Sample data rows
         * @returns {object} Validation result
         */
        function runSingleValidation(validation, data) {
            const result = {
                type: validation.type,
                passed: false,
                message: '',
                details: [],
                failedRows: []
            };

            try {
                switch (validation.type) {
                    case 'EmptyFileCheck':
                        result.passed = data.length > 0;
                        result.message = result.passed
                            ? `‚úÖ File is not empty (${data.length} rows)`
                            : '‚ùå File is empty';
                        break;

                    case 'ColumnCountCheck':
                        const expectedCount = validation.params?.expected_count;
                        if (expectedCount === undefined || expectedCount === null) {
                            result.passed = null;
                            result.message = '‚ö†Ô∏è ColumnCountCheck - No expected_count configured';
                            break;
                        }
                        const actualCount = data.length > 0 ? Object.keys(data[0]).length : 0;
                        result.passed = actualCount === expectedCount;
                        result.message = result.passed
                            ? `‚úÖ Column count matches (${actualCount} columns)`
                            : `‚ùå Expected ${expectedCount} columns, found ${actualCount}`;
                        break;

                    case 'MandatoryFieldCheck':
                        const requiredFields = validation.params?.fields || [];
                        if (requiredFields.length === 0) {
                            result.passed = null;
                            result.message = '‚ö†Ô∏è MandatoryFieldCheck - No fields configured';
                            break;
                        }
                        let missingCount = 0;
                        data.forEach((row, idx) => {
                            const missing = requiredFields.filter(field => !row[field] || String(row[field]).trim() === '');
                            if (missing.length > 0) {
                                missingCount++;
                                if (result.failedRows.length < 10) {
                                    result.failedRows.push({
                                        row: idx + 1,
                                        issue: `Missing: ${missing.join(', ')}`
                                    });
                                }
                            }
                        });
                        result.passed = missingCount === 0;
                        result.message = result.passed
                            ? `‚úÖ All mandatory fields present`
                            : `‚ùå ${missingCount} row(s) missing required fields`;
                        break;

                    case 'UniqueKeyCheck':
                        const keyFields = validation.params?.fields || [];
                        if (keyFields.length === 0) {
                            result.passed = null;
                            result.message = '‚ö†Ô∏è UniqueKeyCheck - No key fields configured';
                            break;
                        }
                        const seen = new Set();
                        let duplicateCount = 0;
                        data.forEach((row, idx) => {
                            const key = keyFields.map(f => row[f] || '').join('|');
                            if (seen.has(key)) {
                                duplicateCount++;
                                if (result.failedRows.length < 10) {
                                    result.failedRows.push({
                                        row: idx + 1,
                                        issue: `Duplicate key: ${key}`
                                    });
                                }
                            }
                            seen.add(key);
                        });
                        result.passed = duplicateCount === 0;
                        result.message = result.passed
                            ? `‚úÖ All keys are unique`
                            : `‚ùå ${duplicateCount} duplicate key(s) found`;
                        break;

                    case 'PatternMatchCheck':
                        const pattern = validation.params?.pattern;
                        const field = validation.params?.field;
                        if (!pattern || !field) {
                            result.passed = null;
                            result.message = '‚ö†Ô∏è PatternMatchCheck - Missing pattern or field parameter';
                            break;
                        }
                        try {
                            const regex = new RegExp(pattern, 'i');
                            let mismatchCount = 0;
                            data.forEach((row, idx) => {
                                if (!regex.test(row[field] || '')) {
                                    mismatchCount++;
                                    if (result.failedRows.length < 10) {
                                        result.failedRows.push({
                                            row: idx + 1,
                                            issue: `Value doesn't match pattern: "${row[field] || ''}"`
                                        });
                                    }
                                }
                            });
                            result.passed = mismatchCount === 0;
                            result.message = result.passed
                                ? `‚úÖ All values match pattern`
                                : `‚ùå ${mismatchCount} value(s) don't match pattern`;
                        } catch (regexError) {
                            result.passed = false;
                            result.message = `‚ùå Invalid regex pattern: ${regexError.message}`;
                        }
                        break;

                    case 'RangeCheck':
                        const rangeField = validation.params?.field;
                        const min = validation.params?.min;
                        const max = validation.params?.max;
                        if (!rangeField) {
                            result.passed = null;
                            result.message = '‚ö†Ô∏è RangeCheck - Missing field parameter';
                            break;
                        }
                        if (min === undefined && max === undefined) {
                            result.passed = null;
                            result.message = '‚ö†Ô∏è RangeCheck - No min or max defined';
                            break;
                        }
                        let outOfRangeCount = 0;
                        let nonNumericCount = 0;
                        data.forEach((row, idx) => {
                            const value = parseFloat(row[rangeField]);
                            if (isNaN(value)) {
                                nonNumericCount++;
                            } else {
                                const outOfRange = (min !== undefined && value < min) || (max !== undefined && value > max);
                                if (outOfRange) {
                                    outOfRangeCount++;
                                    if (result.failedRows.length < 10) {
                                        result.failedRows.push({
                                            row: idx + 1,
                                            issue: `Value ${value} out of range [${min ?? '-‚àû'}, ${max ?? '‚àû'}]`
                                        });
                                    }
                                }
                            }
                        });
                        result.passed = outOfRangeCount === 0;
                        result.message = result.passed
                            ? `‚úÖ All values within range${nonNumericCount > 0 ? ` (${nonNumericCount} non-numeric skipped)` : ''}`
                            : `‚ùå ${outOfRangeCount} value(s) out of range${nonNumericCount > 0 ? ` (${nonNumericCount} non-numeric skipped)` : ''}`;
                        break;

                    default:
                        result.message = `‚ö†Ô∏è ${validation.type} - Testing not implemented (configuration validation only)`;
                        result.passed = null; // null = not tested
                        break;
                }
            } catch (error) {
                result.passed = false;
                result.message = `‚ùå Error running validation: ${error.message}`;
            }

            return result;
        }

        /**
         * Renders live preview test results in the modal
         */
        function renderLivePreviewResults() {
            if (!livePreviewTestResults) return;

            const container = document.getElementById('livePreviewResults');
            const passedCount = livePreviewTestResults.filter(r => r.passed === true).length;
            const failedCount = livePreviewTestResults.filter(r => r.passed === false).length;
            const notTestedCount = livePreviewTestResults.filter(r => r.passed === null).length;
            const totalTests = passedCount + failedCount;

            const successRate = totalTests > 0 ? Math.round((passedCount / totalTests) * 100) : 0;

            let html = `
                <!-- Summary Card -->
                <div style="padding: 20px; background: var(--bg-secondary); border-radius: 12px; border: 2px solid ${successRate === 100 ? 'var(--md-sys-color-primary)' : failedCount > 0 ? 'var(--severity-error)' : 'var(--severity-warning)'};">
                    <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 16px;">
                        <span style="font-size: 32px;">${successRate === 100 ? '‚úÖ' : failedCount > 0 ? '‚ùå' : '‚ö†Ô∏è'}</span>
                        <div style="flex: 1;">
                            <h3 style="color: var(--text-primary); margin: 0 0 4px 0; font-size: 18px;">
                                Test Results: ${passedCount}/${totalTests} Passed
                            </h3>
                            <p style="color: var(--text-muted); margin: 0; font-size: 13px;">
                                ${livePreviewData.length} rows tested against ${livePreviewTestResults.length} validation${livePreviewTestResults.length !== 1 ? 's' : ''}
                            </p>
                        </div>
                        <div style="text-align: right;">
                            <div style="font-size: 28px; font-weight: 700; color: ${successRate === 100 ? 'var(--md-sys-color-primary)' : failedCount > 0 ? 'var(--severity-error)' : 'var(--severity-warning)'};">
                                ${successRate}%
                            </div>
                            <div style="font-size: 12px; color: var(--text-muted);">
                                Success Rate
                            </div>
                        </div>
                    </div>

                    <div style="display: flex; gap: 12px; flex-wrap: wrap;">
                        ${passedCount > 0 ? `
                            <div style="padding: 8px 16px; background: var(--bg-primary); border-radius: 8px; border: 1px solid var(--md-sys-color-primary);">
                                <span style="color: var(--md-sys-color-primary); font-weight: 600;">${passedCount}</span>
                                <span style="color: var(--text-muted); font-size: 12px; margin-left: 4px;">Passed</span>
                            </div>
                        ` : ''}
                        ${failedCount > 0 ? `
                            <div style="padding: 8px 16px; background: var(--bg-primary); border-radius: 8px; border: 1px solid var(--severity-error);">
                                <span style="color: var(--severity-error); font-weight: 600;">${failedCount}</span>
                                <span style="color: var(--text-muted); font-size: 12px; margin-left: 4px;">Failed</span>
                            </div>
                        ` : ''}
                        ${notTestedCount > 0 ? `
                            <div style="padding: 8px 16px; background: var(--bg-primary); border-radius: 8px; border: 1px solid var(--border);">
                                <span style="color: var(--text-muted); font-weight: 600;">${notTestedCount}</span>
                                <span style="color: var(--text-muted); font-size: 12px; margin-left: 4px;">Not Tested</span>
                            </div>
                        ` : ''}
                    </div>
                </div>

                <!-- Detailed Results -->
                <div style="padding: 16px; background: var(--bg-secondary); border-radius: 8px;">
                    <h4 style="color: var(--text-primary); margin: 0 0 16px 0; font-size: 14px;">Detailed Results</h4>
                    <div style="display: grid; gap: 12px;">
                        ${livePreviewTestResults.map((result, idx) => `
                            <div style="padding: 12px; background: var(--bg-primary); border-radius: 8px; border-left: 3px solid ${result.passed === true ? 'var(--md-sys-color-primary)' : result.passed === false ? 'var(--severity-error)' : 'var(--border)'};">
                                <div style="color: var(--text-primary); font-weight: 500; margin-bottom: 4px;">
                                    ${result.type}
                                </div>
                                <div style="color: var(--text-muted); font-size: 13px; margin-bottom: 8px;">
                                    ${result.message}
                                </div>
                                ${result.failedRows.length > 0 ? `
                                    <details style="margin-top: 8px;">
                                        <summary style="cursor: pointer; color: var(--severity-error); font-size: 12px; font-weight: 500;">
                                            View ${result.failedRows.length} failed row${result.failedRows.length !== 1 ? 's' : ''} (showing first 10)
                                        </summary>
                                        <div style="margin-top: 8px; padding: 8px; background: var(--bg-secondary); border-radius: 4px; font-size: 11px; font-family: 'Courier New', monospace;">
                                            ${result.failedRows.map(fr => `
                                                <div style="padding: 4px 0; border-bottom: 1px solid var(--border);">
                                                    <span style="color: var(--severity-error);">Row ${fr.row}:</span>
                                                    <span style="color: var(--text-muted);">${fr.issue}</span>
                                                </div>
                                            `).join('')}
                                        </div>
                                    </details>
                                ` : ''}
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;

            container.innerHTML = html;
            container.style.display = 'block';
        }

        /**
         * Exports test report as a downloadable file
         */
        function exportTestReport() {
            if (!livePreviewTestResults) return;

            const currentFile = state.files[state.currentFileIndex];
            const passedCount = livePreviewTestResults.filter(r => r.passed === true).length;
            const failedCount = livePreviewTestResults.filter(r => r.passed === false).length;
            const totalTests = passedCount + failedCount;

            let report = `LIVE VALIDATION TEST REPORT
================================================================================
File: ${currentFile.name}
Date: ${new Date().toLocaleString()}
Sample Rows: ${livePreviewData.length}
Validations Tested: ${livePreviewTestResults.length}

SUMMARY
================================================================================
Passed: ${passedCount}/${totalTests}
Failed: ${failedCount}/${totalTests}
Success Rate: ${totalTests > 0 ? Math.round((passedCount / totalTests) * 100) : 0}%

DETAILED RESULTS
================================================================================

`;

            livePreviewTestResults.forEach((result, idx) => {
                report += `${idx + 1}. ${result.type}\n`;
                report += `   Status: ${result.passed === true ? 'PASS' : result.passed === false ? 'FAIL' : 'NOT TESTED'}\n`;
                report += `   Message: ${result.message.replace(/[‚úÖ‚ùå‚ö†Ô∏è]/g, '')}\n`;
                if (result.failedRows.length > 0) {
                    report += `   Failed Rows:\n`;
                    result.failedRows.forEach(fr => {
                        report += `     - Row ${fr.row}: ${fr.issue}\n`;
                    });
                }
                report += `\n`;
            });

            report += `================================================================================\n`;
            report += `End of Report\n`;

            // Download report
            const blob = new Blob([report], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `validation-test-report-${currentFile.name}-${Date.now()}.txt`;
            a.click();
            URL.revokeObjectURL(url);

            showNotification('Test report downloaded successfully!', 'success');
        }

        /**
         * Extracts all unique field names used across all validations
         * Used for field name autocomplete suggestions
         * @returns {Array<string>} Array of unique field names
         */
        function getAllFieldNames() {
            const fieldNames = new Set();

            state.files.forEach(file => {
                file.validations.forEach(validation => {
                    const params = validation.params || {};

                    // Extract field names from various parameter types
                    if (params.field) fieldNames.add(params.field);
                    if (params.fields && Array.isArray(params.fields)) {
                        params.fields.forEach(f => fieldNames.add(f));
                    }
                    if (params.fields && Array.isArray(params.fields)) {
                        params.fields.forEach(f => fieldNames.add(f));
                    }
                    if (params.required_columns && Array.isArray(params.required_columns)) {
                        params.required_columns.forEach(f => fieldNames.add(f));
                    }
                    if (params.group_by_columns && Array.isArray(params.group_by_columns)) {
                        params.group_by_columns.forEach(f => fieldNames.add(f));
                    }
                });
            });

            // Add common field names as suggestions
            const commonFields = ['id', 'name', 'email', 'date', 'status', 'created_at', 'updated_at',
                                 'customer_id', 'order_id', 'amount', 'quantity', 'price', 'total'];
            commonFields.forEach(f => fieldNames.add(f));

            return Array.from(fieldNames).sort();
        }

        /**
         * Updates validation severity
         * @param {number} fileId - The file ID
         * @param {number} validationIdx - The validation index
         * @param {string} severity - New severity value
         */
        function updateValidationSeverity(fileId, validationIdx, severity) {
            const file = state.files.find(f => f.id === fileId);
            if (file && file.validations[validationIdx]) {
                // Save state for undo
                saveStateToUndoStack();

                file.validations[validationIdx].severity = severity;
                updateYAMLPreview();
                showNotification(`Severity updated to ${severity}`);
            }
        }

        /**
         * Updates a validation's note/comment for documentation
         * @param {number} fileId - The file ID
         * @param {number} validationIdx - The validation index
         * @param {string} note - The note text
         */
        function updateValidationNote(fileId, validationIdx, note) {
            const file = state.files.find(f => f.id === fileId);
            if (file && file.validations[validationIdx]) {
                // Save state for undo
                saveStateToUndoStack();

                file.validations[validationIdx].note = note.trim();
                updateYAMLPreview();
            }
        }

        /**
         * Updates a validation parameter
         * @param {number} fileId - The file ID
         * @param {number} validationIdx - The validation index
         * @param {string} paramName - Parameter name
         * @param {any} paramValue - Parameter value
         */
        function updateValidationParam(fileId, validationIdx, paramName, paramValue) {
            const file = state.files.find(f => f.id === fileId);
            if (file && file.validations[validationIdx]) {
                // Save state for undo
                saveStateToUndoStack();

                if (!file.validations[validationIdx].params) {
                    file.validations[validationIdx].params = {};
                }
                file.validations[validationIdx].params[paramName] = paramValue;
                updateYAMLPreview();
            }
        }

        function getValidationCategory(type) {
            if (type.includes('File')) return 'file-check';
            if (type.includes('Schema') || type.includes('Column')) return 'schema-check';
            if (type.includes('Field') || type.includes('Mandatory') || type.includes('Regex') || type.includes('Range') || type.includes('Date')) return 'field-check';
            if (type.includes('Duplicate') || type.includes('Blank') || type.includes('Unique')) return 'record-check';
            if (type.includes('Referential') || type.includes('CrossFile')) return 'cross-file-check';
            if (type.includes('Statistical') || type.includes('Outlier')) return 'statistical-check';
            return 'field-check';
        }

        function getValidationIcon(type) {
            const category = getValidationCategory(type);
            const icons = {
                'file-check': 'üì¶',
                'schema-check': 'üîç',
                'field-check': '‚úì',
                'record-check': 'üìä',
                'cross-file-check': 'üîó',
                'statistical-check': 'üìà'
            };
            return icons[category] || '‚úì';
        }

        /**
         * Filters validations based on search query
         * Searches in validation type, severity, parameters, and category
         * @param {Array} validations - Array of validation objects
         * @param {string} query - Search query string
         * @returns {Array} Array of {validation, originalIdx, highlight} objects
         */
        function filterValidationsBySearch(validations, query) {
            if (!query || query.trim() === '') {
                return validations.map((v, idx) => ({ validation: v, originalIdx: idx, highlight: false }));
            }

            const lowerQuery = query.toLowerCase().trim();
            const results = [];

            validations.forEach((validation, idx) => {
                // Search in validation type
                const typeMatch = validation.type.toLowerCase().includes(lowerQuery);

                // Search in severity
                const severityMatch = validation.severity.toLowerCase().includes(lowerQuery);

                // Search in parameters
                const paramsStr = JSON.stringify(validation.params || {}).toLowerCase();
                const paramsMatch = paramsStr.includes(lowerQuery);

                // Search in category
                const category = getValidationCategory(validation.type);
                const categoryMatch = category.toLowerCase().includes(lowerQuery);

                // Search in notes
                const noteMatch = validation.note && validation.note.toLowerCase().includes(lowerQuery);

                if (typeMatch || severityMatch || paramsMatch || categoryMatch || noteMatch) {
                    results.push({
                        validation: validation,
                        originalIdx: idx,
                        highlight: true
                    });
                }
            });

            return results;
        }

        /**
         * Updates the search query for a file and re-renders the content
         * @param {number} fileId - The file ID
         * @param {string} query - The search query
         */
        function filterValidations(fileId, query) {
            state.searchQuery[fileId] = query;
            renderContent(fileId);
        }

        /**
         * Clears the search query for a file
         * @param {number} fileId - The file ID
         */
        function clearSearch(fileId) {
            state.searchQuery[fileId] = '';
            renderContent(fileId);
        }

        /**
         * Gets comprehensive human-readable description for validation type
         * @param {string} type - Validation type
         * @returns {string} Description text with usage guidance
         */
        function getValidationDescription(type) {
            const descriptions = {
                // File Validations
                'EmptyFileCheck': '<strong>Prevents processing empty files.</strong> Validates that the file contains at least one data row. <em>How headers are detected:</em> For CSV files, if your file format config specifies <code>has_header: true</code>, the first row is treated as headers and excluded from the count. For files without headers (<code>has_header: false</code>), all rows count as data. Excel files use the sheet\'s first row as headers by default. The check fails if zero data rows remain after excluding headers. Use this as a first-line check to catch missing or corrupted file transfers‚Äîit fails immediately, saving processing time.',

                'RowCountRangeCheck': '<strong>Ensures data volume is as expected.</strong> Validates row count falls within specified min/max range. Useful for detecting incomplete data loads (too few rows) or unexpected duplicates (too many rows). Example: Daily sales file should have 1,000-5,000 rows.',

                'FileSizeCheck': '<strong>Catches oversized or undersized files early.</strong> Checks file size in bytes/KB/MB before processing. Prevents memory issues from unexpectedly large files. Example: Reject files over 500MB or under 1KB as likely corrupted.',

                // Schema Validations
                'SchemaMatchCheck': '<strong>Enforces exact schema compliance.</strong> Validates that all columns match expected names, order, and types exactly. Strictest schema check - fails if any column is missing, extra, renamed, or reordered. Use when schema changes are not tolerated.',

                'ColumnPresenceCheck': '<strong>Verifies required columns exist.</strong> Checks that specific critical columns are present, regardless of column order or extra columns. More flexible than SchemaMatchCheck. Example: Require "customer_id", "order_date", "amount" columns even if other columns vary.',

                // Field Validations
                'MandatoryFieldCheck': '<strong>Ensures critical fields are never empty.</strong> Validates that specified fields contain values (not null, not blank, not whitespace). Essential for business-critical fields. Example: Customer records must have "customer_id", "name", and "email" populated.',

                'RegexCheck': '<strong>Enforces specific field formats using patterns.</strong> Validates field values match a regular expression pattern. Perfect for formatted data like emails, phone numbers, postal codes, IDs. Example: Email must match pattern "^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\\.[a-zA-Z]{2,}$".',

                'ValidValuesCheck': '<strong>Restricts fields to predefined allowed values.</strong> Checks that field values are in an approved whitelist. Ideal for status codes, categories, enums. Example: "status" must be one of: "active", "inactive", "pending", "suspended".',

                'RangeCheck': '<strong>Validates numeric values stay within bounds.</strong> Ensures numbers fall between minimum and maximum values (inclusive). Catches data entry errors and outliers. Example: Age must be 0-120, discount_percent must be 0-100, temperature must be -50 to 50.',

                'DateFormatCheck': '<strong>Enforces consistent date formatting.</strong> Validates dates match a specific format string using strftime codes. Prevents date parsing errors. Example: "2024-01-15" matches "%Y-%m-%d", "15/01/2024" matches "%d/%m/%Y".',

                'StringLengthCheck': '<strong>Ensures text fields meet length requirements.</strong> Validates string length falls within min/max character limits. Prevents database truncation errors and catches input issues. Example: Username must be 3-20 characters, description must be 10-500 characters.',

                'CompletenessCheck': '<strong>Monitors field population rates.</strong> Validates that a minimum percentage of rows have non-null values in a field. Useful for data quality metrics. Example: "phone_number" must be populated in at least 95% of customer records.',

                // Record Validations
                'DuplicateRowCheck': '<strong>Detects duplicate records.</strong> Finds rows with identical values across all columns (or specified subset). Prevents duplicate data loads. Can check full rows or key columns only. Example: Find duplicate orders based on "order_id" and "order_date".',

                'BlankRecordCheck': '<strong>Identifies completely empty rows.</strong> Finds rows where all fields are null or empty. Common with CSV files that have trailing blank lines or data entry errors. Helps clean data before processing.',

                'UniqueKeyCheck': '<strong>Enforces primary key constraints.</strong> Validates that specified key field(s) contain unique values with no duplicates. Essential for ensuring data integrity. Example: "customer_id" must be unique, or combination of "order_id" + "line_number" must be unique.',

                // Cross-File Validations
                'ReferentialIntegrityCheck': '<strong>Validates foreign key relationships across files.</strong> Ensures all foreign key values in this file exist in the reference file\'s primary key. Prevents orphaned records. Example: All "customer_id" values in orders.csv must exist in customers.csv "id" column.',

                'CrossFileComparisonCheck': '<strong>Compares metrics between related files.</strong> Validates that aggregated values match across files (sums, counts, averages). Ensures data consistency. Example: Total order amount in orders.csv should equal sum of line items in order_details.csv.',

                'CrossFileDuplicateCheck': '<strong>Finds duplicate records across multiple files.</strong> Detects when the same record appears in multiple files based on key fields. Useful for identifying data duplication across systems. Example: Same customer record in both US and EU customer files.',

                // Statistical Validations
                'StatisticalOutlierCheck': '<strong>Identifies anomalous values using statistics.</strong> Detects values that fall outside expected statistical ranges (e.g., beyond 3 standard deviations from mean). Catches data quality issues and potential fraud. Example: Transaction amounts more than 3œÉ from average may be errors or fraud.',

                'DistributionCheck': '<strong>Validates data follows expected patterns.</strong> Checks that data distribution matches expected statistical distribution (normal, uniform, etc.). Useful for detecting biased or skewed data. Example: Test scores should follow normal distribution, random sampling should be uniform.',

                'CorrelationCheck': '<strong>Monitors relationships between fields.</strong> Validates that correlation between two columns meets expected values. Catches data inconsistencies. Example: "price" and "quantity" should have expected correlation; deviation indicates pricing errors or data quality issues.'
            };
            return descriptions[type] || 'Validates data quality according to specified rules.';
        }

        // File Management
        function addFile() {
            saveStateToUndoStack();
            const fileId = state.fileCounter++;
            state.files.push({
                id: fileId,
                name: `file_${fileId}`,
                path: 'data.csv',
                format: 'csv',
                validations: []
            });
            updateFilesNav();
            showSection(fileId);
            updateYAMLPreview();
        }

        function updateFile(fileId, field, value) {
            const file = state.files.find(f => f.id === fileId);
            if (file) {
                // Save state for undo
                saveStateToUndoStack();

                file[field] = value;
                updateFilesNav();
                updateYAMLPreview();
            }
        }

        /**
         * Removes a file configuration from the project
         * @param {number} fileId - The ID of the file to remove
         */
        function removeFile(fileId) {
            const fileIndex = state.files.findIndex(f => f.id === fileId);
            if (fileIndex === -1) return;

            const file = state.files[fileIndex];
            if (!confirm(`Delete file "${file.name}"? This will remove all its validations.`)) {
                return;
            }

            // Save state for undo
            saveStateToUndoStack();

            // Remove the file
            state.files.splice(fileIndex, 1);

            // If no files remain, add a default file
            if (state.files.length === 0) {
                const fileId = state.fileCounter++;
                state.files.push({
                    id: fileId,
                    name: `file_${fileId}`,
                    path: 'data.csv',
                    format: 'csv',
                    validations: []
                });
                showSection(fileId);
            } else {
                // Navigate to the first available file
                showSection(state.files[0].id);
            }

            updateFilesNav();
            updateYAMLPreview();
            showNotification('üóëÔ∏è File deleted successfully');
        }

        function updateFilesNav() {
            const nav = document.getElementById('filesNav');
            nav.innerHTML = state.files.map(file => `
                <div class="nav-item ${state.currentSection === file.id ? 'active' : ''}" onclick="showSection(${file.id})">
                    <span class="nav-icon">üìÑ</span>
                    <span class="nav-label">${file.name}</span>
                    ${file.validations.length > 0 ? `<span class="nav-badge">${file.validations.length}</span>` : ''}
                </div>
            `).join('');
            document.getElementById('filesCount').textContent = state.files.length;
        }

        /**
         * Opens the validation selection wizard for adding a new validation
         * @param {string} fileId - The ID of the file to add validation to
         */
        function addValidation(fileId) {
            // Open the modal wizard instead of directly adding a validation
            openValidationModal(fileId);
        }

        function removeValidation(fileId, idx) {
            const file = state.files.find(f => f.id === fileId);
            if (file && confirm('Remove this validation?')) {
                saveStateToUndoStack();
                file.validations.splice(idx, 1);
                renderContent(fileId);
                updateYAMLPreview();
                updateFilesNav();
            }
        }

        /**
         * Duplicates a validation and inserts it right after the original
         * @param {number} fileId - The file ID
         * @param {number} idx - The validation index to duplicate
         */
        function duplicateValidation(fileId, idx) {
            const file = state.files.find(f => f.id === fileId);
            if (!file || !file.validations[idx]) return;

            // Save state for undo
            saveStateToUndoStack();

            // Deep copy the validation to avoid reference issues
            const original = file.validations[idx];
            const duplicate = JSON.parse(JSON.stringify(original));

            // Insert the duplicate right after the original
            file.validations.splice(idx + 1, 0, duplicate);

            // Re-render and update
            renderContent(fileId);
            updateYAMLPreview();
            updateFilesNav();
            showNotification('üìã Validation duplicated');
        }

        /**
         * Moves a validation up in the order (decreases index)
         * @param {number} fileId - The file ID
         * @param {number} idx - The current validation index
         */
        function moveValidationUp(fileId, idx) {
            const file = state.files.find(f => f.id === fileId);
            if (file && idx > 0) {
                saveStateToUndoStack();
                // Swap with previous item
                [file.validations[idx - 1], file.validations[idx]] =
                    [file.validations[idx], file.validations[idx - 1]];

                // Re-render
                renderContent(fileId);
                updateYAMLPreview();
            }
        }

        /**
         * Moves a validation down in the order (increases index)
         * @param {number} fileId - The file ID
         * @param {number} idx - The current validation index
         */
        function moveValidationDown(fileId, idx) {
            const file = state.files.find(f => f.id === fileId);
            if (file && idx < file.validations.length - 1) {
                saveStateToUndoStack();
                // Swap with next item
                [file.validations[idx], file.validations[idx + 1]] =
                    [file.validations[idx + 1], file.validations[idx]];

                // Re-render
                renderContent(fileId);
                updateYAMLPreview();
            }
        }

        // YAML Generation
        function updateYAMLPreview() {
            const yaml = generateYAML();
            document.getElementById('yamlPreview').textContent = yaml;
            updateQuickStats(); // Update sidebar stats
        }

        function generateYAML() {
            // Generate Windows/Linux compatible YAML
            // - files nested under validation_job
            // - processing (not settings) nested under validation_job
            // - No blank lines within structures
            // - Comments inline only, not standalone
            let yaml = `validation_job:
  name: "${state.jobName}"
  files:
`;
            if (state.files.length === 0) {
                yaml += '    []\n';
            } else {
                state.files.forEach(file => {
                    yaml += `    - name: "${file.name}"
      path: "${file.path}"
      format: "${file.format}"
      validations:
`;
                    if (file.validations.length === 0) {
                        yaml += '        []\n';
                    } else {
                        file.validations.forEach(v => {
                            // Add note as inline comment if it exists
                            const noteComment = v.note && v.note.trim()
                                ? `  # ${v.note.trim().replace(/\n/g, ' ')}`
                                : '';

                            yaml += `        - type: "${v.type}"${noteComment}
          severity: "${v.severity}"
`;

                            // Add parameters if they exist
                            if (v.params && Object.keys(v.params).length > 0) {
                                yaml += '          params:\n';
                                Object.entries(v.params).forEach(([key, value]) => {
                                    if (Array.isArray(value)) {
                                        yaml += `            ${key}:\n`;
                                        value.forEach(item => {
                                            yaml += `              - "${item}"\n`;
                                        });
                                    } else if (typeof value === 'string') {
                                        yaml += `            ${key}: "${value}"\n`;
                                    } else {
                                        yaml += `            ${key}: ${value}\n`;
                                    }
                                });
                            } else {
                                yaml += '          params: {}\n';
                            }
                        });
                    }
                });
            }

            // Add processing configuration (nested under validation_job)
            yaml += `  processing:
    chunk_size: ${state.settings.chunk_size}
    max_sample_failures: ${state.settings.max_sample_failures}
    fail_fast: ${state.settings.fail_fast}
    log_level: ${state.settings.log_level}
`;
            return yaml;
        }

        // UI Controls
        function toggleSidebar() {
            document.getElementById('sidebar').classList.toggle('collapsed');
        }

        function toggleMobileSidebar() {
            const sidebar = document.getElementById('sidebar');
            const backdrop = document.getElementById('mobileBackdrop');
            sidebar.classList.toggle('mobile-visible');
            backdrop.classList.toggle('show');
        }

        function togglePreview() {
            document.getElementById('previewPanel').classList.toggle('collapsed');
        }

        function copyYAML() {
            const yaml = document.getElementById('yamlPreview').textContent;
            navigator.clipboard.writeText(yaml).then(() => {
                alert('YAML copied to clipboard!');
            });
        }

        function downloadConfig() {
            const yaml = generateYAML();
            const blob = new Blob([yaml], { type: 'text/yaml' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'validation_config.yaml';
            a.click();
            URL.revokeObjectURL(url);
        }

        function handleSearch(event) {
            // TODO: Implement search functionality
            console.log('Search:', event.target.value);
        }
    </script>
</body>
</html>
